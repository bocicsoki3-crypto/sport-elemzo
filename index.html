<!DOCTYPE html>
<html lang="hu" class="dark-theme">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemz≈ë AI - M≈±szerfal</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root {
    --bg-dark: #0D0D0D; --card-bg-dark: rgba(26, 26, 26, 0.65); --text-primary-dark: #F5F5DC; --text-secondary-dark: #ccc;
    --bg-light: #F0F2F5; --card-bg-light: rgba(255, 255, 255, 0.8); --text-primary-light: #1c1e21; --text-secondary-light: #606770;
    --border-color-dark: rgba(212, 175, 55, 0.2); --border-color-light: #dce1e4;
    --primary: #D4AF37; --secondary: #B8860B; --accent: #00BFFF; --danger: #FF4747; --success: #39FF14;
    --font-family-header: 'Poppins', system-ui, sans-serif; --font-family-body: 'Inter', system-ui, sans-serif;
}
.dark-theme { --bg: var(--bg-dark); --card-bg: var(--card-bg-dark); --text-primary: var(--text-primary-dark); --text-secondary: var(--text-secondary-dark); --border-color: var(--border-color-dark); }
.light-theme { --bg: var(--bg-light); --card-bg: var(--card-bg-light); --text-primary: var(--text-primary-light); --text-secondary: var(--text-secondary-light); --border-color: var(--border-color-light); }
*{box-sizing:border-box}
::selection{background-color:var(--primary);color:#000}
body{margin:0;font-family:var(--font-family-body);color:var(--text-primary);background-color:var(--bg);background-image:radial-gradient(circle at 1px 1px,rgba(212,175,55,0.1) 1px,transparent 0);background-size:20px 20px;min-height:100vh;overflow-x:hidden;transition: background-color 0.3s, color 0.3s;}
h1,h2,h3,h4,h5,h6{font-family:var(--font-family-header);color:var(--text-primary);margin-top:0}
p{line-height:1.7;color:var(--text-secondary)}
.app-header{background:var(--card-bg);backdrop-filter:blur(10px);color:var(--primary);padding:1rem 2rem;text-align:center;border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.app-header h1{font-weight:600;margin:0;font-size:1.5rem}
.header-status{font-size:.9rem;opacity:.8;display:flex;align-items:center;gap:1.5rem}
.bankroll-display span{font-weight:700;color:var(--text-primary)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:2rem;padding:2rem;max-width:1920px;margin:0 auto;align-items:start}
@media (max-width:1024px){.layout{grid-template-columns:1fr}}
.sidebar{position:sticky;top:100px}
.card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:16px;padding:1.5rem;box-shadow:0 8px 32px rgba(0,0,0,0.3);backdrop-filter:blur(10px);transition:all .3s ease}
label{display:block;font-weight:500;margin-bottom:.5rem;font-size:.9rem;color:var(--text-secondary)}
input,select{width:100%;padding:10px 14px;border:1px solid var(--border-color);border-radius:10px;background:rgba(0,0,0,0.3);color:var(--text-primary);margin-top:.25rem;font-size:.9rem;font-family:inherit;transition:all .2s ease}
.light-theme input, .light-theme select { background: rgba(255,255,255,0.5); }
input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(212,175,55,.3)}
.btn{display:inline-block;padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all .2s ease;font-family:var(--font-family-header);text-align:center;text-decoration:none;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#000}
.btn-primary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 20px rgba(212,175,55,.25)}
.btn:disabled{background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
#main-content .placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;border:2px dashed var(--border-color);border-radius:16px;color:var(--muted);padding:2rem;text-align:center}
#main-content .placeholder svg{width:64px;height:64px;margin-bottom:1rem;stroke-width:1.5;opacity:.5}
.tab-nav{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border-color)}
.tab-btn{padding:10px 15px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:700;position:relative;transition:color .2s ease;font-family:inherit}
.tab-btn.active{color:var(--primary)}
.tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--primary);box-shadow:0 0 10px var(--primary)}
.tab-content{display:none}
.tab-content.active{display:block;animation:fadeIn .5s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background-color .2s ease;position:relative}
.list-item:hover{background-color:rgba(212,175,55,.1)}
.list-item-title{font-weight:700}.list-item-meta{font-size:.8rem;color:var(--muted)}
.list-group-header{font-weight:800;font-size:1.1rem;color:var(--secondary);padding:15px 0 10px 0;border-bottom:1px solid var(--border-color);margin-top:1rem; list-style: none; display: flex; align-items: center; cursor: pointer;}
.list-group-header::-webkit-details-marker { display: none; }
.list-group-header::before { content: '‚ñ∂'; margin-right: 10px; font-size: 0.8em; transition: transform 0.2s; }
details[open] > .list-group-header::before { transform: rotate(90deg); }
.action-icon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;transition:background-color .2s ease;background:rgba(255,255,255,0.05)}
.action-icon:hover{background-color:rgba(255,255,255,0.1)}
.action-icon svg{width:18px;height:18px;stroke:var(--muted)}
.action-icon.delete:hover svg{stroke:var(--danger)}
.sport-filter-container{display:flex;gap:8px;margin-bottom:.8rem}
.sport-filter-btn{background-color:rgba(0,0,0,0.3);border:1px solid var(--border-color);color:var(--muted);padding:8px 15px;border-radius:10px;cursor:pointer;transition:all .2s ease;flex:1}
.light-theme .sport-filter-btn { background: rgba(255,255,255,0.5); }
.sport-filter-btn:hover{border-color:var(--secondary);color:var(--text-primary)}
.sport-filter-btn.active{background-color:var(--primary);color:#000;border-color:var(--primary);font-weight:700}
.card > details > summary {font-family: var(--font-family-header);font-size: 1.25rem;font-weight: 600;list-style: none;display: flex;align-items: center;cursor: pointer;}
.card > details > summary::-webkit-details-marker {display: none;}
.card > details > summary::before {content: '‚ñ∂';margin-right: 10px;font-size: 0.8em;transition: transform 0.2s;}
.card > details[open] > summary::before {transform: rotate(90deg);}
.progress-bar{width:100%;height:4px;background:var(--border-color);border-radius:2px;margin-top:1rem;overflow:hidden;display:none}
.progress-bar-inner{width:0;height:100%;background:var(--primary);transition:width .5s ease}
.status-text{text-align:center;margin-top:.5rem}
#loading-skeleton{display:none}
#loading-skeleton .skeleton-card{background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:16px;margin-bottom:1.5rem}
#loading-skeleton .skeleton-line{background:rgba(255,255,255,0.1);border-radius:4px;margin-bottom:10px;animation:pulse-bg 1.5s infinite}
@keyframes pulse-bg{0%{background:rgba(255,255,255,0.1)}50%{background:rgba(255,255,255,0.05)}100%{background:rgba(255,255,255,0.1)}}

.analysis-body p { font-size: 1.05rem; line-height: 1.8; color: var(--text-secondary); }
.analysis-body strong { color: var(--text-primary); font-weight: 600; }
.at-a-glance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
.summary-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; }
.summary-card h5 { margin: 0 0 1rem 0; color: var(--muted); font-size: 0.9rem; font-weight: 500; text-transform: uppercase; }
.summary-card .value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
.summary-card .details { font-size: 0.8rem; margin-top: 0.5rem; }
.donut-chart { position: relative; width: 100px; height: 100px; border-radius: 50%; margin: 0 auto; background: conic-gradient( var(--primary) 0 var(--p-home), var(--muted) 0 var(--p-draw), var(--secondary) 0 100% ); }
.donut-chart::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 70px; height: 70px; background: var(--card-bg); border-radius: 50%; transition: background-color 0.3s;}
.donut-legend { display: flex; justify-content: center; gap: 1rem; margin-top: 1rem; font-size: 0.8rem; }
.donut-legend span::before { content: ''; display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
.legend-home::before { background: var(--primary); }
.legend-draw::before { background: var(--muted); }
.legend-away::before { background: var(--secondary); }
.tug-of-war-bar { display: flex; flex-direction: column; justify-content: center; height: 100%; }
.tug-of-war-bar .labels { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; }
.tug-of-war-bar .bar-container { height: 10px; width: 100%; background: var(--danger); border-radius: 5px; overflow: hidden; }
.tug-of-war-bar .bar { height: 100%; background: var(--success); }
.analysis-accordion details { border-bottom: 1px solid var(--border-color); }
.analysis-accordion summary { font-size: 1.2rem; font-weight: 600; padding: 1.5rem 1rem; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; }
.analysis-accordion summary::-webkit-details-marker { display: none; }
.analysis-accordion summary .section-title { display: flex; align-items: center; gap: 0.75rem; }
.analysis-accordion summary .section-icon { stroke: var(--primary); }
.analysis-accordion summary::after { content: '+'; font-size: 1.5rem; color: var(--muted); transition: transform 0.3s ease; }
.analysis-accordion details[open] summary::after { transform: rotate(45deg); }
.analysis-accordion .accordion-content { padding: 0 1rem 1.5rem 1rem; animation: fadeIn .5s; }
.xg-value, .confidence-score { text-shadow: 0 0 10px currentColor; }
.market-data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
.market-data-section h4 { font-size: 1.1rem; color: var(--secondary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
.prob-item{margin-bottom:.8rem} .prob-label{display:flex;justify-content:space-between;font-weight:500;font-size: .9rem;margin-bottom:4px} .prob-bar-bg{width:100%;background:rgba(0,0,0,0.1);border-radius:5px;height:8px;overflow:hidden} .prob-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--primary));border-radius:5px}
#theme-switcher { cursor: pointer; stroke: var(--muted); } #theme-switcher:hover { stroke: var(--primary); }
.value-bets-section h4 { color: var(--success); }
.value-bet-item { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
.value-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem 1rem; margin: 0.5rem 0; }
.value-highlight { color: var(--success); font-weight: 800; }
.btn-log-bet { font-size: .9rem; padding: 8px 12px; margin-top: .5rem; background: linear-gradient(135deg,var(--success),#1e7e34); color: white; width: 100%;}
.performance-center .kpi-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.performance-center .kpi-card { background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 12px; text-align: center; }
.performance-center .kpi-card h5 { margin: 0 0 0.5rem 0; font-size: 0.8rem; color: var(--muted); text-transform: uppercase; font-weight: 500;}
.performance-center .kpi-card .value { font-size: 1.4rem; font-weight: 700; }
.performance-center .pnl-value.positive { color: var(--success); }
.performance-center .pnl-value.negative { color: var(--danger); }
.performance-center .view-switcher { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
.performance-center .view-btn { background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 8px; cursor: pointer; color: var(--muted); font-size: 0.8rem;}
.performance-center .view-btn.active { background: var(--primary); color: #000; font-weight: 700; }
.performance-center .chart-view { display: none; }
.performance-center .chart-view.active { display: block; }
.performance-center .bar-chart-item { display: flex; align-items: center; margin-bottom: 0.5rem; font-size: 0.9rem; }
.performance-center .bar-label { width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.performance-center .bar-bg { flex-grow: 1; height: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; }
.performance-center .bar-fill { height: 100%; border-radius: 6px; }
.performance-center .bar-fill.positive { background: var(--success); }
.performance-center .bar-fill.negative { background: var(--danger); margin-left: auto; }
.performance-center .bar-value { width: 60px; text-align: right; font-weight: 700; }
.light-theme .performance-center .kpi-card { background: rgba(0,0,0,0.05); }
.light-theme .performance-center .view-btn { background: rgba(0,0,0,0.05); }
.bet-item { padding: 10px; border-bottom: 1px solid var(--border-color); }
.bet-item:last-child { border-bottom: none; }
.bet-details { font-size: 0.9rem; }
.bet-meta { font-size: 0.8rem; color: var(--muted); }
.bet-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
.bet-actions button { font-size: 0.8rem; padding: 4px 8px; width: auto; border-radius: 8px; }
.bet-status { font-weight: 700; padding: 2px 6px; border-radius: 6px; font-size: 0.8rem; }
.bet-status-Won { background-color: var(--success); color: #000; }
.bet-status-Lost { background-color: var(--danger); color: #fff; }
.bet-status-Void { background-color: var(--muted); color: #000; }
.bet-status-Pending { background-color: var(--accent); color: #000; }
</style>
</head>
<body>

<header class="app-header">
    <h1>SportElemz≈ë M≈±szerfal</h1>
    <div class="header-status">
        <div id="bankrollDisplay" class="bankroll-display">
            Bankroll: <span id="bankrollValue">...</span>
        </div>
        <svg id="theme-switcher" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
        <div id="userInfo" class="user-info"></div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="card">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tab-matches">M√©rk≈ëz√©sek</button>
                <button class="tab-btn" data-tab="tab-manual">K√©zi Elemz√©s</button>
                <button class="tab-btn" data-tab="tab-bets">Fogad√°sok</button>
            </nav>

            <div id="tab-matches" class="tab-content active">
                <label for="sportSelector">Sport√°g</label>
                <select id="sportSelector" onchange="handleSportChange()">
                    <option value="soccer" selected>Labdar√∫g√°s</option>
                    <option value="hockey">J√©gkorong</option>
                    <option value="basketball">Kos√°rlabda</option>
                </select>
                <button id="loadFixturesBtn" class="btn btn-primary" onclick="loadFixtures()" style="width:100%; margin-top:1rem;">Meccsek Bet√∂lt√©se (2 nap)</button>
                <div id="fixtures-list" style="margin-top:1rem; max-height: 50vh; overflow-y:auto;"></div>
            </div>

            <div id="tab-manual" class="tab-content">
                <label for="home">Hazai csapat</label><input id="home" placeholder="Pl. Liverpool"/>
                <label for="away" style="margin-top:1rem;">Vend√©g csapat</label><input id="away" placeholder="Pl. Manchester City"/>
                <button class="btn btn-primary" onclick="runAnalysis(true)" style="width:100%; margin-top:1.5rem;">Elemz√©s Futtat√°sa</button>
            </div>

            <div id="tab-bets" class="tab-content">
                <div id="bets-list">
                    <p class="muted">Itt fognak megjelenni a r√∂gz√≠tett fogad√°said.</p>
                </div>
            </div>
        </div>

        <div class="card" id="performance-center-card">
             <details>
                <summary>Teljes√≠tm√©ny K√∂zpont</summary>
                <div style="margin-top: 1rem;" id="performance-center-content">
                    <p class="muted">Az adatok megjelen√≠t√©s√©hez r√∂gz√≠ts vagy √©rt√©kelj ki fogad√°sokat.</p>
                </div>
            </details>
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <div id="placeholder" class="placeholder">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20v-10M18 20V4"/></svg>
            <h3>V√°lassz egy m√©rk≈ëz√©st a list√°b√≥l, vagy futtass k√©zi elemz√©st.</h3>
            <p>Az elemz√©s eredm√©nye itt fog megjelenni.</p>
        </div>
        <div id="loading-skeleton">
            <div class="skeleton-card"><div class="skeleton-line" style="height: 2rem; width: 60%;"></div><div class="skeleton-line" style="height: 1rem; width: 100%;"></div><div class="skeleton-line" style="height: 1rem; width: 100%;"></div><div class="skeleton-line" style="height: 1rem; width: 80%;"></div></div>
            <div class="skeleton-card"><div class="skeleton-line" style="height: 1.5rem; width: 40%;"></div><div class="skeleton-line" style="height: 1rem; width: 90%;"></div><div class="skeleton-line" style="height: 1rem; width: 70%;"></div></div>
        </div>
        <div id="analysis-results"></div>
        <div id="progress-container" style="display:none;">
            <div class="progress-bar"><div id="progress-bar-inner" class="progress-bar-inner"></div></div>
            <p id="status" class="status-text muted"></p>
        </div>
    </main>
</div>


<script>
let __gasUrl = 'https://script.google.com/macros/s/AKfycbzezgLIW-VE1ZCaRUU7nQ6lebTEH6VpUrjW-rpnJXUnXnkdlM9B3suv6dw-RZTTyfGiCg/exec';
let __fixtures = [];
let __currentSport = 'soccer';
let __bets = [];
let __bankroll = 1000;
let __initialBankroll = 1000;

function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

document.addEventListener('DOMContentLoaded', () => {
    // Tab vez√©rl√©s
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            tabContents.forEach(content => {
                content.style.display = content.id === tabId ? 'block' : 'none';
                content.classList.toggle('active', content.id === tabId);
            });
            if (tabId === 'tab-bets') renderBets();
        });
    });

    // T√©ma v√°lt√≥
    const themeSwitcher = document.getElementById('theme-switcher');
    const currentTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.className = `${currentTheme}-theme`;
    themeSwitcher.addEventListener('click', () => {
        let newTheme = document.documentElement.className === 'dark-theme' ? 'light' : 'dark';
        document.documentElement.className = `${newTheme}-theme`;
        localStorage.setItem('theme', newTheme);
    });
    
    // Alap inicializ√°l√°s
    if(!__gasUrl||!__gasUrl.startsWith('https://script.google.com')){
        document.getElementById('userInfo').textContent='HIBA: Web App URL nincs be√°ll√≠tva!';
        document.getElementById('userInfo').style.color = 'var(--danger)';
    } else {
        document.getElementById('userInfo').textContent=`Csatlakozva`;
    }
    
    // Bankroll √©s fogad√°sok bet√∂lt√©se
    loadDataFromStorage();
});

// --- √öJ: Adatkezel√©s (localStorage) ---

function loadDataFromStorage() {
    __bets = JSON.parse(localStorage.getItem('sportBets')) || [];
    __bankroll = parseFloat(localStorage.getItem('sportBankroll')) || 1000;
    __initialBankroll = parseFloat(localStorage.getItem('sportInitialBankroll')) || 1000;
    updatePerformanceCenter();
}

function saveDataToStorage() {
    localStorage.setItem('sportBets', JSON.stringify(__bets));
    localStorage.setItem('sportBankroll', __bankroll);
    localStorage.setItem('sportInitialBankroll', __initialBankroll);
}

// --- √öJ: Teljes√≠tm√©ny K√∂zpont (Kliensoldali) ---

function updatePerformanceCenter() {
    const contentEl = document.getElementById('performance-center-content');
    const bankrollValueEl = document.getElementById('bankrollValue');
    bankrollValueEl.textContent = `${__bankroll.toFixed(2)} e.`;

    const settledBets = __bets.filter(b => b.status === "Won" || b.status === "Lost");
    const totalPnl = settledBets.reduce((acc, b) => acc + (b.pnl || 0), 0);
    const totalStake = __bets.reduce((acc, b) => acc + b.stakeInUnits, 0);
    const wonBets = settledBets.filter(b => b.status === "Won").length;
    const winRate = settledBets.length > 0 ? (wonBets / settledBets.length) * 100 : 0;
    const roi = totalStake > 0 ? (totalPnl / totalStake) * 100 : 0;
    const avgOdds = __bets.length > 0 ? __bets.reduce((acc, b) => acc + b.odd, 0) / __bets.length : 0;

    const bySport = {};
    const byStrategy = {};
    settledBets.forEach(bet => {
        bySport[bet.sport] = (bySport[bet.sport] || 0) + bet.pnl;
        let strategy = "Egy√©b";
        if (bet.market.toLowerCase().includes("over") || bet.market.toLowerCase().includes("under")) strategy = "Totals";
        else if (bet.market.toLowerCase().includes("hazai") || bet.market.toLowerCase().includes("vend√©g") || bet.market.toLowerCase().includes("d√∂ntetlen")) strategy = "1X2";
        byStrategy[strategy] = (byStrategy[strategy] || 0) + bet.pnl;
    });

    let html = `
        <div class="kpi-grid">
            <div class="kpi-card"><h5>Profit/Vesztes√©g</h5><div class="value pnl-value ${totalPnl >= 0 ? 'positive' : 'negative'}">${totalPnl >= 0 ? '+' : ''}${totalPnl.toFixed(2)} e.</div></div>
            <div class="kpi-card"><h5>ROI</h5><div class="value">${roi.toFixed(1)}%</div></div>
            <div class="kpi-card"><h5>Tal√°lati Ar√°ny</h5><div class="value">${winRate.toFixed(1)}%</div></div>
            <div class="kpi-card"><h5>√ñsszes Fogad√°s</h5><div class="value">${__bets.length}</div></div>
        </div>
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchPcView('sport')">Sport√°gak</button>
            <button class="view-btn" onclick="switchPcView('strategy')">Strat√©gi√°k</button>
        </div>
        <div id="pc-view-sport" class="chart-view active"></div>
        <div id="pc-view-strategy" class="chart-view"></div>
    `;
    contentEl.innerHTML = html;

    renderBarChart('pc-view-sport', bySport);
    renderBarChart('pc-view-strategy', byStrategy);
}

function renderBarChart(containerId, data) {
    const container = document.getElementById(containerId);
    let chartHtml = '';
    const values = Object.values(data);
    if(values.length === 0) {
        container.innerHTML = '<p class="muted" style="text-align:center;">Nincs megjelen√≠thet≈ë adat.</p>';
        return;
    }
    const maxVal = Math.max(...values.map(Math.abs));

    for(const key in data) {
        const value = data[key];
        const width = maxVal > 0 ? (Math.abs(value) / maxVal) * 100 : 0;
        const isPositive = value >= 0;
        
        chartHtml += `
            <div class="bar-chart-item">
                <div class="bar-label" title="${key}">${key}</div>
                <div class="bar-bg">
                    <div class="bar-fill ${isPositive ? 'positive' : 'negative'}" style="width: ${width}%;"></div>
                </div>
                <div class="bar-value" style="color: ${isPositive ? 'var(--success)' : 'var(--danger)'};">${value.toFixed(2)}</div>
            </div>
        `;
    }
    container.innerHTML = chartHtml;
}

function switchPcView(view) {
    document.querySelectorAll('.chart-view').forEach(el => el.classList.remove('active'));
    document.getElementById(`pc-view-${view}`).classList.add('active');
    document.querySelectorAll('.view-btn').forEach(el => el.classList.remove('active'));
    document.querySelector(`.view-btn[onclick="switchPcView('${view}')"]`).classList.add('active');
}

// --- √öJ: Fogad√°s Kezel√©s (Kliensoldali) ---

document.addEventListener('click', function(event) {
    if (event.target.matches('.btn-log-bet')) {
        const betData = JSON.parse(event.target.getAttribute('data-bet'));
        logBet(betData, event.target);
    }
});

function logBet(betData, button) {
    const stakeInUnits = __bankroll * (betData.stake / 100);
    if (stakeInUnits > __bankroll) {
        alert("Nincs elegend≈ë fedezet a fogad√°shoz!");
        return;
    }

    const newBet = {
        id: `bet_${new Date().getTime()}`,
        date: new Date().toISOString(),
        sport: betData.sport,
        match: `${betData.home} vs ${betData.away}`,
        market: betData.market,
        odd: betData.odd,
        stakeInUnits: stakeInUnits,
        status: 'Pending', // Pending, Won, Lost, Void
        pnl: 0
    };

    __bets.unshift(newBet);
    __bankroll -= stakeInUnits;
    saveDataToStorage();
    
    button.textContent = 'R√∂gz√≠tve ‚úÖ';
    button.disabled = true;

    updatePerformanceCenter();
    if (document.querySelector('.tab-btn[data-tab="tab-bets"]').classList.contains('active')) {
        renderBets();
    }
}

function renderBets() {
    const listEl = document.getElementById('bets-list');
    if (__bets.length === 0) {
        listEl.innerHTML = '<p class="muted">M√©g nincsenek r√∂gz√≠tett fogad√°sok.</p>';
        return;
    }

    let html = '';
    __bets.forEach(bet => {
        html += `
            <div class="bet-item">
                <div class="bet-details">
                    <strong>${bet.market}</strong> on ${bet.match}
                    <div class="bet-meta">
                        T√©t: ${bet.stakeInUnits.toFixed(2)} e. @${bet.odd.toFixed(2)} | <span class="bet-status bet-status-${bet.status}">${bet.status}</span>
                    </div>
                </div>
                ${bet.status === 'Pending' ? `
                <div class="bet-actions">
                    <button class="btn btn-primary" style="background:var(--success)" onclick="settleBet('${bet.id}', 'Won')">Nyert</button>
                    <button class="btn btn-primary" style="background:var(--danger)" onclick="settleBet('${bet.id}', 'Lost')">Vesztett</button>
                    <button class="btn btn-primary" style="background:var(--muted)" onclick="settleBet('${bet.id}', 'Void')">Void</button>
                </div>
                ` : `<div class="pnl-value ${bet.pnl >= 0 ? 'positive' : 'negative'}">${bet.pnl >= 0 ? '+' : ''}${bet.pnl.toFixed(2)} e.</div>`}
            </div>
        `;
    });
    listEl.innerHTML = html;
}

function settleBet(betId, result) {
    const betIndex = __bets.findIndex(b => b.id === betId);
    if (betIndex === -1) return;

    const bet = __bets[betIndex];
    if (bet.status !== 'Pending') return;

    let pnl = 0;
    if (result === 'Won') {
        pnl = (bet.stakeInUnits * bet.odd) - bet.stakeInUnits;
        __bankroll += bet.stakeInUnits + pnl;
        bet.status = 'Won';
    } else if (result === 'Lost') {
        pnl = -bet.stakeInUnits;
        bet.status = 'Lost';
    } else if (result === 'Void') {
        pnl = 0;
        __bankroll += bet.stakeInUnits;
        bet.status = 'Void';
    }

    bet.pnl = pnl;
    __bets[betIndex] = bet;
    
    saveDataToStorage();
    renderBets();
    updatePerformanceCenter();
}

// --- Elemz≈ë Motor √©s Fel√ºlet Logika (M√≥dos√≠t√°sokkal) ---

function handleSportChange(){
    __currentSport=document.getElementById('sportSelector').value;
    document.getElementById('fixtures-list').innerHTML = '';
    __fixtures = [];
}

async function loadFixtures(){
    const listEl = document.getElementById('fixtures-list');
    const loadBtn = document.getElementById('loadFixturesBtn');
    listEl.innerHTML = '<p class="muted" style="text-align:center;">Adatok lek√©r√©se...</p>';
    loadBtn.disabled = true;
    try {
        const response = await fetch(`${__gasUrl}?action=getFixtures&sport=${__currentSport}&days=2`);
        if (!response.ok) throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        __fixtures = data.fixtures || [];
        sessionStorage.setItem('openingOdds', JSON.stringify(data.odds || {}));

        const groupedByLeague = __fixtures.reduce((acc, fx) => {
            (acc[fx.league] = acc[fx.league] || []).push(fx);
            return acc;
        }, {});

        let html = '';
        for (const league in groupedByLeague) {
            html += `<details open>`;
            html += `<summary class="list-group-header">${league}</summary>`;
            groupedByLeague[league].forEach(fx => {
                const d = new Date(fx.utcKickoff).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' });
                html += `
                    <div class="list-item" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">
                        <div>
                            <div class="list-item-title">${escapeHtml(fx.home)} ‚Äì ${escapeHtml(fx.away)}</div>
                            <div class="list-item-meta">${d}</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px; color: var(--muted);"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                `;
            });
            html += `</details>`;
        }
        listEl.innerHTML = html || '<p class="muted" style="text-align:center;">Nincs megjelen√≠thet≈ë m√©rk≈ëz√©s.</p>';

    } catch (e) {
        listEl.innerHTML = `<p class="muted" style="color:var(--danger);">${e.message}</p>`;
    } finally {
        loadBtn.disabled = false;
    }
}

function fillAndAnalyze(home, away) {
    document.getElementById('home').value = home;
    document.getElementById('away').value = away;
    runAnalysis(true);
}

async function runAnalysis(forceNew = false) {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const resultsEl = document.getElementById('analysis-results');
    const placeholderEl = document.getElementById('placeholder');
    const skeletonEl = document.getElementById('loading-skeleton');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar-inner');
    const statusEl = document.getElementById('status');
    
    resultsEl.innerHTML = '';
    placeholderEl.style.display = 'none';
    skeletonEl.style.display = 'block';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    statusEl.textContent = '';

    if (!home || !away) {
        resultsEl.innerHTML = `<p style="color:var(--danger); text-align:center;">Hiba: Mindk√©t csapat nev√©t meg kell adni.</p>`;
        skeletonEl.style.display = 'none';
        progressContainer.style.display = 'none';
        placeholderEl.style.display = 'flex';
        return;
    }
    
    let progress = 0;
    const updateProgress = (val, text) => {
        progress = Math.max(progress, val);
        progressBar.style.width = `${progress}%`;
        statusEl.textContent = text;
    };

    try {
        updateProgress(5, "Elemz√©s ind√≠t√°sa...");
        let analysisUrl = `${__gasUrl}?action=runAnalysis&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}&force=${forceNew}`;
        const openingOdds = sessionStorage.getItem('openingOdds') || '{}';
        
        fetch(analysisUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ openingOdds: JSON.parse(openingOdds) }) });
        updateProgress(10, "Adatok lek√©r√©se a szerverr≈ël...");

        const interval = setInterval(() => {
            if (progress < 85) updateProgress(progress + Math.random() * 5, "AI elemz√©s √©s szimul√°ci√≥ futtat√°sa...");
        }, 800);

        await new Promise(resolve => setTimeout(resolve, 9000));
        clearInterval(interval);
        updateProgress(90, "V√°lasz feldolgoz√°sa...");
        
        const resultResponse = await fetch(`${analysisUrl}&force=false`);
        if (!resultResponse.ok) throw new Error(`Szerver v√°lasz hiba: ${resultResponse.status}`);
        
        const data = await resultResponse.json();
        if (data.error) throw new Error(data.error);

        updateProgress(100, "K√©sz.");
        resultsEl.innerHTML = `<div class="analysis-body">${data.html}</div>`;
        
    } catch (e) {
        resultsEl.innerHTML = `<p style="color:var(--danger); text-align:center;">Hiba: ${e.message}</p>`;
    } finally {
        skeletonEl.style.display = 'none';
        setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
    }
}
</script>
</body>
</html>
