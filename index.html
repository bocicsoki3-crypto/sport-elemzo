<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemz≈ë Gemini AI</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#000000;--card:#1a1a1a;--border:#38301d;--muted:#aaa;--primary:#D4AF37;--secondary:#B8860B;--accent:#FFD700;--text:#f5f5dc;--danger:#d9534f;--font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family);color:var(--text);background-color:#000;background-image:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2338301d' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");min-height:100vh}
.app-header{background:linear-gradient(90deg,#1a1a1a,#000000);color:var(--primary);padding:1.1rem;text-align:center;border-bottom:1px solid var(--border)}
.app-header h1{font-weight:800;margin:0}
.user-info{font-size:.9rem;margin-top:5px;opacity:.8}
.container{max-width:1800px;margin:1.8rem auto;padding:0 2rem}
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr 340px;align-items:start}
@media (max-width:1280px){.layout{grid-template-columns:340px 1fr}.col-right{grid-column:1/-1}}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.1rem;margin-bottom:1rem;box-shadow:0 20px 40px rgba(0,0,0,.35)}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700;margin-top:0;color:var(--text)}
label{display:block;font-weight:600;margin-top:.6rem}
input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c0c0c;color:var(--text);margin-top:.25rem;font-size:14px;font-family:inherit}
input[type="range"]{-webkit-appearance:none;width:100%;height:8px;background:linear-gradient(to right,var(--primary),var(--secondary));border-radius:10px;outline:none;opacity:.9;transition:opacity .2s;box-shadow:inset 0 1px 3px rgba(0,0,0,.3)}
input[type="range"]:hover{opacity:1}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:#fff;border-radius:50%;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.4);margin-top:-6px;border:2px solid var(--primary)}
input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(184,134,11,.25)}
.actions{margin-top:1.5rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.btn-primary,.btn-danger{padding:12px 18px;border:none;border-radius:14px;color:#000;font-weight:800;cursor:pointer;white-space:nowrap;width:100%;transition:transform .2s ease;font-family:var(--font-family);text-align:center}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary))}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b32b27)}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(212,175,55,.2)}
.btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(217,83,79,.2)}
.btn-primary:disabled,.btn-danger:disabled{background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(212,175,55,.7)}70%{box-shadow:0 0 0 10px rgba(212,175,55,0)}100%{box-shadow:0 0 0 0 rgba(212,175,55,0)}}
.progress-ring{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;margin:1rem auto;transition:opacity .5s}
.progress-label{font-size:1.5rem;font-weight:700}
details > summary{cursor:pointer;list-style:none;font-weight:800;font-size:1.2rem;color:var(--secondary);margin-bottom:.5rem;padding: 5px 0;}
details > summary::-webkit-details-marker{display:none}
details[open] > summary::before{transform:rotate(90deg)}
summary::before{content:'>';display:inline-block;margin-right:8px;transition:transform .2s}
.league-selector{list-style:none;padding:0;margin:0}
.league-item{display:flex;align-items:center;padding:12px 10px;cursor:pointer;font-weight:600;transition:background-color .2s;border-bottom:1px solid var(--border)}
.league-item:last-child{border-bottom:none}
.league-item::before{content:"üèÜ";margin-right:10px;opacity:.5;transition:opacity .2s}
.league-item:hover{background-color:rgba(255,255,255,.05)}
.league-item.active{color:var(--accent);background-color:rgba(212,175,55,.1)}
.league-item.active::before{opacity:1}
.fx-item{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--border);gap:8px}
.fx-title{font-weight:600}
.fx-meta{font-size:.8rem;color:var(--muted)}
.btn-sm{padding:8px 12px;font-size:.9rem;width:auto}
#out{min-height:20px}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal-content{background:var(--card);border:1px solid var(--primary);border-radius:16px;width:95%;max-width:1200px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.modal-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:1}
.modal-title{font-size:1.5rem;font-weight:800;color:var(--primary);margin:0}
.close-button{background:none;border:none;color:var(--muted);font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:1.5rem}
.analysis-section{margin-bottom:1.5rem}
.analysis-section h4{color:var(--secondary);margin:0 0 .8rem 0;font-size:1.2rem;border-bottom:1px solid var(--border);padding-bottom:.5rem}
.analysis-section p{margin:.5rem 0 1rem 0;line-height:1.7}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1rem}
@media (max-width:900px){.modal-grid{grid-template-columns:1fr}}
.market-group{background:rgba(0,0,0,0.2);border-radius:12px;padding:1rem;border:1px solid var(--border)}
.market-group h5{margin:0 0 1rem 0;font-size:1.1rem;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:.5rem}
.market-subtitle{color:var(--accent);font-weight:bold;display:block;margin-top:1.2rem;margin-bottom:0.8rem;font-size:1.05em}
.prob-item{margin-bottom:.8rem}
.prob-label{display:flex;justify-content:space-between;font-weight:600;margin-bottom:4px}
.prob-bar-bg{width:100%;background:rgba(0,0,0,.3);border-radius:5px;height:10px;overflow:hidden}
.prob-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:5px}
.best-bet-card{background:linear-gradient(135deg,rgba(212,175,55,.05),rgba(184,134,11,.05));border:1px solid var(--primary);border-radius:12px;padding:1rem;margin-top:1.5rem}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 200px}
.xg-comparison{padding:1rem;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid var(--border);margin:1rem 0}
.xg-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.xg-label{flex-basis:120px;font-weight:600}
.xg-bar-container{flex-grow:1;height:20px;background:rgba(0,0,0,0.3);border-radius:8px;overflow:hidden}
.xg-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:8px}
.xg-value{font-weight:700;font-size:1.2rem}
</style>
</head>
<body>
<header class="app-header"><h1>SportElemz≈ë Gemini AI</h1><div id="userInfo" class="user-info"></div></header>
<div class="container layout">
    <div class="col-left">
        <div class="card">
            <h2>Be√°ll√≠t√°sok</h2>
            <label for="sportSelector">Sport√°g</label>
            <select id="sportSelector" onchange="handleSportChange()">
                <option value="soccer" selected>Labdar√∫g√°s</option>
                <option value="hockey">J√©gkorong</option>
                <option value="basketball">Kos√°rlabda</option>
            </select>
            <div class="actions" style="margin-top: 1rem;">
                <button class="btn-primary" onclick="loadFixtures()">Meccsek Bet√∂lt√©se (2 nap)</button>
            </div>
            <span id="fxStatus" class="muted"></span>
        </div>
        <div class="card">
             <details><summary>Bajnoks√°gok</summary><ul id="leagueList" class="league-selector"><li class="muted">T√∂ltsd be a meccseket.</li></ul></details>
             <details><summary>M√©rk≈ëz√©sek</summary><div id="fixtures"><p class="muted">V√°lassz sport√°gat √©s t√∂ltsd be a meccseket!</p></div></details>
        </div>
    </div>
    <div class="col-center">
        <div class="card">
            <h2>K√©zi Meccselemz√©s</h2>
            <div class="row">
                <div class="col"><label for="home">Hazai csapat</label><input id="home" placeholder="Pl. Liverpool"/></div>
                <div class="col"><label for="away">Vend√©g csapat</label><input id="away" placeholder="Pl. Manchester City"/></div>
            </div>
            <div class="row" style="margin-top: .7rem;">
                <div class="col"><label for="homeFormWeight">Hazai Forma S√∫lya: <span id="homeFormWeightLabel">50%</span></label><input type="range" min="0" max="100" value="50" id="homeFormWeight"></div>
                <div class="col"><label for="awayFormWeight">Vend√©g Forma S√∫lya: <span id="awayFormWeightLabel">50%</span></label><input type="range" min="0" max="100" value="50" id="awayFormWeight"></div>
            </div>
            <div class="actions">
                <button id="goBtn" class="btn-primary" onclick="runAnalysis(false)">Elemz√©s Futtat√°sa</button>
            </div>
            <div id="progress" class="progress-ring" style="display:none"><span class="progress-label"></span></div>
            <p id="status" class="muted" style="text-align:center">K√©sz.</p>
        </div>
        <div id="out"></div>
    </div>
    <div class="col-right">
       <div class="card">
          <details>
             <summary>Elemz√©si El≈ëzm√©nyek (Napl√≥)</summary>
             <input id="historySearch" placeholder="Keres√©s a napl√≥ban..." oninput="filterHistory()" style="margin-top: .5rem; margin-bottom:0.8rem"/>
             <div id="history"><p class="muted">Itt fognak megjelenni a kor√°bbi elemz√©seid.</p></div>
          </details>
        </div>
    </div>
</div>
<div id="analysisModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalTitle" class="modal-title">Elemz√©s</h3>
            <button class="close-button" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>
<script>
let __gasUrl = 'https://script.google.com/macros/s/AKfycbxdUvCC1ZmiCmSk_UUM6ryen5yw7v7M9vc9Iep3uKhrJBVMwTb714mKvNJLDm6mrttmgQ/exec';
let __fixtures = [];
let __currentSport = 'soccer';

document.addEventListener("DOMContentLoaded", function(){
    if(!__gasUrl||!__gasUrl.startsWith('')){document.getElementById('userInfo').textContent='HIBA: K√©rlek, add meg a Web App URL-t!'}else{document.getElementById('userInfo').textContent=`Csatlakozva.`}
    renderHistory();
    ['homeFormWeight', 'awayFormWeight'].forEach(id => {
        const slider = document.getElementById(id);
        const label = document.getElementById(id + 'Label');
        slider.addEventListener('input', (e) => { label.textContent = `${e.target.value}%`; });
    });
});

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m])}
function setProgress(pct,msg=null){const el=document.getElementById('progress');const goBtn=document.getElementById('goBtn');const statusEl=document.getElementById('status');const v=Math.max(0,Math.min(100,Math.round(pct||0)));const indicator=el.style;indicator.display=v>0&&v<100?'grid':'none';if(v>0&&v<100){indicator.animation='pulse 2s infinite'}else{indicator.animation='none'}indicator.background=`conic-gradient(var(--primary) ${v*3.6}deg, rgba(255,255,255,.18) 0deg)`;el.querySelector('.progress-label').textContent=v+'%';if(msg)statusEl.textContent=msg}
function handleSportChange(){__currentSport=document.getElementById('sportSelector').value;document.getElementById('fixtures').innerHTML='<p class="muted">T√∂ltsd be a meccseket!</p>';document.getElementById('leagueList').innerHTML='<li class="muted">T√∂ltsd be a meccseket.</li>'}
async function loadFixtures(){const statusEl=document.getElementById('fxStatus');statusEl.textContent='Adatok lek√©r√©se...';if(!__gasUrl){statusEl.textContent='Hiba: Hi√°nyz√≥ GAS URL.';return}try{const response=await fetch(`${__gasUrl}?sport=${__currentSport}&days=2`);if(!response.ok)throw new Error(`H√°l√≥zati hiba: ${response.status}`);const data=await response.json();if(data.error)throw new Error(data.error);__fixtures=data.fixtures||[];renderFixtureList('all');renderLeagues();statusEl.textContent=`Siker! ${__fixtures.length} meccs bet√∂ltve.`}catch(e){statusEl.textContent=`Hiba: ${e.message}`}}

function renderLeagues(){const box=document.getElementById('leagueList');if(__fixtures.length===0){box.innerHTML='<li class="muted">Nincsenek meccsek.</li>';return}const leagues=[...new Set(__fixtures.map(f=>f.league))];let html=`<li class="league-item active" onclick="filterFixturesByLeague('all', this)">√ñsszes Bajnoks√°g</li>`;html+=leagues.map(l=>`<li class="league-item" onclick="filterFixturesByLeague('${escapeHtml(l)}', this)">${escapeHtml(l)}</li>`).join('');box.innerHTML=html}
function filterFixturesByLeague(league, element){document.querySelectorAll('.league-item').forEach(el=>el.classList.remove('active'));element.classList.add('active');renderFixtureList(league)}

function renderFixtureList(league='all'){const box=document.getElementById('fixtures');const filteredFixtures=league==='all'?__fixtures:__fixtures.filter(f=>f.league===league);if(filteredFixtures.length===0){box.innerHTML=`<div class="muted">Nincs meccs ebben a bajnoks√°gban.</div>`;return}box.innerHTML=filteredFixtures.map(fx=>{const d=new Date(fx.utcKickoff).toLocaleString('hu-HU',{dateStyle:'short',timeStyle:'short'});return`<div class="fx-item"><div class="fx-item-details"><div style="flex-grow:1"><div class="fx-title">${escapeHtml(fx.home)} ‚Äì ${escapeHtml(fx.away)}</div><div class="fx-meta">${escapeHtml(fx.league)} ¬∑ ${d}</div></div></div><button class="btn-primary btn-sm" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">Elemz√©s</button></div>`}).join('')}
function fillAndAnalyze(home,away){document.getElementById('home').value=home;document.getElementById('away').value=away;document.querySelector('.col-center').scrollIntoView({behavior:'smooth'});runAnalysis(false)}

// === JAV√çT√ÅS: Intelligens √∫jraelemz√©si logika ===
async function runAnalysis(forceNew = false) {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const homeFormWeight = document.getElementById("homeFormWeight").value;
    const awayFormWeight = document.getElementById("awayFormWeight").value;
    if (!home || !away || !__gasUrl) { setProgress(0, "Hiba: Hi√°nyz√≥ adatok."); return; }

    const historyId = `analysis_${__currentSport}_${home}_vs_${away}_w${homeFormWeight}-${awayFormWeight}`;
    const isCachedLocally = localStorage.getItem(historyId);

    // Ha nincs explicit k√©nyszer√≠t√©s √âS megvan a helyi t√°rol√≥ban, akkor azt haszn√°ljuk
    if (!forceNew && isCachedLocally) {
        openModal(home, away, isCachedLocally);
        document.getElementById('status').textContent = "El≈ëzm√©ny bet√∂ltve a napl√≥b√≥l.";
        return;
    }

    // Ha ide eljut, akkor vagy k√©nyszer√≠tett √∫jraelemz√©s van, vagy nincs helyi m√°solat
    // Ilyenkor MINDIG k√©r√ºnk egy friss verzi√≥t a szervert≈ël (force=true)
    let progressInterval;
    try {
        setProgress(1, "Elemz√©s ind√≠t√°sa...");
        let analysisUrl = `${__gasUrl}?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}&homeFormWeight=${homeFormWeight}&awayFormWeight=${awayFormWeight}&force=true`;
        
        progressInterval = setInterval(() => { const c = parseInt(document.querySelector('#progress .progress-label').textContent) || 0; setProgress(Math.min(90, c + 2), "Szerver v√°lasz√°ra v√°runk...") }, 800);
        const response = await fetch(analysisUrl);
        clearInterval(progressInterval);
        if (!response.ok) throw new Error(`Szerver hiba: ${response.status}`);
        setProgress(95, "V√°lasz feldolgoz√°sa...");
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        openModal(home, away, data.html);
        saveAnalysis(home, away, data.html, historyId);
        setProgress(100, "K√©sz.");
    } catch (e) {
        if (progressInterval) clearInterval(progressInterval);
        setProgress(0, "Hiba: " + e.message);
    }
}


function saveAnalysis(home,away,html,id){let history=getHistoryFromLocalStorage();const now=new Date().toLocaleString('hu-HU');const record={id,home,away,date:now,sport:__currentSport};const existingIndex=history.findIndex(item=>item.id.startsWith(`analysis_${__currentSport}_${home}_vs_${away}`));if(existingIndex>-1){history.splice(existingIndex,1)}history.unshift(record);localStorage.setItem('sportAnalysisHistory',JSON.stringify(history));localStorage.setItem(id,html);renderHistory()}
function getHistoryFromLocalStorage(){try{const json=localStorage.getItem('sportAnalysisHistory');return json?JSON.parse(json):[]}catch(e){return[]}}
function renderHistory(){const history=getHistoryFromLocalStorage();const query=document.getElementById('historySearch').value.toLowerCase();const box=document.getElementById('history');if(!history||history.length===0){box.innerHTML='<p class="muted">Nincsenek el≈ëzm√©nyek.</p>';return}const filtered=history.filter(item=>item.home.toLowerCase().includes(query)||item.away.toLowerCase().includes(query));box.innerHTML=filtered.map(item=>`<div class="fx-item"><div class="fx-item-details" onclick="loadAnalysisFromHistory('${item.id}')" style="cursor:pointer;flex-grow:1"><div><div class="fx-title">${escapeHtml(item.home)} ‚Äì ${escapeHtml(item.away)}</div><div class="fx-meta">${item.sport} ¬∑ ${item.date}</div></div></div><div class="fx-actions" style="display:flex;gap:5px"><button class="btn-primary btn-sm" onclick="loadAnalysisFromHistory('${item.id}')" title="Elemz√©s Megtekint√©se">üëÅÔ∏è</button><button class="btn-danger btn-sm" onclick="deleteHistoryItem('${item.id}',event)" title="T√∂rl√©s">üóëÔ∏è</button></div></div>`).join('')}
function filterHistory(){renderHistory()}
function loadAnalysisFromHistory(id){const html=localStorage.getItem(id);if(html){const record=getHistoryFromLocalStorage().find(item=>item.id===id);if(record){document.getElementById('home').value=record.home;document.getElementById('away').value=record.away;document.getElementById('sportSelector').value=record.sport;__currentSport=record.sport;const weights=id.split('_w')[1]?.split('-')||[50,50];document.getElementById('homeFormWeight').value=weights[0];document.getElementById('awayFormWeight').value=weights[1];document.getElementById('homeFormWeightLabel').textContent=`${weights[0]}%`;document.getElementById('awayFormWeightLabel').textContent=`${weights[1]}%`;openModal(record.home,record.away,html)}document.getElementById('status').textContent="El≈ëzm√©ny bet√∂ltve.";document.querySelector('.col-center').scrollIntoView({behavior:'smooth'})}else{alert("Hiba: Az elemz√©s nem tal√°lhat√≥.")}}
function deleteHistoryItem(id,event){event.stopPropagation();if(confirm("Biztosan t√∂r√∂lni szeretn√©d ezt az elemet?")){let history=getHistoryFromLocalStorage();const updatedHistory=history.filter(item=>item.id!==id);localStorage.setItem('sportAnalysisHistory',JSON.stringify(updatedHistory));localStorage.removeItem(id);renderHistory()}}
function openModal(home,away,htmlContent){document.getElementById('modalTitle').textContent=`${home} vs ${away}`;document.getElementById('modalBody').innerHTML=htmlContent;document.getElementById('analysisModal').style.display='flex'}
function closeModal(){document.getElementById('analysisModal').style.display='none'}
</script>
</body>
</html>
