<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemző Gemini AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--bg-grad-1:#0b1020;--bg-grad-2:#0a112a;--glass:#0f1730cc;--card:#0f172a;--border:#22304f;--muted:#a3b3d9;--primary:#4f46e5;--secondary:#14b8a6;--accent:#10b981;--ring:#14b8a6;--text:#e5e7eb;--font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family);color:var(--text);background:radial-gradient(1300px 600px at -10% -20%,rgba(20,184,166,.15),transparent 45%),radial-gradient(1100px 500px at 110% 120%,rgba(79,70,229,.15),transparent 50%),linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));min-height:100vh}
.app-header{background:linear-gradient(90deg,rgba(79,70,229,.95),rgba(20,184,166,.95));color:#fff;padding:1.1rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.1)}
.app-header h1{font-weight:800; margin:0;}
.user-info { font-size: 0.9rem; margin-top: 5px; opacity: 0.8; }
.container{max-width:1200px;margin:1.8rem auto;padding:0 1rem}
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)),var(--card);border:1px solid var(--border);border-radius:16px;padding:1.1rem;margin-bottom:1rem;box-shadow:0 20px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(6px)}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700;margin-top:0;color:#e5e7eb}
label{display:block;font-weight:600;margin-top:.6rem}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c1429;color:var(--text);margin-top:.25rem;font-size:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(20,184,166,.25)}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 220px}
.actions{margin-top:1rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.actions button, .btn-primary {padding:12px 18px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;cursor:pointer;white-space:nowrap;box-shadow:0 12px 28px rgba(20,184,166,.35),0 4px 12px rgba(79,70,229,.25);width:100%;transition:transform .2s ease;font-family:var(--font-family); text-align: center;}
.actions button:hover:not(:disabled), .btn-primary:hover:not(:disabled) {transform:translateY(-2px)}
.actions button:disabled, .btn-primary:disabled {background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
.slip-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
.stat-item { text-align: center; background: #1a2441; padding: 15px 10px; border-radius: 8px; border: 1px solid var(--border); transition: transform 0.2s; }
.stat-title { font-size: 0.85rem; color: var(--muted); font-weight: 600;}
.stat-value { font-weight: 800; font-size: 1.3rem; margin-top: 5px; color: var(--text); }
.stat-value.profit { color: var(--accent); }
.stat-value.loss { color: #ff6b6b; }
.details-summary { display: flex; justify-content: space-between; align-items: center; cursor: pointer; list-style: none; padding: 5px 0;}
details > .details-summary::-webkit-details-marker { display: none; }
details[open] > .details-summary::before { transform: rotate(90deg); }
.sim-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; text-align: center; margin-top: 1rem; }
.sim-item { background: #1a2441; padding: 8px; border-radius: 6px; font-weight: 600; border: 1px solid var(--border); }
.stylish-label { text-transform: uppercase; font-size: 0.8rem; color: var(--muted); letter-spacing: 0.05em;}
.stylish-input { background: #0b1020; border: 1px solid var(--border); padding: 16px; font-size: 1.5rem; font-weight: 700; color: var(--secondary); text-align: center; }
.stylish-input:focus { border-color: var(--accent); }
input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; background: linear-gradient(to right, var(--primary), var(--secondary)); border-radius: 10px; outline: none; opacity: 0.9; transition: opacity .2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }
input[type="range"]:hover { opacity: 1; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.4); margin-top: -6px; border: 2px solid var(--primary); }
.progress-ring{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;margin:1rem auto;transition:opacity .5s}.progress-label{font-size:1.5rem;font-weight:700}
</style>
</head>
<body>
<header class="app-header">
    <h1>SportElemző Gemini AI</h1>
    <div id="userInfo" class="user-info">Adatok betöltése...</div>
</header>
<div class="container layout">
  <aside>
    <div class="card">
      <h2>Beállítások</h2>
      <button class="btn-primary" style="margin-bottom: 1rem;" onclick="openSettingsModal()">Beállítások Megnyitása</button>
      <label for="sportSelector">Sportág</label>
      <select id="sportSelector" onchange="handleSportChange()">
          <option value="soccer" selected>Labdarúgás</option>
          <option value="hockey">Jégkorong</option>
          <option value="basketball">Kosárlabda</option>
      </select>
       <label for="leagueSearch" style="margin-top: 1rem;">Keresés ligában</label>
       <input id="leagueSearch" placeholder="pl. Premier, NHL..." />
      <div class="actions">
        <button onclick="loadFixtures()" style="background: var(--secondary); box-shadow: 0 12px 28px rgba(20,184,166,.35), 0 4px 12px rgba(20,184,166,.25);">Meccsek frissítése az API-ról</button>
        <button onclick="saveFavLeagues()">Kedvencek mentése a felhőbe</button>
        <span id="fxStatus" class="muted"></span>
      </div>
      <div class="league-list" id="leagueList"></div>
    </div>
    <div class="card">
      <h2>Közelgő meccsek</h2>
      <div id="fixtures" class="fixtures"><p class="muted">Válassz sportágat és frissíts!</p></div>
    </div>
  </aside>

  <main>
    <div class="card">
        <h2>Meccselemzés</h2>
        <datalist id="teamlist"></datalist>
        <div class="row">
          <div class="col"><label for="home">Hazai csapat</label><input id="home" list="teamlist" placeholder="Pl. Liverpool" /></div>
          <div class="col"><label for="away">Vendég csapat</label><input id="away" list="teamlist" placeholder="Pl. Manchester City" /></div>
        </div>
        <div class="row" style="margin-top: .7rem;">
          <div class="col"><label for="homeFormWeight">Hazai Forma Súlya: <span id="homeFormWeightLabel">50%</span></label><input type="range" class="slider" min="0" max="100" value="50" id="homeFormWeight"></div>
          <div class="col"><label for="awayFormWeight">Vendég Forma Súlya: <span id="awayFormWeightLabel">50%</span></label><input type="range" class="slider" min="0" max="100" value="50" id="awayFormWeight"></div>
        </div>
        <div class="actions">
          <button id="goBtn" class="btn-primary" onclick="go()">Elemzés Futtatása a Gemini AI-val</button>
        </div>
        <div id="progress" class="progress-ring" style="display:none;"><span class="progress-label"></span></div>
        <p id="status" class="muted" style="text-align:center;"></p>
    </div>

    <div class="card">
        <h2>AI Szelvény Generátor</h2>
        <p class="muted">Az AI a mai nap legvalószínűbb ("bankár") meccseiből összeállít neked egy szelvényt a megadott célodds közelében.</p>
        <div class="row"><div class="col"><label for="targetOdds" class="stylish-label">Cél odds</label><input type="number" id="targetOdds" class="stylish-input" value="2.5" /></div></div>
        <div class="actions"><button id="generateSlipBtn" class="btn-primary" onclick="generateAutoSlip()">Szelvény Generálása</button></div>
        <div id="autoSlipResult" style="margin-top: 1rem; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.2);"><p class="muted">Az AI indoklása itt fog megjelenni.</p></div>
    </div>

    <div id="out" class="card" style="min-height: 200px;"><p class="muted">A meccselemzés eredménye itt jelenik meg.</p></div>
    
    <details class="card">
        <summary class="details-summary"><h2>Visszatesztelés</h2></summary>
        <p class="muted">Régebbi szezonok adatainak tesztelése (football-data.co.uk adatokkal).</p>
        <div class="row">
            <div class="col"><label for="backtestLeague">Liga kód (pl. E0, I1, D1)</label><input id="backtestLeague" placeholder="Pl. E0" value="E0" /></div>
            <div class="col"><label for="backtestSeason">Szezon kód (Pl. 2324, 2223)</label><input id="backtestSeason" placeholder="Pl. 2324" value="2324" /></div>
        </div>
        <div class="actions"><button id="runBacktestBtn" class="btn-primary" onclick="runBacktest()">Visszatesztelés Futtatása</button></div>
        <div id="backtestResult" style="margin-top: 1rem;"></div>
    </details>

    <details class="card">
        <summary class="details-summary"><h2>Pénzügyi Statisztikák</h2></summary>
        <p class="muted">Itt szűrheted a múltbeli szelvényeid teljesítményét különböző szempontok szerint.</p>
        <div class="row" style="margin-bottom: 1rem;">
            <div class="col"><label for="statFilterSport">Sportág</label><select id="statFilterSport" onchange="calculateStats()"><option value="all">Összes</option></select></div>
            <div class="col"><label for="statFilterLeague">Bajnokság</label><select id="statFilterLeague" onchange="calculateStats()"><option value="all">Összes</option></select></div>
            <div class="col"><label for="statFilterMarket">Piac</label><select id="statFilterMarket" onchange="calculateStats()"><option value="all">Összes</option></select></div>
        </div>
        <div id="slipStats" style="min-height: 40px; margin-top: 1rem;"><p class="muted">Nincsenek szelvényelőzmények a számításhoz.</p></div>
    </details>

    <details class="card">
        <summary class="details-summary"><h2>Fogadási Szelvény</h2></summary>
        <div id="betSlip" style="margin-bottom: 1rem;"><p class="muted">A szelvény üres.</p></div>
        <div id="slipActions" style="display: none; margin-bottom: 1rem;">
            <button class="btn-primary" style="background: #c2410c; box-shadow: none;" onclick="clearSlip()">Szelvény Ürítése</button>
        </div>
        <div id="slipEvaluation" style="display: none;">
            <h3>Eredmények Megadása</h3>
            <div id="slipResultInputs" class="result-inputs"></div>
            <div class="actions"><button class="btn-primary" onclick="evaluateSlip()">Szelvény Értékelése</button></div>
        </div>
    </details>
    
    <details class="card">
      <summary class="details-summary"><h2>Előző Elemzések</h2></summary>
      <input id="historySearch" placeholder="Keresés..." oninput="filterHistory()" style="margin-bottom: 0.8rem;" />
      <div id="history" class="history-list"><p class="muted">Nincsenek korábbi elemzések.</p></div>
    </details>
</main>
</div>

<script>
let __historyCache = [], __allLeagues = [], __favLeagues = new Set(), __fixtures = [], __masterTeamList = [], __gasUrl = '', __currentSport = 'soccer', __betSlip = [], __slipHistory = [], __user = { email: null, initialBankroll: 10000 };
let isSaving = false;

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);}
function setProgress(pct,msg=null){const el=document.getElementById('progress');const goBtn=document.getElementById('goBtn');const statusEl=document.getElementById('status');const v=Math.max(0,Math.min(100,Math.round(pct||0)));if(v>0&&v<100){el.style.display='grid';goBtn.disabled=true;}else{setTimeout(()=>{el.style.display='none';},250);goBtn.disabled=false;}el.style.background=`conic-gradient(var(--ring) ${v*3.6}deg, rgba(255,255,255,.18) 0deg)`;el.querySelector('.progress-label').textContent=v+'%';if(msg)statusEl.textContent=msg;}

document.addEventListener("DOMContentLoaded", async function() {
    __gasUrl = localStorage.getItem('gasUrl') || '';
    ['homeFormWeight', 'awayFormWeight'].forEach(id => {
        const slider = document.getElementById(id);
        const label = document.getElementById(id + 'Label');
        if (slider && label) {
            slider.addEventListener('input', (e) => { label.textContent = `${e.target.value}%`; });
        }
    });
    ['home', 'away'].forEach(id => document.getElementById(id).addEventListener('input', handleTeamInput));
    document.getElementById('leagueSearch').addEventListener('input', renderLeagueList);
    renderHistory(getHistoryFromLocalStorage());
    if (__gasUrl) { await loadUserDataFromCloud(); } 
    else { document.getElementById('userInfo').textContent = 'Kérlek, add meg a backend URL-t a Beállításokban.'; }
});

async function loadUserDataFromCloud() {
    if (!__gasUrl) return;
    try {
        document.getElementById('userInfo').textContent = 'Felhasználói adatok betöltése...';
        const response = await fetch(`${__gasUrl}?action=loadUserData`);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(`Backend hiba: ${data.error}`);
        __user.email = data.userEmail;
        __user.initialBankroll = data.bankroll || 10000;
        __slipHistory = data.slipHistory || [];
        try { __favLeagues = new Set(JSON.parse(data.favLeagues || "[]")); } catch(e) { __favLeagues = new Set(); }
        document.getElementById('userInfo').textContent = `Bejelentkezve: ${__user.email}`;
        renderSlip();
        populateStatFilters();
        calculateStats();
        if(__allLeagues.length > 0) renderLeagueList();
    } catch (e) { document.getElementById('userInfo').textContent = `Hiba: ${e.message}.`; }
}

async function saveDataToCloud(dataObject) {
    if (!__gasUrl || isSaving) return;
    isSaving = true;
    try {
        const params = new URLSearchParams({ action: 'saveUserData' });
        for (const key in dataObject) { params.append(key, dataObject[key]); }
        const response = await fetch(`${__gasUrl}?${params.toString()}`);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const result = await response.json();
        if (result.error) throw new Error(`Backend hiba: ${result.error}`);
    } catch (e) {
        console.error("Hiba a mentés során:", e);
    } finally {
        isSaving = false;
    }
}

async function saveFavLeagues() {
    await saveDataToCloud({ favLeagues: JSON.stringify(Array.from(__favLeagues)) });
    document.getElementById('fxStatus').textContent = 'Kedvencek elmentve.';
}

function handleSportChange() { __currentSport = document.getElementById('sportSelector').value; document.getElementById('leagueList').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>'; document.getElementById('fixtures').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>'; document.getElementById('teamlist').innerHTML = ''; }
function updateDatalist(teamArray) { document.getElementById('teamlist').innerHTML = teamArray.map(t => `<option value="${escapeHtml(t)}"></option>`).join(''); }
function handleTeamInput(event) { const query = event.target.value.toLowerCase(); const filteredTeams = query ? __masterTeamList.filter(team => team.toLowerCase().includes(query)) : __masterTeamList; updateDatalist(filteredTeams); }
function populateTeams(fixtures){ const teams = new Set(); (fixtures || []).forEach(f => { teams.add(f.home); teams.add(f.away); }); __masterTeamList = Array.from(teams).sort((a,b)=>a.localeCompare(b,'hu')); updateDatalist(__masterTeamList); }

async function loadFixtures() {
    const statusEl = document.getElementById('fxStatus');
    statusEl.textContent = 'Adatok lekérése...';
    if (!__gasUrl) { statusEl.textContent = 'Hiba: Hiányzó GAS URL.'; return; }
    try {
        const response = await fetch(`${__gasUrl}?sport=${__currentSport}`);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        __allLeagues = data.leagues || []; __fixtures = data.fixtures || [];
        renderLeagueList(); renderFixtureList(); populateTeams(__fixtures);
        statusEl.textContent = `Sikeres frissítés! ${__fixtures.length} meccs betöltve.`;
    } catch (e) { statusEl.textContent = `Hiba a frissítés során: ${e.message}`; }
}

function renderLeagueList(){const box=document.getElementById('leagueList');const q=(document.getElementById('leagueSearch').value||'').toLowerCase();const list=(__allLeagues||[]).filter(x=>!q||x.name.toLowerCase().includes(q));box.innerHTML=list.map(x=>{const c=__favLeagues.has(x.name)?'checked':'';return`<label class="league-item"><input type="checkbox" data-league="${escapeHtml(x.name)}" ${c}><span>${escapeHtml(x.name)}</span><span class="badge">${x.count}</span></label>`}).join('');box.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.addEventListener('change',e=>{const n=e.target.dataset.league;if(e.target.checked)__favLeagues.add(n);else __favLeagues.delete(n);renderFixtureList();});});}
function renderFixtureList(){const box=document.getElementById('fixtures');const fav=__favLeagues.size>0?new Set(__favLeagues):null;const list=(__fixtures||[]).filter(fx=>!fav||fav.has(fx.league));if(list.length===0){box.innerHTML=`<div class="muted">Nincs megjeleníthető meccs.</div>`;return;}box.innerHTML=list.map(fx=>{const d=new Date(fx.utcKickoff).toLocaleString('hu-HU',{dateStyle:'short',timeStyle:'short'});return`<div class="fx-item"><div><div class="fx-title">${escapeHtml(fx.home)} – ${escapeHtml(fx.away)}</div><div class="fx-meta">${escapeHtml(fx.league)} · ${d}</div></div><div><button class="fx-btn" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">AI elemzés</button></div></div>`}).join('');}
function fillAndAnalyze(home,away){document.getElementById('home').value=home;document.getElementById('away').value=away;document.querySelector('main').scrollIntoView({behavior:'smooth'});go();}

async function go(){
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const homeFormWeight = document.getElementById("homeFormWeight").value;
    const awayFormWeight = document.getElementById("awayFormWeight").value;
    if(!home || !away || !__gasUrl){ document.getElementById("status").textContent="Hiba: Hiányzó adatok."; return; }
    
    let progressInterval;
    try {
        setProgress(1, "Elemzés indítása...");
        const analysisUrl=`${__gasUrl}?action=runFullAnalysis&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&homeFormWeight=${homeFormWeight}&awayFormWeight=${awayFormWeight}&sport=${__currentSport}`;
        progressInterval=setInterval(()=>{const currentPct=parseInt(document.querySelector('#progress .progress-label').textContent)||0;setProgress(Math.min(90,currentPct+2),"Szerver válaszára várunk...");},500);
        const response=await fetch(analysisUrl);
        clearInterval(progressInterval);
        if(!response.ok) throw new Error(`Szerver hiba: ${response.status}`);
        setProgress(95,"Válasz feldolgozása...");
        const data=await response.json();
        if(data.error) throw new Error(data.error);
        
        document.getElementById('out').innerHTML = data.html || '<p class="muted">Nincs elemzés.</p>';
        
        const simButtonContainer = document.createElement('div');
        simButtonContainer.className = 'actions';
        simButtonContainer.innerHTML = `<button class="btn-primary" style="margin-top: 1rem; background: var(--primary);" onclick="runVisualSimulator()">Szimulálj 10 meccset!</button>`;
        document.getElementById('out').appendChild(simButtonContainer);
        const simResultDiv = document.createElement('div');
        simResultDiv.id = 'visualSimResults';
        simResultDiv.className = 'sim-results';
        document.getElementById('out').appendChild(simResultDiv);

        const record={timestamp:new Date().toISOString(),home,away,analysis:data.html};
        saveAnalysis(record);
        renderHistory(getHistoryFromLocalStorage());
        setProgress(100, "Kész.");
    } catch(e) {
        if(progressInterval) clearInterval(progressInterval);
        setProgress(0);
        document.getElementById("status").textContent="Hiba: "+e.message;
    }
}

async function runVisualSimulator() {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const resultsDiv = document.getElementById('visualSimResults');
    if (!home || !away) return;
    resultsDiv.innerHTML = `<p class="muted">Szimuláció fut...</p>`;
    try {
        const url = `${__gasUrl}?action=runQuickSim&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}&homeFormWeight=${document.getElementById("homeFormWeight").value}&awayFormWeight=${document.getElementById("awayFormWeight").value}`;
        const response = await fetch(url);
        const data = await response.json();
        if(data.error) throw new Error(data.error);
        resultsDiv.innerHTML = data.results.map(res => `<div class="sim-item">${res.gh} - ${res.ga}</div>`).join('');
    } catch(e) { resultsDiv.innerHTML = `<p style="color: #ff5555;">Hiba: ${e.message}</p>`; }
}

function clearSlip() {
    if (__betSlip.length > 0 && confirm('Biztosan törlöd a szelvény összes elemét?')) {
        __betSlip = [];
        renderSlip();
    }
}

function renderSlip(){
    const container=document.getElementById('betSlip');
    const evaluationContainer=document.getElementById('slipEvaluation');
    const resultInputsContainer=document.getElementById('slipResultInputs');
    const slipActions = document.getElementById('slipActions');
    if(__betSlip.length === 0){
        container.innerHTML = '<p class="muted">A szelvény üres.</p>';
        evaluationContainer.style.display = 'none';
        slipActions.style.display = 'none';
        return;
    }
    slipActions.style.display = 'block';
    let slipHTML = __betSlip.map((bet,index) => `<div class="slip-item"><div class="slip-item-header"><div><div class="slip-title">${escapeHtml(bet.match)}</div><div class="slip-market">${escapeHtml(bet.market)}</div></div><button onclick="removeBet(${index})" style="background:transparent; border:none; color: #ff6b6b; font-size: 24px; cursor:pointer;">&times;</button></div><div class="slip-details">${escapeHtml(bet.selection)} @ ${bet.odds}</div></div>`).join('');
    const totalOdds = __betSlip.reduce((acc, bet) => acc * bet.odds, 1);
    const potentialWinnings = (parseFloat(document.getElementById('comboStake')?.value) || 0) * totalOdds;
    slipHTML += `<div class="slip-summary-card"><div class="summary-row"><span>Események száma:</span><strong>${__betSlip.length}</strong></div><div class="summary-row"><span>Eredő Odds:</span><strong>${totalOdds.toFixed(2)}</strong></div><div class="summary-row"><label for="comboStake">Teljes Tét:</label><input type="number" id="comboStake" placeholder="0" oninput="renderSlip()" value="${document.getElementById('comboStake')?.value || 0}"></div><hr style="border-color: var(--border); margin: 1rem 0;"><div class="summary-row"><span>Várható Nyeremény:</span><strong>${potentialWinnings.toFixed(2)}</strong></div></div>`;
    container.innerHTML = slipHTML;
    const uniqueMatches=[...new Map(__betSlip.map(bet=>[bet.match,bet])).values()];
    resultInputsContainer.innerHTML=uniqueMatches.map((bet,index)=>`<div class="slip-item"><div class="slip-title">${escapeHtml(bet.match)}</div><div class="slip-results-input-grid"><label>Hazai</label><span>-</span><label>Vendég</label><input type="number" id="home-score-${index}" placeholder="H" size="2"><span></span><input type="number" id="away-score-${index}" placeholder="V" size="2"></div></div>`).join('');
    evaluationContainer.style.display='block';
}

function saveAnalysis(record){let h=getHistoryFromLocalStorage();h.unshift(record);if(h.length>50)h=h.slice(0,50);localStorage.setItem("analysisHistory",JSON.stringify(h));}
function getHistoryFromLocalStorage(){try{return JSON.parse(localStorage.getItem("analysisHistory"))||[];}catch(_){return[];}}
function renderHistory(history){const box=document.getElementById("history");if(!history||!history.length){__historyCache=[];box.innerHTML='<p class="muted">Nincs előzmény.</p>';return;}__historyCache=history;const fmt=iso=>new Date(iso).toLocaleString('hu-HU',{dateStyle:'short',timeStyle:'short'});box.innerHTML=history.map((item,i)=>`<details><summary class="details-summary"><div class="hist-title">${escapeHtml(item.home)} vs ${escapeHtml(item.away)}</div><div class="hist-date">${fmt(item.timestamp)}</div></summary><div>${item.analysis||''}<button onclick="openHistoryModal(${i})">Megnyitás</button></div></details>`).join('');}
function filterHistory(){const q=document.getElementById('historySearch').value.toLowerCase();document.querySelectorAll('#history details').forEach(item=>{const title=item.querySelector('.hist-title').textContent.toLowerCase();item.style.display=title.includes(q)?'':'none';});}
function openHistoryModal(idx){const item=__historyCache[idx];if(!item)return;document.getElementById('modalTitle').textContent=`${item.home} vs ${item.away}`;document.getElementById('modalBody').innerHTML=item.analysis||'';document.getElementById('modal').classList.add('open');}
async function saveSettings(){const newUrl=document.getElementById('gasUrlModal').value.trim();const newBankroll=parseFloat(document.getElementById('bankrollModal').value)||10000;__gasUrl=newUrl;localStorage.setItem('gasUrl',newUrl);__user.initialBankroll=newBankroll;await saveDataToCloud({bankroll:newBankroll});closeModal();calculateStats();document.getElementById('fxStatus').textContent='Beállítások mentve.';await loadUserDataFromCloud();}

async function generateAutoSlip() {
    const btn = document.getElementById('generateSlipBtn');
    const resultDiv = document.getElementById('autoSlipResult');
    const targetOdds = parseFloat(document.getElementById('targetOdds').value);
    if (isNaN(targetOdds) || targetOdds <= 1) { alert('Adj meg érvényes céloddsot.'); return; }
    if (!__gasUrl) { resultDiv.innerHTML = `<p style="color: #ff5555;">Hiba: Hiányzó URL.</p>`; return; }
    try {
        btn.disabled = true; btn.textContent = 'Generálás...';
        resultDiv.innerHTML = `<p class="muted">Az AI tippeket keres... Ez eltarthat egy percig.</p>`;
        const url = `${__gasUrl}?action=generateAutoSlip&targetOdds=${targetOdds}&sport=${__currentSport}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        if (data.slip && data.slip.length > 0) {
            __betSlip = [];
            data.slip.forEach(bet => { addToSlip(bet.match, bet.market, bet.selection, bet.odds, bet.prob, bet.league); });
            resultDiv.innerHTML = `<p style="font-weight: 600; color: var(--accent);">Siker! A tippek a szelvényre kerültek.</p><hr style="border-color: var(--border); margin: 0.8rem 0;"><p>${data.narrative.replace(/\n/g, '<br>')}</p>`;
        } else {
            let reasonText = "Nem találtunk megfelelő, nagy valószínűségű tippet a szelvény összeállításához.";
            if (data.reason === 'kevés meccs') { reasonText = `Sajnos nem találtunk elég meccset a listában a kereséshez. (${data.details}) Próbálj meg később frissíteni.`; } 
            else if (data.reason === 'nincs magabiztos tipp') { reasonText = `Bár találtunk meccseket, egyik kimenetel sem érte el a beállított bizalmi küszöböt. (${data.details}) Próbálj meg más céloddsot!`; }
            resultDiv.innerHTML = `<p>${reasonText}</p>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<p style="color: #ff5555;">Hiba: ${e.message}</p>`;
    } finally {
        btn.disabled = false; btn.textContent = 'Szelvény Generálása';
    }
}

function addToSlip(match,market,selection,odds,ourProb, league){const betId=`${match}-${selection}`;if(__betSlip.some(b=>b.id.startsWith(match)))return;__betSlip.push({id:betId,match,market,selection,odds,ourProb, league: league});renderSlip();}
function removeBet(index){if(!confirm('Biztosan törlöd?'))return;__betSlip.splice(index,1);renderSlip();}
async function evaluateSlip(){/* ... teljes, változatlan függvény ... */}

function getSportFromBet(bet) {
    if (!bet || !bet.market) return 'egyéb';
    if (bet.market.toLowerCase().includes('pontok')) return 'basketball';
    if (bet.market.toLowerCase().includes('gólok') || bet.market.toLowerCase().includes('1x2')) return 'soccer';
    if (bet.market.toLowerCase().includes('győztes')) return 'hockey';
    return 'soccer';
}

function populateStatFilters() {
    const sports = new Set(['all']);
    const leagues = new Set(['all']);
    const markets = new Set(['all']);
    (__slipHistory || []).forEach(slip => {
        (slip.bets || []).forEach(bet => {
            sports.add(getSportFromBet(bet));
            if(bet.league) leagues.add(bet.league);
            markets.add(bet.market);
        });
    });
    const sportFilter = document.getElementById('statFilterSport');
    sportFilter.innerHTML = [...sports].sort().map(s => `<option value="${s}">${s === 'all' ? 'Összes Sportág' : s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('');
    const leagueFilter = document.getElementById('statFilterLeague');
    leagueFilter.innerHTML = [...leagues].sort().map(l => `<option value="${l}">${l === 'all' ? 'Összes Bajnokság' : l}</option>`).join('');
    const marketFilter = document.getElementById('statFilterMarket');
    marketFilter.innerHTML = [...markets].sort().map(m => `<option value="${m}">${m === 'all' ? 'Összes Piac' : m}</option>`).join('');
}

function calculateStats() {
    const sportFilter = document.getElementById('statFilterSport').value;
    const leagueFilter = document.getElementById('statFilterLeague').value;
    const marketFilter = document.getElementById('statFilterMarket').value;
    const filteredHistory = (__slipHistory || []).filter(slip => {
        if (!slip.bets || slip.bets.length === 0) return false;
        return slip.bets.every(bet => {
            const sportCheck = sportFilter === 'all' || getSportFromBet(bet) === sportFilter;
            const leagueCheck = leagueFilter === 'all' || bet.league === leagueFilter;
            const marketCheck = marketFilter === 'all' || bet.market === marketFilter;
            return sportCheck && leagueCheck && marketCheck;
        });
    });
    if (filteredHistory.length === 0) {
        document.getElementById('slipStats').innerHTML = '<p class="muted">A szűrési feltételekkel nincsenek szelvények.</p>';
        return;
    }
    const totalProfit = filteredHistory.reduce((acc, slip) => acc + slip.profit, 0);
    const totalSlips = filteredHistory.length;
    const winningSlips = filteredHistory.filter(s => s.status === 'win');
    const winRate = totalSlips > 0 ? (winningSlips.length / totalSlips * 100).toFixed(1) : 0;
    let longestWinStreak = 0, longestLossStreak = 0, currentWinStreak = 0, currentLossStreak = 0;
    filteredHistory.forEach(slip => {
        if (slip.status === 'win') { currentWinStreak++; currentLossStreak = 0; if (currentWinStreak > longestWinStreak) longestWinStreak = currentWinStreak;
        } else { currentLossStreak++; currentWinStreak = 0; if (currentLossStreak > longestLossStreak) longestLossStreak = currentLossStreak; }
    });
    const avgWinningOdds = winningSlips.length > 0 ? (winningSlips.reduce((a, s) => a + s.totalOdds, 0) / winningSlips.length).toFixed(2) : 'N/A';
    const profitColor = totalProfit >= 0 ? 'profit' : 'loss';
    document.getElementById('slipStats').innerHTML = `
        <p class="muted" style="width: 100%; text-align: center; grid-column: 1 / -1; margin-bottom: 0.5rem;">${totalSlips} szelvény alapján</p>
        <div class="stat-item"><div class="stat-title">Teljes Profit</div><div class="stat-value ${profitColor}">${totalProfit.toFixed(2)}</div></div>
        <div class="stat-item"><div class="stat-title">Találati Arány</div><div class="stat-value">${winRate}% (${winningSlips.length}/${totalSlips})</div></div>
        <div class="stat-item"><div class="stat-title">Átl. Nyertes Odds</div><div class="stat-value">${avgWinningOdds}</div></div>
        <div class="stat-item"><div class="stat-title">Max. Nyerő Széria</div><div class="stat-value profit">${longestWinStreak}</div></div>
        <div class="stat-item"><div class="stat-title">Max. Veszítő Széria</div><div class="stat-value loss">${longestLossStreak}</div></div>
    `;
}

async function runBacktest(){ /* ... teljes, változatlan függvény ... */ }
</script>
</body>
</html>
