<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemző AI - Műszerfal</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🏆</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
:root{--bg:#0D0D0D;--card-bg:rgba(26,26,26,0.65);--border-color:rgba(212,175,55,0.2);--muted:#888;--primary:#D4AF37;--secondary:#B8860B;--accent:#00BFFF;--text-primary:#F5F5DC;--text-secondary:#ccc;--danger:#FF4747;--success:#39FF14;--font-family-header:'Poppins',system-ui,sans-serif;--font-family-body:'Inter',system-ui,sans-serif}
*{box-sizing:border-box}
::selection{background-color:var(--primary);color:#000}
body{margin:0;font-family:var(--font-family-body);color:var(--text-primary);background-color:var(--bg);background-image:radial-gradient(circle at 1px 1px,rgba(212,175,55,0.1) 1px,transparent 0);background-size:20px 20px;min-height:100vh;overflow-x:hidden}
h1,h2,h3,h4,h5,h6{font-family:var(--font-family-header);color:var(--text-primary);margin-top:0}
p{line-height:1.7;color:var(--text-secondary)}
.app-header{background:linear-gradient(90deg,rgba(0,0,0,0.3),rgba(0,0,0,0.1));color:var(--primary);padding:1rem 2rem;text-align:center;border-bottom:1px solid var(--border-color);backdrop-filter:blur(10px);position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center}
.app-header h1{font-weight:600;margin:0;font-size:1.5rem}
.header-status{font-size:.9rem;opacity:.8;display:flex;align-items:center;gap:1.5rem}
.bankroll-display span{font-weight:700;color:var(--text-primary)}
.layout{display:grid;grid-template-columns:360px 1fr;gap:2rem;padding:2rem;max-width:1920px;margin:0 auto;align-items:start}
@media (max-width:1024px){.layout{grid-template-columns:1fr}}
.sidebar{position:sticky;top:100px}
.card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:16px;padding:1.5rem;box-shadow:0 8px 32px rgba(0,0,0,0.3);backdrop-filter:blur(10px);transition:transform .3s ease,box-shadow .3s ease}
.card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,0.4)}
label{display:block;font-weight:500;margin-bottom:.5rem;font-size:.9rem;color:var(--text-secondary)}
input,select{width:100%;padding:10px 14px;border:1px solid var(--border-color);border-radius:10px;background:rgba(0,0,0,0.3);color:var(--text-primary);margin-top:.25rem;font-size:.9rem;font-family:inherit;transition:all .2s ease}
input:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(212,175,55,.3)}
.btn{display:inline-block;padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;transition:all .2s ease;font-family:var(--font-family-header);text-align:center;text-decoration:none;position:relative;overflow:hidden}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#000}
.btn-primary:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 8px 20px rgba(212,175,55,.25)}
.btn:disabled{background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
#main-content .placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;border:2px dashed var(--border-color);border-radius:16px;color:var(--muted);padding:2rem;text-align:center}
#main-content .placeholder svg{width:64px;height:64px;margin-bottom:1rem;stroke-width:1.5;opacity:.5}
.tab-nav{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border-color)}
.tab-btn{padding:10px 15px;background:transparent;border:none;color:var(--muted);cursor:pointer;font-weight:700;position:relative;transition:color .2s ease;font-family:inherit}
.tab-btn.active{color:var(--primary)}
.tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--primary);box-shadow:0 0 10px var(--primary)}
.tab-content{display:none}
.tab-content.active{display:block;animation:fadeIn .5s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--border-color);cursor:pointer;transition:background-color .2s ease}
.list-item:hover{background-color:rgba(212,175,55,.1)}
.list-item-title{font-weight:700}.list-item-meta{font-size:.8rem;color:var(--muted)}
.list-group-header{font-weight:800;font-size:1.1rem;color:var(--secondary);padding:15px 0 10px 0;border-bottom:1px solid var(--border-color);margin-top:1rem; list-style: none; display: flex; align-items: center; cursor: pointer;}
.list-group-header::-webkit-details-marker { display: none; }
.list-group-header::before { content: '▶'; margin-right: 10px; font-size: 0.8em; transition: transform 0.2s; }
details[open] > .list-group-header::before { transform: rotate(90deg); }
.action-icon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;transition:background-color .2s ease;background:rgba(255,255,255,0.05)}
.action-icon:hover{background-color:rgba(255,255,255,0.1)}
.action-icon svg{width:18px;height:18px;stroke:var(--muted)}
.action-icon.delete:hover svg{stroke:var(--danger)}
.sport-filter-container{display:flex;gap:8px;margin-bottom:.8rem}
.sport-filter-btn{background-color:rgba(0,0,0,0.3);border:1px solid var(--border-color);color:var(--muted);padding:8px 15px;border-radius:10px;cursor:pointer;transition:all .2s ease;flex:1}
.sport-filter-btn:hover{border-color:var(--secondary);color:var(--text-primary)}
.sport-filter-btn.active{background-color:var(--primary);color:#000;border-color:var(--primary);font-weight:700}
.analysis-modal-body{padding:0}
.analysis-section h4{color:var(--secondary);margin:0 0 .8rem 0;font-size:1.2rem;border-bottom:1px solid var(--border-color);padding-bottom:.5rem;display:flex;align-items:center;gap:.5rem}
.analysis-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1.5rem}
@media (max-width:900px){.analysis-grid{grid-template-columns:1fr}}
.market-group{background:rgba(0,0,0,0.2);border-radius:12px;padding:1rem;border:1px solid var(--border-color)}
.prob-item{margin-bottom:.8rem}
.prob-label{display:flex;justify-content:space-between;font-weight:600;margin-bottom:4px}
.prob-bar-bg{width:100%;background:rgba(0,0,0,.3);border-radius:5px;height:10px;overflow:hidden}
.prob-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:5px}
.best-bet-card{background:linear-gradient(135deg,rgba(212,175,55,.05),rgba(184,134,11,.05));border:1px solid var(--primary);border-radius:12px;padding:1rem;margin-top:1.5rem}
.xg-comparison{padding:1rem;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid var(--border-color);margin-top:1rem;margin-bottom:1rem}
.xg-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.xg-label{flex-basis:120px;font-weight:600}
.xg-bar-container{flex-grow:1;height:20px;background:rgba(0,0,0,0.3);border-radius:8px;overflow:hidden}
.xg-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:8px}
.xg-value{font-weight:700;font-size:1.2rem}
.form-comparison{margin-bottom:1rem;padding:.8rem;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid var(--border-color)}
.form-row{display:flex;align-items:center;gap:10px}.form-row:first-child{margin-bottom:8px}
.form-label{font-weight:600}
.form-badges{display:flex;gap:5px}
.form-badge{width:24px;height:24px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#000;font-weight:700;font-size:.8rem}
.form-w{background-color:var(--success)}
.form-d{background-color:#f0ad4e}
.form-l{background-color:var(--danger)}
.model-confidence-card{border-color:var(--accent)!important;background:linear-gradient(135deg,rgba(0,191,255,.05),rgba(0,191,255,.1))!important}
.model-confidence-card h4{color:var(--accent)!important}
.confidence-score{font-size:1.5rem;font-weight:800;color:var(--accent)}
.value-bet-card{border-color:var(--success)!important;background:linear-gradient(135deg,rgba(57,255,20,.05),rgba(57,255,20,.1))!important}
.value-bet-card h4{color:var(--success)!important}
.value-highlight{color:var(--success);font-weight:800}
.btn-log-bet{font-size:.9rem;padding:8px 12px;margin-top:.5rem;background:linear-gradient(135deg,var(--success),#1e7e34);color:white}
.btn-log-bet:hover:not(:disabled){box-shadow:0 8px 20px rgba(57,255,20,.2)}
.progress-bar{width:100%;height:4px;background:var(--border-color);border-radius:2px;margin-top:1rem;overflow:hidden;display:none}
.progress-bar-inner{width:0;height:100%;background:var(--primary);transition:width .5s ease}
.status-text{text-align:center;margin-top:.5rem}
#loading-skeleton{display:none}
#loading-skeleton .skeleton-card{background:rgba(255,255,255,0.05);padding:1.5rem;border-radius:16px;margin-bottom:1.5rem}
#loading-skeleton .skeleton-line{background:rgba(255,255,255,0.1);border-radius:4px;margin-bottom:10px;animation:pulse-bg 1.5s infinite}
@keyframes pulse-bg{0%{background:rgba(255,255,255,0.1)}50%{background:rgba(255,255,255,0.05)}100%{background:rgba(255,255,255,0.1)}}
/* === ITT A JAVÍTÁS A NYÍL IGAZÍTÁSÁHOZ === */
.card > details > summary {
    font-family: var(--font-family-header);
    font-size: 1.25rem;
    font-weight: 600;
    list-style: none;
    display: flex;
    align-items: center;
    cursor: pointer;
}
.card > details > summary::-webkit-details-marker {
    display: none;
}
.card > details > summary::before {
    content: '▶';
    margin-right: 10px;
    font-size: 0.8em;
    transition: transform 0.2s;
}
.card > details[open] > summary::before {
    transform: rotate(90deg);
}
</style>
</head>
<body>

<header class="app-header">
    <h1>SportElemző Műszerfal</h1>
    <div class="header-status">
        <div id="bankrollDisplay" class="bankroll-display" style="display:none;">
            Bankroll: <span id="bankrollValue">...</span>
        </div>
        <div id="userInfo" class="user-info"></div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <div class="card">
            <nav class="tab-nav">
                <button class="tab-btn active" data-tab="tab-matches">Mérkőzések</button>
                <button class="tab-btn" data-tab="tab-manual">Kézi Elemzés</button>
                <button class="tab-btn" data-tab="tab-history">Előzmények</button>
            </nav>

            <div id="tab-matches" class="tab-content active">
                <label for="sportSelector">Sportág</label>
                <select id="sportSelector" onchange="handleSportChange()">
                    <option value="soccer" selected>Labdarúgás</option>
                    <option value="hockey">Jégkorong</option>
                    <option value="basketball">Kosárlabda</option>
                </select>
                <button id="loadFixturesBtn" class="btn btn-primary" onclick="loadFixtures()" style="width:100%; margin-top:1rem;">Meccsek Betöltése (2 nap)</button>
                <div id="fixtures-list" style="margin-top:1rem; max-height: 50vh; overflow-y:auto;"></div>
            </div>

            <div id="tab-manual" class="tab-content">
                <div class="row">
                    <div class="col"><label for="home">Hazai csapat</label><input id="home" placeholder="Pl. Liverpool"/></div>
                    <div class="col"><label for="away">Vendég csapat</label><input id="away" placeholder="Pl. Manchester City"/></div>
                </div>
                <button class="btn btn-primary" onclick="runAnalysis(true)" style="width:100%; margin-top:1rem;">Elemzés Futtatása</button>
            </div>

            <div id="tab-history" class="tab-content">
                <div id="history">
                    <p class="muted">Az előzmények betöltéséhez add meg a Google Táblázat URL-jét.</p>
                </div>
            </div>
        </div>

        <div class="card">
             <details>
                <summary>Teljesítménykövetés</summary>
                <div style="margin-top: 1rem;">
                    <div id="sheetUrlContainer">
                      <p class="muted" style="font-size: .8rem;">A napló és bankroll funkciókhoz add meg a Google Táblázat URL-jét.</p>
                      <label for="sheetUrl">Google Táblázat URL</label>
                      <input id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." onchange="saveSheetUrl()">
                    </div>
                    <div id="bankrollStatus" style="display:none;"></div>
                </div>
            </details>
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <div id="placeholder" class="placeholder">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20v-10M18 20V4"/></svg>
            <h3>Válassz egy mérkőzést a listából, vagy futtass kézi elemzést.</h3>
            <p>Az elemzés eredménye itt fog megjelenni.</p>
        </div>
        <div id="loading-skeleton">
            <div class="skeleton-card">
                <div class="skeleton-line" style="height: 2rem; width: 60%;"></div>
                <div class="skeleton-line" style="height: 1rem; width: 100%;"></div>
                <div class="skeleton-line" style="height: 1rem; width: 100%;"></div>
                <div class="skeleton-line" style="height: 1rem; width: 80%;"></div>
            </div>
            <div class="skeleton-card">
                 <div class="skeleton-line" style="height: 1.5rem; width: 40%;"></div>
                 <div class="skeleton-line" style="height: 1rem; width: 90%;"></div>
                 <div class="skeleton-line" style="height: 1rem; width: 70%;"></div>
            </div>
        </div>
        <div id="analysis-results"></div>
        <div id="progress-container" style="display:none;">
            <div class="progress-bar">
                <div id="progress-bar-inner" class="progress-bar-inner"></div>
            </div>
            <p id="status" class="status-text muted"></p>
        </div>
    </main>
</div>


<script>
let __gasUrl = 'https://script.google.com/macros/s/AKfycbzezgLIW-VE1ZCaRUU7nQ6lebTEH6VpUrjW-rpnJXUnXnkdlM9B3suv6dw-RZTTyfGiCg/exec';
let __fixtures = [];
let __currentSport = 'soccer';
let __historySportFilter = 'soccer';
let __sheetUrl = '';

function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
}

document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            const tabId = button.getAttribute('data-tab');
            tabContents.forEach(content => {
                content.style.display = content.id === tabId ? 'block' : 'none';
                if(content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            if (tabId === 'tab-history') {
                loadHistory();
            }
        });
    });
    
    if(!__gasUrl||!__gasUrl.startsWith('https://script.google.com')){
        document.getElementById('userInfo').textContent='HIBA: Web App URL nincs beállítva!';
        document.getElementById('userInfo').style.color = 'var(--danger)';
    } else {
        document.getElementById('userInfo').textContent=`Csatlakozva`;
    }
    loadSheetUrl();
});

function saveSheetUrl() {
    __sheetUrl = document.getElementById('sheetUrl').value;
    if (__sheetUrl && __sheetUrl.startsWith('https://docs.google.com/spreadsheets/d/')) {
        localStorage.setItem('sheetUrl', __sheetUrl);
        alert('Táblázat URL elmentve!');
        loadSheetUrl();
    } else {
        alert('Érvénytelen Google Táblázat URL!');
    }
}

function loadSheetUrl() {
    __sheetUrl = localStorage.getItem('sheetUrl');
    const urlInput = document.getElementById('sheetUrl');
    const statusContainer = document.getElementById('bankrollStatus');
    const urlContainer = document.getElementById('sheetUrlContainer');
    const bankrollHeader = document.getElementById('bankrollDisplay');
    
    if (__sheetUrl) {
        urlInput.value = __sheetUrl;
        urlContainer.style.display = 'none';
        statusContainer.style.display = 'block';
        bankrollHeader.style.display = 'block';
        updateBankrollStatus();
        if(document.querySelector('.tab-btn[data-tab="tab-history"]').classList.contains('active')) {
            loadHistory();
        }
    } else {
        urlContainer.style.display = 'block';
        statusContainer.style.display = 'none';
        bankrollHeader.style.display = 'none';
    }
}

async function updateBankrollStatus() {
    if (!__sheetUrl) return;
    const statusEl = document.getElementById('bankrollStatus');
    const bankrollValueEl = document.getElementById('bankrollValue');
    statusEl.innerHTML = `<p class="muted">Bankroll állapotának lekérése...</p>`;
    bankrollValueEl.textContent = '...';
    try {
        const response = await fetch(`${__gasUrl}?action=getBankroll&sheetUrl=${encodeURIComponent(__sheetUrl)}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        statusEl.innerHTML = `<p><strong>Profit/Veszteség:</strong> <span style="color:${data.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${data.pnl.toFixed(2)} e.</span></p><p><strong>ROI:</strong> <span style="font-weight:bold;">${data.roi.toFixed(1)}%</span></p>`;
        bankrollValueEl.textContent = `${data.bankroll.toFixed(2)} e.`;
    } catch(e) {
        const errorMsg = `Hiba: ${e.message}`;
        statusEl.innerHTML = `<p class="muted" style="color:var(--danger);">${errorMsg}</p>`;
        bankrollValueEl.textContent = 'Hiba';
    }
}

async function logBet(betData) {
    if (!__sheetUrl) { alert('Kérlek, add meg a Google Táblázat URL-jét a naplózáshoz!'); return; }
    const button = event.target;
    button.disabled = true;
    button.textContent = 'Naplózás...';
    try {
        await fetch(`${__gasUrl}`, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'logBet', sheetUrl: __sheetUrl, bet: betData })
        });
        button.textContent = 'Sikeresen Naplózva ✅';
        setTimeout(updateBankrollStatus, 1000);
    } catch (e) {
        alert(`Hiba a naplózás során: ${e.message}.`);
        button.textContent = 'Naplózás Sikertelen';
    }
}

function handleSportChange(){
    __currentSport=document.getElementById('sportSelector').value;
    document.getElementById('fixtures-list').innerHTML = '';
    __fixtures = [];
}

async function loadFixtures(){
    const listEl = document.getElementById('fixtures-list');
    const loadBtn = document.getElementById('loadFixturesBtn');
    listEl.innerHTML = '<p class="muted" style="text-align:center;">Adatok lekérése...</p>';
    loadBtn.disabled = true;
    try {
        const response = await fetch(`${__gasUrl}?action=getFixtures&sport=${__currentSport}&days=2`);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        __fixtures = data.fixtures || [];
        sessionStorage.setItem('openingOdds', JSON.stringify(data.odds || {}));

        const groupedByLeague = __fixtures.reduce((acc, fx) => {
            (acc[fx.league] = acc[fx.league] || []).push(fx);
            return acc;
        }, {});

        let html = '';
        for (const league in groupedByLeague) {
            // === ITT A JAVÍTÁS: A bajnokságok <details> elemekbe kerültek ===
            html += `<details>`;
            html += `<summary class="list-group-header">${league}</summary>`;
            groupedByLeague[league].forEach(fx => {
                const d = new Date(fx.utcKickoff).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' });
                html += `
                    <div class="list-item" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">
                        <div>
                            <div class="list-item-title">${escapeHtml(fx.home)} – ${escapeHtml(fx.away)}</div>
                            <div class="list-item-meta">${d}</div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:18px;height:18px; color: var(--muted);"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                `;
            });
            html += `</details>`;
        }
        listEl.innerHTML = html || '<p class="muted" style="text-align:center;">Nincs megjeleníthető mérkőzés.</p>';

    } catch (e) {
        listEl.innerHTML = `<p class="muted" style="color:var(--danger);">${e.message}</p>`;
    } finally {
        loadBtn.disabled = false;
    }
}

function fillAndAnalyze(home, away) {
    document.getElementById('home').value = home;
    document.getElementById('away').value = away;
    runAnalysis(true);
}

async function runAnalysis(forceNew = false) {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const resultsEl = document.getElementById('analysis-results');
    const placeholderEl = document.getElementById('placeholder');
    const skeletonEl = document.getElementById('loading-skeleton');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar-inner');
    const statusEl = document.getElementById('status');
    
    resultsEl.innerHTML = '';
    placeholderEl.style.display = 'none';
    skeletonEl.style.display = 'block';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    statusEl.textContent = '';

    if (!home || !away) {
        resultsEl.innerHTML = `<p style="color:var(--danger); text-align:center;">Hiba: Mindkét csapat nevét meg kell adni.</p>`;
        skeletonEl.style.display = 'none';
        progressContainer.style.display = 'none';
        placeholderEl.style.display = 'flex';
        return;
    }
    
    let progress = 0;
    const updateProgress = (val, text) => {
        progress = Math.max(progress, val);
        progressBar.style.width = `${progress}%`;
        statusEl.textContent = text;
    };

    try {
        updateProgress(5, "Elemzés indítása...");
        let analysisUrl = `${__gasUrl}?action=runAnalysis&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}&force=${forceNew}&sheetUrl=${encodeURIComponent(__sheetUrl)}`;
        const openingOdds = sessionStorage.getItem('openingOdds') || '{}';
        
        fetch(analysisUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ openingOdds: JSON.parse(openingOdds) }) });
        updateProgress(10, "Adatok lekérése a szerverről...");

        const interval = setInterval(() => {
            if (progress < 85) updateProgress(progress + Math.random() * 5, "AI elemzés és szimuláció futtatása...");
        }, 800);

        await new Promise(resolve => setTimeout(resolve, 9000));
        clearInterval(interval);
        updateProgress(90, "Válasz feldolgozása...");
        
        const resultResponse = await fetch(`${analysisUrl}&force=false`);
        if (!resultResponse.ok) throw new Error(`Szerver válasz hiba: ${resultResponse.status}`);
        
        const data = await resultResponse.json();
        if (data.error) throw new Error(data.error);

        updateProgress(100, "Kész.");
        resultsEl.innerHTML = `<div class="analysis-modal-body">${data.html}</div>`;
        if (__sheetUrl && document.querySelector('.tab-btn[data-tab="tab-history"]').classList.contains('active')) {
            loadHistory();
        }
        
    } catch (e) {
        resultsEl.innerHTML = `<p style="color:var(--danger); text-align:center;">Hiba: ${e.message}</p>`;
    } finally {
        skeletonEl.style.display = 'none';
        setTimeout(() => { progressContainer.style.display = 'none'; }, 2000);
    }
}

async function loadHistory() {
    if (!__sheetUrl) {
        document.getElementById('history').innerHTML = '<p class="muted">A napló funkcióhoz add meg a Google Táblázat URL-jét.</p>';
        return;
    }
    document.getElementById('history').innerHTML = '<p class="muted">Előzmények betöltése...</p>';
    try {
        const response = await fetch(`${__gasUrl}?action=getHistory&sheetUrl=${encodeURIComponent(__sheetUrl)}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        renderHistory(data.history);
    } catch(e) {
        document.getElementById('history').innerHTML = `<p class="muted" style="color:var(--danger)">Hiba a napló betöltésekor: ${e.message}</p>`;
    }
}

function filterHistory(allHistory) {
    const query = document.getElementById('historySearch').value.toLowerCase();
    const filtered = allHistory.filter(item =>
        (item.sport === __historySportFilter) &&
        (item.home.toLowerCase().includes(query) || item.away.toLowerCase().includes(query))
    );
    renderHistory(filtered, true);
}

function renderHistory(history, isFiltering = false) {
    const box = document.getElementById('history');

    if (!isFiltering) {
        sessionStorage.setItem('fullHistory', JSON.stringify(history));
    }
    
    const searchAndFilterHtml = `
        <input id="historySearch" placeholder="Keresés a naplóban..." oninput="filterHistory(JSON.parse(sessionStorage.getItem('fullHistory') || '[]'))" style="margin-bottom:0.8rem"/>
        <div class="sport-filter-container">
            <button class="sport-filter-btn ${__historySportFilter === 'soccer' ? 'active' : ''}" onclick="filterHistoryBySport('soccer', this)" title="Labdarúgás">⚽</button>
            <button class="sport-filter-btn ${__historySportFilter === 'hockey' ? 'active' : ''}" onclick="filterHistoryBySport('hockey', this)" title="Jégkorong">🏒</button>
            <button class="sport-filter-btn ${__historySportFilter === 'basketball' ? 'active' : ''}" onclick="filterHistoryBySport('basketball', this)" title="Kosárlabda">🏀</button>
        </div>
    `;

    if (!history || history.length === 0) {
        box.innerHTML = searchAndFilterHtml + '<p class="muted" style="text-align:center;">Nincsenek előzmények ebben a kategóriában.</p>';
        return;
    }

    const groupedByDate = history.reduce((acc, item) => {
        const dateKey = new Date(item.date).toISOString().split('T')[0];
        if (!acc[dateKey]) acc[dateKey] = [];
        acc[dateKey].push(item);
        return acc;
    }, {});

    let finalHtml = '';
    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

    for (const date of sortedDates) {
        finalHtml += `<details class="list-group-header" style="border:none; padding: 10px 0; font-size: 0.9rem;">`;
        finalHtml += `<summary style="color:var(--text-secondary); cursor:pointer;">${new Date(date).toLocaleDateString('hu-HU', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</summary>`;
        
        groupedByDate[date].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
            finalHtml += `
                <div class="list-item">
                    <div onclick="loadAnalysisFromHistory('${item.id}')" style="flex-grow:1;">
                        <div class="list-item-title">${escapeHtml(item.home)} – ${escapeHtml(item.away)}</div>
                        <div class="list-item-meta">${new Date(item.date).toLocaleTimeString('hu-HU', {hour:'2-digit', minute:'2-digit'})}</div>
                    </div>
                    <div style="display:flex;gap:5px">
                        <a href="#" class="action-icon" onclick="loadAnalysisFromHistory('${item.id}')" title="Elemzés Megtekintése"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></a>
                        <a href="#" class="action-icon delete" onclick="deleteHistoryItem('${item.id}')" title="Törlés"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></a>
                    </div>
                </div>
            `;
        });
        finalHtml += `</details>`;
    }
    box.innerHTML = searchAndFilterHtml + finalHtml;
}

function filterHistoryBySport(sport, btn) {
    __historySportFilter = sport;
    document.querySelectorAll('.sport-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterHistory(JSON.parse(sessionStorage.getItem('fullHistory') || '[]'));
}

async function loadAnalysisFromHistory(id){
    event.preventDefault();
    if (!__sheetUrl) return;
    const resultsEl = document.getElementById('analysis-results');
    const placeholderEl = document.getElementById('placeholder');
    const skeletonEl = document.getElementById('loading-skeleton');
    resultsEl.innerHTML = '';
    placeholderEl.style.display = 'none';
    skeletonEl.style.display = 'block';
    try {
        const response = await fetch(`${__gasUrl}?action=getAnalysisDetail&sheetUrl=${encodeURIComponent(__sheetUrl)}&id=${id}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        resultsEl.innerHTML = `<div class="analysis-modal-body">${data.record.html}</div>`;
    } catch(e) {
        resultsEl.innerHTML = `<p style="color:var(--danger); text-align:center;">Hiba az elemzés betöltésekor: ${e.message}</p>`;
    } finally {
        skeletonEl.style.display = 'none';
    }
}

async function deleteHistoryItem(id){
    event.preventDefault();
    if (!__sheetUrl || !confirm("Biztosan törölni szeretnéd ezt az elemet a központi naplóból?")) return;
    try {
        await fetch(`${__gasUrl}`, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'deleteHistoryItem', sheetUrl: __sheetUrl, id: id })
        });
        alert('Elem sikeresen törölve.');
        loadHistory();
    } catch(e) {
        alert(`Hiba a törlés során: ${e.message}`);
    }
}
</script>
</body>
</html>
