<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemz≈ë Gemini AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* CSS V√ÅLTOZ√ìK */
:root{--bg:#0b1020;--bg-grad-1:#0b1020;--bg-grad-2:#0a112a;--glass:#0f1730cc;--card:#0f172a;--border:#22304f;--muted:#a3b3d9;--primary:#4f46e5;--secondary:#14b8a6;--accent:#10b981;--ring:#14b8a6;--text:#e5e7eb;--font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family);color:var(--text);background:radial-gradient(1300px 600px at -10% -20%,rgba(20,184,166,.15),transparent 45%),radial-gradient(1100px 500px at 110% 120%,rgba(79,70,229,.15),transparent 50%),linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));min-height:100vh}
.app-header{background:linear-gradient(90deg,rgba(79,70,229,.95),rgba(20,184,166,.95));color:#fff;padding:1.1rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.1)}
.app-header h1{font-weight:800}
.user-info { font-size: 0.9rem; margin-top: 5px; opacity: 0.8; }
.container{max-width:1200px;margin:1.8rem auto;padding:0 1rem}
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)),var(--card);border:1px solid var(--border);border-radius:16px;padding:1.1rem;margin-bottom:1rem;box-shadow:0 20px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(6px)}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700;margin-top:0;color:#e5e7eb}
label{display:block;font-weight:600;margin-top:.6rem}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c1429;color:var(--text);margin-top:.25rem;font-size:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(20,184,166,.25)}
textarea{resize:vertical;min-height:80px}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 220px}
.actions{margin-top:1rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.actions button, .btn-primary {padding:12px 18px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;cursor:pointer;white-space:nowrap;box-shadow:0 12px 28px rgba(20,184,166,.35),0 4px 12px rgba(79,70,229,.25);width:100%;transition:transform .2s ease;font-family:var(--font-family); text-align: center;}
.actions button:hover:not(:disabled), .btn-primary:hover:not(:disabled) {transform:translateY(-2px)}
.actions button:disabled, .btn-primary:disabled {background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}

/* üü¢ LIG√ÅK (bubor√©kos) ST√çLUSA */
.league-list { margin-top: 0.8rem; }
.league-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding: 10px 12px; 
    font-size: 0.95rem; 
    margin-bottom: 8px;
    background: rgba(255,255,255,0.05); /* Enyhe √°ttetsz≈ë h√°tt√©r */
    border-radius: 10px; 
    border: 1px solid rgba(255,255,255,0.1); /* Finom keret */
    cursor: pointer; 
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Enyhe lebeg√©s */
}
.league-item:hover {
    background: rgba(255,255,255,0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
.league-item input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); }
.badge { background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

/* üî¥ MECCSEK (bubor√©kos) ST√çLUSA */
.fixtures { margin-top: 0.8rem; }
.fx-item { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: rgba(255,255,255,0.05); /* Enyhe √°ttetsz≈ë h√°tt√©r */
    border-radius: 12px; /* Nagyobb lekerek√≠t√©s */
    padding: 15px; 
    margin-bottom: 10px; 
    border: 1px solid rgba(255,255,255,0.15); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: transform 0.2s ease;
}
.fx-item:hover {
    transform: translateY(-2px);
    background: rgba(255,255,255,0.1);
}
.fx-title { font-weight: 700; font-size: 1.1rem; color: var(--text); }
.fx-meta { font-size: 0.8rem; color: var(--muted); margin-top: 4px; }

/* üîµ AI ELEMZ√âS GOMB ST√çLUSA */
.fx-btn { 
  background: linear-gradient(90deg, var(--accent), #10b981); /* √âl√©nk z√∂ld gradient */
  color: #0b1020; /* Fekete sz√∂veg a kontraszt miatt */
  border: none; 
  padding: 8px 14px; 
  border-radius: 10px; 
  font-size: 0.85rem; 
  font-weight: 800; 
  cursor: pointer; 
  transition: all 0.2s; 
  white-space: nowrap;
  box-shadow: 0 6px 15px rgba(16,185,129,0.4); /* Z√∂ld lebeg≈ë √°rny√©k */
}
.fx-btn:hover { background: var(--accent); color: #fff; transform: scale(1.05); } 


/* Statisztik√°k (megtartjuk a kor√°bbi jav√≠t√°st) */
.slip-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
.stat-item { text-align: center; background: #1a2441; padding: 15px 10px; border-radius: 8px; border: 1px solid var(--border); transition: transform 0.2s; }
.stat-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.stat-title { font-size: 0.85rem; color: var(--muted); font-weight: 600;}
.stat-value { font-weight: 800; font-size: 1.3rem; margin-top: 5px; color: var(--text); }
.stat-value.profit { color: var(--accent); }
.stat-value.loss { color: #ff6b6b; }


/* Nyithat√≥/z√°rhat√≥ elemek (megtartjuk a kor√°bbi jav√≠t√°st) */
.details-summary { display: flex; justify-content: space-between; align-items: center; cursor: pointer; list-style: none; padding: 5px 0;}
.details-summary::before { content: '‚ñ∂'; margin-right: 10px; font-size: 0.8em; color: var(--secondary); transition: transform 0.2s; }
details[open] > .details-summary::before { content: '‚ñº'; transform: rotate(90deg); }
.details-summary h2 { margin: 0; }
.details-summary::-webkit-details-marker { display: none; }

</style>
</head>
<body>
<header class="app-header">
    <h1>SportElemz≈ë Gemini AI</h1>
    <div id="userInfo" class="user-info">Adatok bet√∂lt√©se...</div>
</header>
<div class="container layout">
  <aside>
    <div class="card">
      <h2>Be√°ll√≠t√°sok</h2>
      <button class="btn-primary" style="margin-bottom: 1rem;" onclick="openSettingsModal()">Be√°ll√≠t√°sok Megnyit√°sa</button>
      
      <label for="sportSelector">Sport√°g</label>
      <select id="sportSelector" onchange="handleSportChange()">
          <option value="soccer" selected>Labdar√∫g√°s</option>
          <option value="hockey">J√©gkorong</option>
      </select>

       <label for="leagueSearch" style="margin-top: 1rem;">Keres√©s lig√°ban</label>
       <input id="leagueSearch" placeholder="pl. Premier, NHL..." />

      <div class="actions">
        <button onclick="loadFixtures()" style="background: var(--secondary); box-shadow: 0 12px 28px rgba(20,184,166,.35), 0 4px 12px rgba(20,184,166,.25);">Meccsek friss√≠t√©se az API-r√≥l</button>
        <button onclick="saveFavLeagues()">Kedvencek ment√©se a felh≈ëbe</button>
        <span id="fxStatus" class="muted"></span>
      </div>
      <div class="league-list" id="leagueList"></div>
    </div>
    
    <div class="card">
      <h2>K√∂zelg≈ë meccsek</h2>
      <div id="fixtures" class="fixtures"><p class="muted">V√°lassz sport√°gat √©s friss√≠ts!</p></div>
    </div>
  </aside>

  <main>
    <div class="card">
        <h2>Meccselemz√©s</h2>
        <datalist id="teamlist"></datalist>
        <div class="row">
          <div class="col">
            <label for="home">Hazai csapat</label>
            <input id="home" list="teamlist" placeholder="Pl. Liverpool" />
          </div>
          <div class="col">
            <label for="away">Vend√©g csapat</label>
            <input id="away" list="teamlist" placeholder="Pl. Manchester City" />
          </div>
        </div>
        <div class="row" style="margin-top: .7rem;">
          <div class="col">
            <label for="formWeight">Forma S√∫lyoz√°sa: <span id="formWeightLabel">50%</span></label>
            <input type="range" min="0" max="100" value="50" class="slider" id="formWeight">
          </div>
        </div>
        <div class="actions">
          <button id="goBtn" class="btn-primary" onclick="go()">Elemz√©s Futtat√°sa a Gemini AI-val</button>
        </div>
        <div id="progress" class="progress-ring" style="display:none;"><span class="progress-label"></span></div>
        <p id="status" class="muted" style="text-align:center;"></p>
    </div>

    <div id="out" class="card" style="min-height: 200px;"><p class="muted">A meccselemz√©s eredm√©nye itt jelenik meg.</p></div>
    
    <details class="card">
        <summary class="details-summary"><h2>Visszatesztel√©s</h2></summary>
        <p class="muted">R√©gebbi szezonok adatainak tesztel√©se (football-data.co.uk adatokkal).</p>
        <div class="row">
            <div class="col">
                <label for="backtestLeague">Liga k√≥d (pl. E0, I1, D1)</label>
                <input id="backtestLeague" placeholder="Pl. E0" value="E0" />
            </div>
            <div class="col">
                <label for="backtestSeason">Szezon k√≥d (Pl. 2324, 2223)</label>
                <input id="backtestSeason" placeholder="Pl. 2324" value="2324" />
            </div>
        </div>
        <div class="actions">
            <button id="runBacktestBtn" class="btn-primary" onclick="runBacktest()">Visszatesztel√©s Futtat√°sa</button>
        </div>
        <div id="backtestResult" style="margin-top: 1rem;"></div>
    </details>

    <details class="card">
        <summary class="details-summary"><h2>P√©nz√ºgyi Statisztik√°k</h2></summary>
        <div id="slipStats" style="min-height: 40px;"><p class="muted">Sz√°m√≠t√°s folyamatban...</p></div>
    </details>

    <details class="card">
        <summary class="details-summary"><h2>Fogad√°si Szelv√©ny</h2></summary>
        <div id="betSlip" style="margin-bottom: 1rem;"><p class="muted">A szelv√©ny √ºres.</p></div>
        <div id="slipEvaluation" style="display: none;">
            <h3>Eredm√©nyek Megad√°sa</h3>
            <div id="slipResultInputs" class="result-inputs"></div>
            <div class="actions">
                <button class="btn-primary" onclick="evaluateSlip()">Szelv√©ny √ârt√©kel√©se</button>
            </div>
        </div>
    </details>
    
    <details class="card">
      <summary class="details-summary"><h2>El≈ëz≈ë Elemz√©sek</h2></summary>
      <input id="historySearch" placeholder="Keres√©s az el≈ëz≈ë elemz√©sekben..." oninput="filterHistory()" style="margin-bottom: 0.8rem;" />
      <div id="history" class="history-list"><p class="muted">Nincsenek kor√°bbi elemz√©sek.</p></div>
    </details>
</main>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head"><div id="modalTitle" style="font-weight:800"></div><button class="modal-close" onclick="closeModal()">Bez√°r</button></div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
// --- A JAV√çTOTT JAVASCRIPT K√ìD ---
let __historyCache = [], __allLeagues = [], __favLeagues = new Set(), __fixtures = [], __masterTeamList = [], __gasUrl = '', __currentSport = 'soccer', __betSlip = [], __slipHistory = [], __user = { email: null, initialBankroll: 10000 };
let isSaving = false;

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);}
function setProgress(pct,msg=null){const el=document.getElementById('progress');const goBtn=document.getElementById('goBtn');const statusEl=document.getElementById('status');const v=Math.max(0,Math.min(100,Math.round(pct||0)));if(v>0&&v<100){el.style.display='grid';goBtn.disabled=true;}else{setTimeout(()=>{el.style.display='none';},250);goBtn.disabled=false;}el.style.background=`conic-gradient(var(--ring) ${v*3.6}deg, rgba(255,255,255,.18) 0deg)`;el.querySelector('.progress-label').textContent=v+'%';if(msg)statusEl.textContent=msg;}

document.addEventListener("DOMContentLoaded", async function() {
    __gasUrl = localStorage.getItem('gasUrl') || '';
    
    const formWeightSlider = document.getElementById('formWeight');
    const formWeightLabel = document.getElementById('formWeightLabel');
    const savedWeight = localStorage.getItem('formWeight') || '50';
    formWeightSlider.value = savedWeight;
    formWeightLabel.textContent = `${savedWeight}%`;
    formWeightSlider.addEventListener('input', (e) => { formWeightLabel.textContent = `${e.target.value}%`; localStorage.setItem('formWeight', e.target.value); });
    
    ['home', 'away'].forEach(id => document.getElementById(id).addEventListener('input', handleTeamInput));
    document.getElementById('leagueSearch').addEventListener('input', renderLeagueList);
    
    renderHistory(getHistoryFromLocalStorage());
    
    if (__gasUrl) {
      await loadUserDataFromCloud();
    } else {
      document.getElementById('userInfo').textContent = 'K√©rlek, add meg a backend URL-t a Be√°ll√≠t√°sokban.';
    }
});

async function loadUserDataFromCloud() {
    if (!__gasUrl) return;
    try {
        document.getElementById('userInfo').textContent = 'Felhaszn√°l√≥i adatok bet√∂lt√©se...';
        const response = await fetch(`${__gasUrl}?action=loadUserData`);
        if (!response.ok) throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        
        const data = await response.json();
        if (data.error) throw new Error(`Backend hiba: ${data.error}`);
        
        __user.email = data.userEmail;
        __user.initialBankroll = data.bankroll || 10000;
        __slipHistory = data.slipHistory || [];
        try { __favLeagues = new Set(JSON.parse(data.favLeagues || "[]")); } catch(e) { __favLeagues = new Set(); }

        document.getElementById('userInfo').textContent = `Bejelentkezve: ${__user.email}`;
        
        renderSlip();
        calculateStats();
        if(__allLeagues.length > 0) renderLeagueList();
        
    } catch (e) {
        document.getElementById('userInfo').textContent = `Hiba: ${e.message}. Ellen≈ërizd a backend URL-t √©s az enged√©lyeket.`;
        console.error(e);
    }
}

async function saveDataToCloud(dataObject) {
    if (!__gasUrl || isSaving) return;
    isSaving = true;
    try {
        let params = new URLSearchParams({ action: 'saveUserData' });
        for (const key in dataObject) {
            params.append(key, dataObject[key]);
        }
        const response = await fetch(`${__gasUrl}?${params.toString()}`);
        if (!response.ok) throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        const result = await response.json();
        if (result.error) throw new Error(`Backend hiba: ${result.error}`);
    } catch (e) {
        console.error("Hiba a felh≈ëbe ment√©s sor√°n:", e);
    } finally {
        isSaving = false;
    }
}

async function saveFavLeagues() {
    const favs = JSON.stringify(Array.from(__favLeagues));
    await saveDataToCloud({ favLeagues: favs });
    document.getElementById('fxStatus').textContent = 'Kedvencek elmentve a felh≈ëbe.';
}

function handleSportChange() { __currentSport = document.getElementById('sportSelector').value; document.getElementById('leagueList').innerHTML = '<p class="muted">Friss√≠ts a meccsek√©rt!</p>'; document.getElementById('fixtures').innerHTML = '<p class="muted">Friss√≠ts a meccsek√©rt!</p>'; document.getElementById('teamlist').innerHTML = ''; }
function updateDatalist(teamArray) { document.getElementById('teamlist').innerHTML = teamArray.map(t => `<option value="${escapeHtml(t)}"></option>`).join(''); }
function handleTeamInput(event) { const query = event.target.value.toLowerCase(); const filteredTeams = query ? __masterTeamList.filter(team => team.toLowerCase().includes(query)) : __masterTeamList; updateDatalist(filteredTeams); }
function populateTeams(fixtures){ const teams = new Set(); (fixtures || []).forEach(f => { teams.add(f.home); teams.add(f.away); }); __masterTeamList = Array.from(teams).sort((a,b)=>a.localeCompare(b,'hu')); updateDatalist(__masterTeamList); }
async function loadFixtures() {
    const statusEl = document.getElementById('fxStatus');
    statusEl.textContent = 'Adatok lek√©r√©se a szerverr≈ël...';
    if (!__gasUrl) { statusEl.textContent = 'Hiba: Hi√°nyzik a Google Apps Script URL.'; return; }
    try {
        const response = await fetch(`${__gasUrl}?sport=${__currentSport}`);
        if (!response.ok) throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(`Backend hiba: ${data.error}`);
        __allLeagues = data.leagues || []; __fixtures = data.fixtures || [];
        renderLeagueList(); renderFixtureList(); populateTeams(__fixtures);
        statusEl.textContent = `Sikeres friss√≠t√©s! ${__fixtures.length} meccs bet√∂ltve.`;
    } catch (e) { statusEl.textContent = `Hiba a friss√≠t√©s sor√°n: ${e.message}`; console.error(e); }
}
function renderLeagueList(){const box=document.getElementById('leagueList');const q=(document.getElementById('leagueSearch').value||'').toLowerCase();const list=(__allLeagues||[]).filter(x=>!q||x.name.toLowerCase().includes(q));box.innerHTML=list.map(x=>{const checked=__favLeagues.has(x.name)?'checked':'';return`<label class="league-item"><span><input type="checkbox" data-league="${escapeHtml(x.name)}" ${checked}/> ${escapeHtml(x.name)}</span><span class="badge">${x.count}</span></label>`;}).join('');box.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.addEventListener('change',e=>{const name=e.target.dataset.league;if(e.target.checked)__favLeagues.add(name);else __favLeagues.delete(name);renderFixtureList();});});}
function renderFixtureList(){const box=document.getElementById('fixtures');const fav=__favLeagues.size>0?new Set(__favLeagues):null;const list=(__fixtures||[]).filter(fx=>!fav||fav.has(fx.league));if(list.length===0){box.innerHTML=`<div class="muted">Nincs megjelen√≠thet≈ë meccs.</div>`;return;}box.innerHTML=list.map(fx=>{const local=new Date(fx.utcKickoff);const dt=`${local.getFullYear()}-${String(local.getMonth()+1).padStart(2,'0')}-${String(local.getDate()).padStart(2,'0')} ${String(local.getHours()).padStart(2,'0')}:${String(local.getMinutes()).padStart(2,'0')}`;return`<div class="fx-item" data-home="${escapeHtml(fx.home)}" data-away="${escapeHtml(fx.away)}"><div><div class="fx-title">${escapeHtml(fx.home)} ‚Äì ${escapeHtml(fx.away)}</div><div class="fx-meta">${escapeHtml(fx.league)} ¬∑ ${dt}</div></div><div><button class="fx-btn" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">AI elemz√©s</button></div></div>`;}).join('');}
function fillAndAnalyze(home,away){document.getElementById('home').value=home;document.getElementById('away').value=away;document.querySelector('main').scrollIntoView({behavior:'smooth'});go();}
function showSkeletonLoader(){const skeletonCard=`<div class="analysis-market"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text" style="width: 90%;"></div><div class="skeleton skeleton-text" style="width: 80%;"></div><div class="skeleton skeleton-bar" style="margin-top: 1rem;"></div></div>`;const skeletonHero=`<div class="hero"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text" style="width: 95%;"></div><div class="skeleton skeleton-text" style="width: 85%;"></div></div>`;document.getElementById('out').innerHTML=skeletonCard.repeat(3)+skeletonHero;}
async function go(){const home=document.getElementById("home").value.trim();const away=document.getElementById("away").value.trim();const formWeight=document.getElementById("formWeight").value;if(!home||!away||!__gasUrl){document.getElementById("status").textContent="Hiba: Hi√°nyz√≥ adatok vagy URL.";return;}let progressInterval;try{setProgress(1,"Elemz√©s ind√≠t√°sa...");showSkeletonLoader();const analysisUrl=`${__gasUrl}?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&formWeight=${formWeight}&sport=${__currentSport}`;progressInterval=setInterval(()=>{const currentPct=parseInt(document.querySelector('#progress .progress-label').textContent)||0;setProgress(Math.min(90,currentPct+2),"Szerver v√°lasz√°ra v√°runk...");},500);const response=await fetch(analysisUrl);clearInterval(progressInterval);if(!response.ok)throw new Error(`Szerver hiba: ${response.status}`);setProgress(95,"V√°lasz feldolgoz√°sa...");const data=await response.json();if(data.error)throw new Error(data.error);document.getElementById('out').innerHTML=data.html||'<p class="muted">A szerver nem k√ºld√∂tt elemz√©st.</p>';const record={timestamp:new Date().toISOString(),home,away,analysis:data.html};saveAnalysis(record);renderHistory(getHistoryFromLocalStorage());setProgress(100,"K√©sz.");}catch(e){if(progressInterval)clearInterval(progressInterval);document.getElementById("status").textContent="Hiba: "+e.message;document.getElementById("out").innerHTML=`<pre style="color: #ff5555;">Hiba t√∂rt√©nt: ${escapeHtml(e.message)}</pre>`;setProgress(0);}}
function saveAnalysis(record){let history=getHistoryFromLocalStorage();history.push(record);if(history.length>50)history=history.slice(history.length-50);localStorage.setItem("analysisHistory",JSON.stringify(history));}
function getHistoryFromLocalStorage(){try{return JSON.parse(localStorage.getItem("analysisHistory"))||[];}catch(_){return[];}}
function renderHistory(history){const box=document.getElementById("history");if(!history||!history.length){__historyCache=[];box.innerHTML='<p class="muted">Nincsenek kor√°bbi elemz√©sek.</p>';return;}const list=history.slice().sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));__historyCache=list;const fmt=iso=>{try{const d=new Date(iso);return d.toLocaleString('hu-HU',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch(_){return iso||'';}};box.innerHTML=list.map((item,i)=>{return`<details class="hist-item" data-idx="${i}"><summary class="details-summary"><div class="hist-title">${escapeHtml(item.home)} vs ${escapeHtml(item.away)}</div><div class="hist-date">${escapeHtml(fmt(item.timestamp))}</div></summary><div class="hist-body"><div class="hist-content">${item.analysis||''}</div><div class="hist-actions"><button class="hist-open" onclick="openHistoryModal(${i})">Megnyit√°s teljes n√©zetben</button></div></div></details>`;}).join('');}
function filterHistory(){const query=document.getElementById('historySearch').value.toLowerCase();document.querySelectorAll('#history .hist-item').forEach(item=>{const title=item.querySelector('.hist-title').textContent.toLowerCase();item.style.display=title.includes(query)?'':'none';});}
function openHistoryModal(idx){const item=__historyCache[idx];if(!item)return;document.getElementById('modalTitle').textContent=`${item.home} vs ${item.away}`;document.getElementById('modalBody').innerHTML=item.analysis||'';document.getElementById('modal').classList.add('open');}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function openSettingsModal(){document.getElementById('modalTitle').textContent='Be√°ll√≠t√°sok';const body=document.getElementById('modalBody');body.innerHTML=`<label for="gasUrlModal">Google Apps Script URL</label><textarea id="gasUrlModal" placeholder="Illessze be a k√∂zz√©tett backend script URL-j√©t..." style="min-height: 120px;">${__gasUrl}</textarea><label for="bankrollModal">Kezd≈ë Bankroll</label><input type="number" id="bankrollModal" placeholder="Kezd≈ë t≈ëke..." value="${__user.initialBankroll}" style="margin-bottom: 1rem;"><button class="btn-primary" onclick="saveSettings()">Ment√©s √©s bez√°r√°s</button>`;document.getElementById('modal').classList.add('open');}
async function saveSettings(){
    const newUrl = document.getElementById('gasUrlModal').value.trim();
    const newBankroll = parseFloat(document.getElementById('bankrollModal').value) || 10000;
    
    __gasUrl = newUrl;
    localStorage.setItem('gasUrl', newUrl); 
    __user.initialBankroll = newBankroll;
    await saveDataToCloud({ bankroll: newBankroll });
    
    closeModal();
    calculateStats();
    document.getElementById('fxStatus').textContent='Be√°ll√≠t√°sok elmentve.';
    
    await loadUserDataFromCloud();
}
function addToSlip(match,market,selection,odds,ourProb){const betId = `${match}-${selection}`;if (__betSlip.some(bet => bet.id.startsWith(match))) {alert('Ebb≈ël a meccsb≈ël m√°r van egy tipp a szelv√©nyen!');return;}const bet={id:betId,match,market,selection,odds,ourProb};__betSlip.push(bet);renderSlip();}
function removeBet(index){if(!confirm('Biztosan t√∂rl√∂d ezt a tippet a szelv√©nyr≈ël?')) return;__betSlip.splice(index,1);renderSlip();}
function renderSlip(){const container=document.getElementById('betSlip');const evaluationContainer=document.getElementById('slipEvaluation');const resultInputsContainer=document.getElementById('slipResultInputs');if(__betSlip.length === 0){container.innerHTML = '<p class="muted">A szelv√©ny √ºres. Kattints a \'+\' gombra egy tipp hozz√°ad√°s√°hoz.</p>';evaluationContainer.style.display = 'none';return;}let slipHTML = __betSlip.map((bet,index) => `<div class="slip-item"><div class="slip-item-header"><div><div class="slip-title">${escapeHtml(bet.match)}</div><div class="slip-market">${escapeHtml(bet.market)}</div></div><button onclick="removeBet(${index})" style="background:transparent; border:none; color: #ff6b6b; font-size: 24px; cursor:pointer;">&times;</button></div><div class="slip-details">${escapeHtml(bet.selection)} @ ${bet.odds}</div></div>`).join('');const totalOdds = __betSlip.reduce((acc, bet) => acc * bet.odds, 1);const potentialWinnings = (parseFloat(document.getElementById('comboStake')?.value) || 0) * totalOdds;slipHTML += `<div class="slip-summary-card"><div class="summary-row"><span>Esem√©nyek sz√°ma:</span><strong>${__betSlip.length}</strong></div><div class="summary-row"><span>Ered≈ë Odds:</span><strong>${totalOdds.toFixed(2)}</strong></div><div class="summary-row"><label for="comboStake">Teljes T√©t:</label><input type="number" id="comboStake" placeholder="0" oninput="renderSlip()" value="${document.getElementById('comboStake')?.value || 0}"></div><hr style="border-color: var(--border); margin: 1rem 0;"><div class="summary-row"><span>V√°rhat√≥ Nyerem√©ny:</span><strong>${potentialWinnings.toFixed(2)}</strong></div></div>`;container.innerHTML = slipHTML;const uniqueMatches = [...new Map(__betSlip.map(bet => [bet.match, bet])).values()];resultInputsContainer.innerHTML = uniqueMatches.map((bet, index) => `<div class="slip-item"><div class="slip-title">${escapeHtml(bet.match)}</div><div class="slip-results-input-grid"><label>Hazai</label><span>-</span><label>Vend√©g</label><input type="number" id="home-score-${index}" placeholder="H" size="2"><span></span><input type="number" id="away-score-${index}" placeholder="V" size="2"></div></div>`).join('');evaluationContainer.style.display = 'block';}
async function evaluateSlip() {
    const stake = parseFloat(document.getElementById('comboStake').value);
    if (isNaN(stake) || stake <= 0) { alert('K√©rlek, adj meg √©rv√©nyes t√©tet!'); return; }
    const uniqueMatches = [...new Map(__betSlip.map(bet => [bet.match, bet])).values()];
    const results = {};
    let allScoresEntered = true;
    uniqueMatches.forEach((bet, index) => { const homeScore = parseInt(document.getElementById(`home-score-${index}`).value); const awayScore = parseInt(document.getElementById(`away-score-${index}`).value); if (isNaN(homeScore) || isNaN(awayScore)) {allScoresEntered = false;} results[bet.match] = { home: homeScore, away: awayScore }; });
    if (!allScoresEntered) { alert('K√©rlek, add meg az √∂sszes meccs eredm√©ny√©t!'); return; }
    let isSlipWinner = true;
    for (const bet of __betSlip) {
        const result = results[bet.match];
        const homeScore = result.home, awayScore = result.away, totalGoals = homeScore + awayScore;
        let isBetWinner = false;
        if (bet.market.includes('1X2') || bet.market.includes('MONEYLINE')) { if (bet.selection === 'Hazai' && homeScore > awayScore) isBetWinner = true; else if (bet.selection === 'D√∂ntetlen' && homeScore === awayScore) isBetWinner = true; else if (bet.selection === 'Vend√©g' && awayScore > homeScore) isBetWinner = true;
        } else if (bet.market.includes('G√ìLOK')) { const pointMatch = bet.selection.match(/[\d\.]+/); const point = pointMatch ? parseFloat(pointMatch[0]) : 0; if (bet.selection.includes('Over') && totalGoals > point) isBetWinner = true; else if (bet.selection.includes('Under') && totalGoals < point) isBetWinner = true;
        } else if (bet.market.includes('BTTS')) { if(bet.selection === 'Igen' && homeScore > 0 && awayScore > 0) isBetWinner = true; else if (bet.selection === 'Nem' && (homeScore === 0 || awayScore === 0)) isBetWinner = true;
        }
        if (!isBetWinner) { isSlipWinner = false; break; }
    }
    const totalOdds = __betSlip.reduce((acc, bet) => acc * bet.odds, 1);
    const profit = isSlipWinner ? (stake * totalOdds) - stake : -stake;
    const slipRecord = { id: new Date().toISOString(), bets: [...__betSlip], stake: stake, totalOdds: totalOdds, status: isSlipWinner ? 'win' : 'loss', profit: profit };
    __slipHistory.push(slipRecord);
    await saveDataToCloud({ slipHistory: JSON.stringify(__slipHistory) });
    alert(`A szelv√©ny ${isSlipWinner ? 'NYERT' : 'VESZTETT'}! Profit: ${profit.toFixed(2)}`);
    __betSlip = [];
    renderSlip();
    calculateStats();
}

function calculateStats() {
    const initialBankroll = __user.initialBankroll;
    const totalProfit = __slipHistory.reduce((acc, slip) => acc + slip.profit, 0);
    const currentBankroll = initialBankroll + totalProfit;
    const totalSlips = __slipHistory.length;
    const winningSlips = __slipHistory.filter(s => s.status === 'win').length;
    const winRate = totalSlips > 0 ? (winningSlips / totalSlips * 100).toFixed(1) : 0;
    
    // DYNAMIC STATS RENDERING JAV√çTVA A K√âRT DIZ√ÅJNHOZ
    const profitColor = totalProfit >= 0 ? 'profit' : 'loss';
    document.getElementById('slipStats').innerHTML = `
        <div class="slip-stats">
            <div class="stat-item">
                <div class="stat-title">Kezd≈ë Bankroll</div>
                <div class="stat-value">${initialBankroll.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Aktu√°lis Bankroll</div>
                <div class="stat-value ${currentBankroll >= initialBankroll ? 'profit' : 'loss'}">${currentBankroll.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Teljes Profit</div>
                <div class="stat-value ${profitColor}">${totalProfit.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Tal√°lati Ar√°ny</div>
                <div class="stat-value">${winRate}% (${winningSlips}/${totalSlips})</div>
            </div>
        </div>
    `;
}

async function runBacktest() {
    const league = document.getElementById('backtestLeague').value;
    const season = document.getElementById('backtestSeason').value;
    const formWeight = document.getElementById('formWeight').value;
    const resultDiv = document.getElementById('backtestResult');
    const goBtn = document.getElementById('runBacktestBtn');
    if (!__gasUrl) { resultDiv.innerHTML = `<p style="color: #ff5555;">Hiba: Hi√°nyzik a Google Apps Script URL.</p>`; return; }
    try {
        resultDiv.innerHTML = '<p class="muted">Visszatesztel√©s futtat√°sa... Ez t√∂bb percig is eltarthat. K√©rlek, l√©gy t√ºrelemmel.</p>';
        goBtn.disabled = true;
        const backtestUrl = `${__gasUrl}?action=runBacktest&league=${league}&season=${season}&formWeight=${formWeight}`;
        const response = await fetch(backtestUrl);
        if (!response.ok) throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(`Backend hiba: ${data.error}`);
        const profitColor = data.totalProfit >= 0 ? 'var(--accent)' : '#ff6b6b';
        resultDiv.innerHTML = `<div class="slip-summary-card"><div class="summary-row"><span>Tesztelt Szezon:</span> <strong>${season.substring(0,2)}/${season.substring(2,4)}</strong></div><hr style="border-color: var(--border); margin: 1rem 0;"><div class="summary-row"><span>√ñsszes Meccs:</span> <strong>${data.totalMatches}</strong></div><div class="summary-row"><span>√ârt√©kalap√∫ Fogad√°sok:</span> <strong>${data.betsPlaced}</strong></div><div class="summary-row"><span>Nyertes Fogad√°sok:</span> <strong>${data.betsWon}</strong></div><div class="summary-row"><span>Tal√°lati Ar√°ny:</span> <strong>${data.winRate}%</strong></div><div class="summary-row"><span>Teljes Profit:</span> <strong style="color:${profitColor};">${data.totalProfit.toFixed(2)} egys√©g</strong></div><div class="summary-row"><span>ROI (megt√©r√ºl√©s):</span> <strong style="color:${profitColor};">${data.roi}%</strong></div></div>`;
    } catch (e) {
        resultDiv.innerHTML = `<p style="color: #ff5555;">Hiba a visszatesztel√©s sor√°n: ${escapeHtml(e.message)}</p>`;
    } finally {
        goBtn.disabled = false;
    }
}
</script>
</body>
</html>
