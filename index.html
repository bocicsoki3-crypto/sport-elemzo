<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemző Gemini AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1020;--bg-grad-1:#0b1020;--bg-grad-2:#0a112a;--glass:#0f1730cc;--card:#0f172a;--border:#22304f;--muted:#a3b3d9;--primary:#4f46e5;--secondary:#14b8a6;--accent:#10b981;--ring:#14b8a6;--text:#e5e7eb;--font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family);color:var(--text);background:radial-gradient(1300px 600px at -10% -20%,rgba(20,184,166,.15),transparent 45%),radial-gradient(1100px 500px at 110% 120%,rgba(79,70,229,.15),transparent 50%),linear-gradient(180deg,var(--bg-grad-1),var(--bg-grad-2));min-height:100vh}
.app-header{background:linear-gradient(90deg,rgba(79,70,229,.95),rgba(20,184,166,.95));color:#fff;padding:1.1rem;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.1)}
.app-header h1{font-weight:800}
.container{max-width:1200px;margin:1.8rem auto;padding:0 1rem}
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0)),var(--card);border:1px solid var(--border);border-radius:16px;padding:1.1rem;margin-bottom:1rem;box-shadow:0 20px 40px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(6px)}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700;margin-top:0;color:#e5e7eb}
label{display:block;font-weight:600;margin-top:.6rem}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c1429;color:var(--text);margin-top:.25rem;font-size:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(20,184,166,.25)}
textarea{resize:vertical;min-height:80px}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 220px}
.actions{margin-top:1rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.actions button, .btn-primary {padding:12px 18px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;font-weight:800;cursor:pointer;white-space:nowrap;box-shadow:0 12px 28px rgba(20,184,166,.35),0 4px 12px rgba(79,70,229,.25);width:100%;transition:transform .2s ease;font-family:var(--font-family); text-align: center;}
.actions button:hover:not(:disabled), .btn-primary:hover:not(:disabled) {transform:translateY(-2px)}
.actions button:disabled, .btn-primary:disabled {background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
.league-list{display:flex;flex-direction:column;gap:10px;max-height:360px;overflow:auto;margin-top:8px}
.league-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:#0d1127;cursor:pointer;transition:background-color .2s}
.league-item:hover{background-color:#132042}
.league-item input{width:auto;margin:0 8px 0 0}
.badge{display:inline-block;padding:5px 12px;border-radius:999px;background:#121a36;border:1px solid rgba(255,255,255,.08);font-size:.86rem;color:#cfe6ff}
.fixtures{max-height:520px;overflow:auto;margin-top:6px;display:flex;flex-direction:column;gap:10px}
.fx-item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#0d1127;display:flex;justify-content:space-between;align-items:center;gap:8px}
.fx-title{font-weight:800}.fx-meta{font-size:.9rem;color:#cfe6ff}
.fx-btn{padding:9px 12px;border:1px solid var(--border);background:#132042;color:#e5e7eb;border-radius:12px;cursor:pointer;transition:border-color .2s;font-family:var(--font-family)}
.fx-btn:hover{border-color:var(--secondary)}
.progress-wrap{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.progress-ring{width:42px;height:42px;border-radius:50%;background:conic-gradient(var(--ring) 0deg,rgba(255,255,255,.18) 0deg);display:none;place-items:center;position:relative}
.progress-ring::before{content:"";position:absolute;inset:6px;border-radius:50%;background:#0c1429}
.progress-label{position:relative;font-size:12px;color:#e5e7eb}
details.card > summary{display:flex;align-items:center;gap:10px;cursor:pointer;list-style:none}
details.card > summary::-webkit-details-marker{display:none}
.chev{display:inline-block;transition:transform .2s;opacity:.95}
details[open] .chev{transform:rotate(90deg)}
.modal{position:fixed;inset:0;background:rgba(6,10,22,.65);display:none;align-items:center;justify-content:center;z-index:50;backdrop-filter:blur(4px)}
.modal.open{display:flex}
.modal-card{width:min(980px,92vw);max-height:85vh;overflow:auto;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.55)}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:blur(6px)}
.modal-body{padding:16px}
.modal-close{background:#1b294d;color:#fff;border:1px solid var(--border);border-radius:12px;padding:8px 12px;cursor:pointer;font-family:var(--font-family)}
.slider-container label{display:flex;justify-content:space-between;align-items:center;font-weight:600}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:8px;background:#1a2445;border-radius:5px;outline:none;margin-top:.5rem}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:var(--secondary);cursor:pointer;border-radius:50%;border:3px solid var(--card)}
input[type=range]::-moz-range-thumb{width:20px;height:20px;background:var(--secondary);cursor:pointer;border-radius:50%;border:3px solid var(--card)}
.analysis-market{margin-bottom:1.1rem;padding:1rem;border:1px solid var(--border);border-radius:14px;background:#0d1127}
.market-summary{margin:.35rem 0 1rem 0;color:#cfe6ff;opacity:.95;line-height:1.6}
.analysis-option{background:rgba(255,255,255,.02);border-radius:12px;padding:.7rem;margin-bottom:.5rem; position: relative;}
.option-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;gap:12px;flex-wrap:wrap}
.option-label{font-weight:600}.option-meta{font-size:.95rem;color:#d6daff;opacity:.95}
.option-bar-wrap{position:relative;background:#1a2445;border-radius:12px;height:18px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(255,255,255,.05)}
.option-badge{position:absolute;z-index:2;left:8px;top:50%;transform:translateY(-50%);padding:2px 10px;font-size:.78rem;color:#fff;background:var(--primary);border-radius:999px;line-height:1.2;font-weight:600}
.option-bar{position:absolute;inset:0;width:0%;height:100%;background:var(--accent);border-radius:12px;transition:width .35s}
.hero{margin-top:12px;padding:16px;border-radius:16px;background:radial-gradient(1200px 600px at 10% -20%,rgba(20,184,166,.14),transparent 40%),radial-gradient(1200px 600px at 110% 120%,rgba(79,70,229,.14),transparent 40%),#0b1026;border:1px solid #22304f}
.hero.positive{border-color:#10b981;box-shadow:0 0 24px rgba(16,185,129,.25)}
.tag{display:inline-block;background:#121a36;color:#cfe6ff;border:1px solid rgba(255,255,255,.1);border-radius:999px;padding:7px 12px;font-size:.88rem;margin-right:6px;margin-bottom:6px}
.metrics{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:12px}
.xg-card{background:#0d1127;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
.xg-row{display:flex;align-items:center;gap:12px;margin:8px 0}
.xg-team{flex:0 0 160px;opacity:.95;font-weight:600}
.xg-bar{flex:1;background:#1a2445;height:10px;border-radius:999px;position:relative;overflow:hidden}
.xg-fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .35s}
.xg-val{flex:0 0 54px;text-align:right;font-weight:800}
.hist-item{border:1px solid var(--border);background:#0d1127;border-radius:12px;margin:.6rem 0}
.hist-item > summary{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:.85rem 1rem;cursor:pointer}
.hist-title{font-weight:800}.hist-date{color:#98a5cc;font-size:.95rem}
.hist-body{padding:.5rem 1rem 1rem}
.hist-open{padding:9px 12px;border:1px solid var(--border);background:#132042;color:#e5e7eb;border-radius:12px;cursor:pointer;font-family:var(--font-family)}
.add-to-slip-btn { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: var(--accent); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: background-color 0.2s; }
.add-to-slip-btn:hover { background: #12cca4; }
.slip-item { background: #0d1127; border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-bottom: 0.5rem; }
.slip-item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;}
.slip-title { font-weight: 800; margin-bottom: 0.2rem; }
.slip-market { font-size: 0.9rem; color: var(--muted); }
.slip-details { font-weight: 600; }
.slip-summary-card { background: #0c1429; border: 1px solid var(--primary); border-radius: 12px; padding: 1rem; margin-top: 1rem; }
.summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; font-size: 1.1rem; }
.summary-row strong { color: var(--secondary); font-size: 1.2rem; }
.summary-row input { width: 120px; text-align: right; }
.slip-stats { display: flex; justify-content: space-around; text-align: center; margin-top: 1rem; flex-wrap: wrap;}
.stat-item { padding: 0.5rem; }
.stat-title { font-size: 0.9rem; color: var(--muted); }
.stat-value { font-size: 1.5rem; font-weight: 800; }
.stat-value.profit { color: var(--accent); }
.stat-value.loss { color: #ff6b6b; }
.slip-results-input-grid { margin-top: 0.5rem; display: grid; grid-template-columns: 1fr auto 1fr; gap: 5px; align-items: center; text-align: center;}
.slip-results-input-grid label { font-size: 0.9rem; margin: 0; }
</style>
</head>
<body>
<header class="app-header"><h1>SportElemző Gemini AI</h1></header>
<div class="container layout">
  <aside>
    <div class="card">
      <h2>Beállítások</h2>
      <button class="btn-primary" style="margin-bottom: 1rem;" onclick="openSettingsModal()">Beállítások Megnyitása</button>
      
      <label for="sportSelector">Sportág</label>
      <select id="sportSelector" onchange="handleSportChange()">
          <option value="soccer" selected>Labdarúgás</option>
          <option value="hockey">Jégkorong</option>
      </select>

       <label for="leagueSearch" style="margin-top: 1rem;">Keresés ligában</label>
       <input id="leagueSearch" placeholder="pl. Premier, NHL..." />

      <div class="actions">
        <button onclick="loadFixtures()">Meccsek frissítése az API-ról</button>
        <button onclick="saveFavLeagues()">Kedvencek mentése</button>
        <span id="fxStatus" class="muted"></span>
      </div>
      <div class="league-list" id="leagueList"></div>
    </div>
    
    <div class="card">
      <h2>Közelgő meccsek</h2>
      <div id="fixtures" class="fixtures"><p class="muted">Válassz sportágat és frissíts!</p></div>
    </div>
  </aside>

  <main>
    <div class="card">
      <h2>Mérkőzés adatainak megadása</h2>
      <div class="row">
        <div class="col"><label for="home">Hazai csapat</label><input id="home" list="teamlist" placeholder="pl. Hazai csapat neve" /></div>
        <div class="col"><label for="away">Vendég csapat</label><input id="away" list="teamlist" placeholder="pl. Vendég csapat neve" /></div>
      </div>
      <datalist id="teamlist"></datalist>
      <div class="slider-container" style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
        <label for="formWeight"><span>Forma Súlyozás</span><span id="formWeightLabel">50%</span></label>
        <input type="range" id="formWeight" min="0" max="100" value="50">
      </div>
      <div class="actions progress-wrap">
        <button id="goBtn" onclick="go()">Meccselemzés kérése a szerverről</button>
        <div id="progress" class="progress-ring"><span class="progress-label">0%</span></div>
        <span id="status" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:.4rem">Tipp: a bal oldali meccslistából kattintva automatikusan kitöltöm és elemzem.</p>
    </div>
    <div class="card">
      <h2>AI elemzés és javaslat</h2>
      <div id="out" class="result"><pre class="muted">Az AI elemzés itt fog megjelenni… Add meg a backend URL-t, frissítsd a meccseket, válassz egyet, majd kattints az elemzés gombra.</pre></div>
    </div>
    <details class="card" open>
        <summary><span class="chev">▶</span><h2 style="margin:0">Gyűjtő Szelvény</h2></summary>
        <div id="slipStats" style="border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1rem;"></div>
        <div id="betSlipContainer">
            <div id="betSlip">
                <p class="muted">A szelvény üres. Kattints a '+' gombra egy tipp hozzáadásához.</p>
            </div>
            <div id="slipEvaluation" style="display: none;">
                <h4>Eredmények megadása</h4>
                <div id="slipResultInputs"></div>
                <button class="btn-primary" style="margin-top: 1rem;" onclick="evaluateSlip()">Szelvény Kiértékelése</button>
            </div>
        </div>
    </details>
    <details class="card" id="histDetails">
      <summary><span class="chev">▶</span><h2 style="margin:0">Korábbi elemzések</h2></summary>
      <input id="historySearch" oninput="filterHistory()" placeholder="Keresés az előzményekben..." style="margin-top: 1rem; margin-bottom: 0.5rem;" />
      <div id="history" style="margin-top:10px"><p class="muted">Betöltés…</p></div>
    </details>
  </main>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head"><div id="modalTitle" style="font-weight:800"></div><button class="modal-close" onclick="closeModal()">Bezár</button></div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
let __historyCache = [], __allLeagues = [], __favLeagues = new Set(), __fixtures = [], __masterTeamList = [], __gasUrl = '', __currentSport = 'soccer', __betSlip = [], __slipHistory = [], __bankroll = 10000;

function escapeHtml(s){return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);}
function setProgress(pct,msg=null){const el=document.getElementById('progress');const goBtn=document.getElementById('goBtn');const statusEl=document.getElementById('status');const v=Math.max(0,Math.min(100,Math.round(pct||0)));if(v>0&&v<100){el.style.display='grid';goBtn.disabled=true;}else{setTimeout(()=>{el.style.display='none';},250);goBtn.disabled=false;}el.style.background=`conic-gradient(var(--ring) ${v*3.6}deg, rgba(255,255,255,.18) 0deg)`;el.querySelector('.progress-label').textContent=v+'%';if(msg)statusEl.textContent=msg;}

document.addEventListener("DOMContentLoaded", function(){
    __gasUrl = localStorage.getItem('gasUrl') || '';
    __bankroll = parseFloat(localStorage.getItem('bankroll')) || 10000;
    const formWeightSlider = document.getElementById('formWeight');
    const formWeightLabel = document.getElementById('formWeightLabel');
    const savedWeight = localStorage.getItem('formWeight') || '50';
    formWeightSlider.value = savedWeight;
    formWeightLabel.textContent = `${savedWeight}%`;
    formWeightSlider.addEventListener('input', (e) => { formWeightLabel.textContent = `${e.target.value}%`; localStorage.setItem('formWeight', e.target.value); });
    ['home', 'away'].forEach(id => document.getElementById(id).addEventListener('input', handleTeamInput));
    document.getElementById('leagueSearch').addEventListener('input', renderLeagueList);
    renderHistory(getHistory());
    loadSlip();
    loadSlipHistory();
    const favsRaw = localStorage.getItem("favLeagues") || "[]";
    try { __favLeagues = new Set(JSON.parse(favsRaw)); } catch(_) { __favLeagues = new Set(); }
});

function handleSportChange() { __currentSport = document.getElementById('sportSelector').value; document.getElementById('leagueList').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>'; document.getElementById('fixtures').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>'; document.getElementById('teamlist').innerHTML = ''; }
function updateDatalist(teamArray) { document.getElementById('teamlist').innerHTML = teamArray.map(t => `<option value="${escapeHtml(t)}"></option>`).join(''); }
function handleTeamInput(event) { const query = event.target.value.toLowerCase(); const filteredTeams = query ? __masterTeamList.filter(team => team.toLowerCase().includes(query)) : __masterTeamList; updateDatalist(filteredTeams); }
function populateTeams(fixtures){ const teams = new Set(); (fixtures || []).forEach(f => { teams.add(f.home); teams.add(f.away); }); __masterTeamList = Array.from(teams).sort((a,b)=>a.localeCompare(b,'hu')); updateDatalist(__masterTeamList); }

async function loadFixtures() {
    const statusEl = document.getElementById('fxStatus');
    statusEl.textContent = 'Adatok lekérése a szerverről...';
    if (!__gasUrl) { statusEl.textContent = 'Hiba: Hiányzik a Google Apps Script URL.'; return; }
    try {
        const response = await fetch(`${__gasUrl}?sport=${__currentSport}`);
        if (!response.ok) throw new Error(`Hálózati hiba: ${response.status}`);
        const data = await response.json();
        if (data.error) throw new Error(`Backend hiba: ${data.error}`);
        __allLeagues = data.leagues || []; __fixtures = data.fixtures || [];
        renderLeagueList(); renderFixtureList(); populateTeams(__fixtures);
        statusEl.textContent = `Sikeres frissítés! ${__fixtures.length} meccs betöltve.`;
    } catch (e) { statusEl.textContent = `Hiba a frissítés során: ${e.message}`; console.error(e); }
}

function renderLeagueList(){const box=document.getElementById('leagueList');const q=(document.getElementById('leagueSearch').value||'').toLowerCase();const list=(__allLeagues||[]).filter(x=>!q||x.name.toLowerCase().includes(q));box.innerHTML=list.map(x=>{const checked=__favLeagues.has(x.name)?'checked':'';return`<label class="league-item"><span><input type="checkbox" data-league="${escapeHtml(x.name)}" ${checked}/> ${escapeHtml(x.name)}</span><span class="badge">${x.count}</span></label>`;}).join('');box.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.addEventListener('change',e=>{const name=e.target.dataset.league;if(e.target.checked)__favLeagues.add(name);else __favLeagues.delete(name);renderFixtureList();});});}
function saveFavLeagues(){localStorage.setItem("favLeagues",JSON.stringify(Array.from(__favLeagues)));document.getElementById('fxStatus').textContent='Kedvencek elmentve.';}
function renderFixtureList(){const box=document.getElementById('fixtures');const fav=__favLeagues.size>0?new Set(__favLeagues):null;const list=(__fixtures||[]).filter(fx=>!fav||fav.has(fx.league));if(list.length===0){box.innerHTML=`<div class="muted">Nincs megjeleníthető meccs.</div>`;return;}box.innerHTML=list.map(fx=>{const local=new Date(fx.utcKickoff);const dt=`${local.getFullYear()}-${String(local.getMonth()+1).padStart(2,'0')}-${String(local.getDate()).padStart(2,'0')} ${String(local.getHours()).padStart(2,'0')}:${String(local.getMinutes()).padStart(2,'0')}`;return`<div class="fx-item" data-home="${escapeHtml(fx.home)}" data-away="${escapeHtml(fx.away)}"><div><div class="fx-title">${escapeHtml(fx.home)} – ${escapeHtml(fx.away)}</div><div class="fx-meta">${escapeHtml(fx.league)} · ${dt}</div></div><div><button class="fx-btn" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">AI elemzés</button></div></div>`;}).join('');}
function fillAndAnalyze(home,away){document.getElementById('home').value=home;document.getElementById('away').value=away;document.querySelector('main').scrollIntoView({behavior:'smooth'});go();}
function showSkeletonLoader(){const skeletonCard=`<div class="analysis-market"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text" style="width: 90%;"></div><div class="skeleton skeleton-text" style="width: 80%;"></div><div class="skeleton skeleton-bar" style="margin-top: 1rem;"></div></div>`;const skeletonHero=`<div class="hero"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-text" style="width: 95%;"></div><div class="skeleton skeleton-text" style="width: 85%;"></div></div>`;document.getElementById('out').innerHTML=skeletonCard.repeat(3)+skeletonHero;}

async function go(){
    const home=document.getElementById("home").value.trim();
    const away=document.getElementById("away").value.trim();
    const formWeight=document.getElementById("formWeight").value;
    if(!home||!away||!__gasUrl){document.getElementById("status").textContent="Hiba: Hiányzó adatok vagy URL.";return;}
    let progressInterval;
    try{
        setProgress(1,"Elemzés indítása...");
        showSkeletonLoader();
        const analysisUrl=`${__gasUrl}?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&formWeight=${formWeight}&sport=${__currentSport}`;
        progressInterval=setInterval(()=>{const currentPct=parseInt(document.querySelector('#progress .progress-label').textContent)||0;setProgress(Math.min(90,currentPct+2),"Szerver válaszára várunk...");},500);
        const response=await fetch(analysisUrl);
        clearInterval(progressInterval);
        if(!response.ok)throw new Error(`Szerver hiba: ${response.status}`);
        setProgress(95,"Válasz feldolgozása...");
        const data=await response.json();
        if(data.error)throw new Error(data.error);
        document.getElementById('out').innerHTML=data.html||'<p class="muted">A szerver nem küldött elemzést.</p>';
        const record={timestamp:new Date().toISOString(),home,away,analysis:data.html};
        saveAnalysis(record);
        renderHistory(getHistory());
        setProgress(100,"Kész.");
    }catch(e){
        if(progressInterval)clearInterval(progressInterval);
        document.getElementById("status").textContent="Hiba: "+e.message;
        document.getElementById("out").innerHTML=`<pre style="color: #ff5555;">Hiba történt: ${escapeHtml(e.message)}</pre>`;
        setProgress(0);
    }
}

function saveAnalysis(record){let history=getHistory();history.push(record);if(history.length>50)history=history.slice(history.length-50);localStorage.setItem("analysisHistory",JSON.stringify(history));}
function getHistory(){try{return JSON.parse(localStorage.getItem("analysisHistory"))||[];}catch(_){return[];}}
function renderHistory(history){const box=document.getElementById("history");if(!history||!history.length){__historyCache=[];box.innerHTML='<p class="muted">Nincsenek korábbi elemzések.</p>';return;}const list=history.slice().sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));__historyCache=list;const fmt=iso=>{try{const d=new Date(iso);return d.toLocaleString('hu-HU',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});}catch(_){return iso||'';}};box.innerHTML=list.map((item,i)=>{return`<details class="hist-item" data-idx="${i}"><summary><div class="hist-title">${escapeHtml(item.home)} vs ${escapeHtml(item.away)}</div><div class="hist-date">${escapeHtml(fmt(item.timestamp))}</div></summary><div class="hist-body"><div class="hist-content">${item.analysis||''}</div><div class="hist-actions"><button class="hist-open" onclick="openHistoryModal(${i})">Megnyitás teljes nézetben</button></div></div></details>`;}).join('');}
function filterHistory(){const query=document.getElementById('historySearch').value.toLowerCase();document.querySelectorAll('#history .hist-item').forEach(item=>{const title=item.querySelector('.hist-title').textContent.toLowerCase();item.style.display=title.includes(query)?'':'none';});}
function openHistoryModal(idx){const item=__historyCache[idx];if(!item)return;document.getElementById('modalTitle').textContent=`${item.home} vs ${item.away}`;document.getElementById('modalBody').innerHTML=item.analysis||'';document.getElementById('modal').classList.add('open');}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function openSettingsModal(){document.getElementById('modalTitle').textContent='Beállítások';const body=document.getElementById('modalBody');body.innerHTML=`<label for="gasUrlModal">Google Apps Script URL</label><textarea id="gasUrlModal" placeholder="Illessze be a közzétett backend script URL-jét..." style="min-height: 120px;">${__gasUrl}</textarea><label for="bankrollModal">Bankroll</label><input type="number" id="bankrollModal" placeholder="Teljes tőke..." value="${__bankroll}" style="margin-bottom: 1rem;"><button class="btn-primary" onclick="saveSettings()">Mentés és bezárás</button>`;document.getElementById('modal').classList.add('open');}
function saveSettings(){const newUrl=document.getElementById('gasUrlModal').value;__gasUrl=newUrl;localStorage.setItem('gasUrl',newUrl);const newBankroll=parseFloat(document.getElementById('bankrollModal').value)||0;__bankroll=newBankroll;localStorage.setItem('bankroll',newBankroll);closeModal();calculateStats();const statusEl=document.getElementById('fxStatus');if(statusEl)statusEl.textContent='Beállítások elmentve.';}

// --- FOGADÁSI SZELVÉNY FUNKCIÓK (ÁTÍRVA) ---

function saveSlip(){localStorage.setItem('betSlip',JSON.stringify(__betSlip));}
function loadSlip(){__betSlip=JSON.parse(localStorage.getItem('betSlip'))||[];renderSlip();}
function saveSlipHistory(){localStorage.setItem('slipHistory',JSON.stringify(__slipHistory));}
function loadSlipHistory(){__slipHistory=JSON.parse(localStorage.getItem('slipHistory'))||[];calculateStats();}

function addToSlip(match,market,selection,odds,ourProb){
    const betId = `${match}-${selection}`;
    if (__betSlip.some(bet => bet.id.startsWith(match))) {
        alert('Ebből a meccsből már van egy tipp a szelvényen!');
        return;
    }
    const bet={id:betId,match,market,selection,odds,ourProb};
    __betSlip.push(bet);
    saveSlip();
    renderSlip();
}

function removeBet(index){
    if(!confirm('Biztosan törlöd ezt a tippet a szelvényről?')) return;
    __betSlip.splice(index,1);
    saveSlip();
    renderSlip();
}

function renderSlip(){
    const container=document.getElementById('betSlip');
    const evaluationContainer=document.getElementById('slipEvaluation');
    const resultInputsContainer=document.getElementById('slipResultInputs');
    
    if(__betSlip.length === 0){
        container.innerHTML = '<p class="muted">A szelvény üres. Kattints a \'+\' gombra egy tipp hozzáadásához.</p>';
        evaluationContainer.style.display = 'none';
        return;
    }

    let slipHTML = __betSlip.map((bet,index) => `
        <div class="slip-item">
            <div class="slip-item-header">
                <div>
                    <div class="slip-title">${escapeHtml(bet.match)}</div>
                    <div class="slip-market">${escapeHtml(bet.market)}</div>
                </div>
                <button onclick="removeBet(${index})" style="background:transparent; border:none; color: #ff6b6b; font-size: 24px; cursor:pointer;">&times;</button>
            </div>
            <div class="slip-details">${escapeHtml(bet.selection)} @ ${bet.odds}</div>
        </div>
    `).join('');

    const totalOdds = __betSlip.reduce((acc, bet) => acc * bet.odds, 1);
    const potentialWinnings = (document.getElementById('comboStake')?.value || 0) * totalOdds;

    slipHTML += `
        <div class="slip-summary-card">
            <div class="summary-row">
                <span>Események száma:</span>
                <strong>${__betSlip.length}</strong>
            </div>
            <div class="summary-row">
                <span>Eredő Odds:</span>
                <strong>${totalOdds.toFixed(2)}</strong>
            </div>
            <div class="summary-row">
                <label for="comboStake">Teljes Tét:</label>
                <input type="number" id="comboStake" placeholder="0" oninput="renderSlip()">
            </div>
            <hr style="border-color: var(--border); margin: 1rem 0;">
            <div class="summary-row">
                <span>Várható Nyeremény:</span>
                <strong>${potentialWinnings.toFixed(2)}</strong>
            </div>
        </div>`;

    container.innerHTML = slipHTML;
    
    // Eredménybekérő mezők generálása
    const uniqueMatches = [...new Map(__betSlip.map(bet => [bet.match, bet])).values()];
    resultInputsContainer.innerHTML = uniqueMatches.map((bet, index) => `
        <div class="slip-item">
            <div class="slip-title">${escapeHtml(bet.match)}</div>
            <div class="slip-results-input-grid">
                 <label>Hazai</label><span>-</span><label>Vendég</label>
                 <input type="number" id="home-score-${index}" placeholder="H" size="2">
                 <span></span>
                 <input type="number" id="away-score-${index}" placeholder="V" size="2">
            </div>
        </div>
    `).join('');

    evaluationContainer.style.display = 'block';
}

function evaluateSlip() {
    const stake = parseFloat(document.getElementById('comboStake').value);
    if (isNaN(stake) || stake <= 0) {
        alert('Kérlek, adj meg érvényes tétet!');
        return;
    }

    const uniqueMatches = [...new Map(__betSlip.map(bet => [bet.match, bet])).values()];
    const results = {};
    let allScoresEntered = true;

    uniqueMatches.forEach((bet, index) => {
        const homeScore = parseInt(document.getElementById(`home-score-${index}`).value);
        const awayScore = parseInt(document.getElementById(`away-score-${index}`).value);
        if (isNaN(homeScore) || isNaN(awayScore)) {
            allScoresEntered = false;
        }
        results[bet.match] = { home: homeScore, away: awayScore };
    });

    if (!allScoresEntered) {
        alert('Kérlek, add meg az összes meccs eredményét!');
        return;
    }
    
    let isSlipWinner = true;
    for (const bet of __betSlip) {
        const result = results[bet.match];
        const homeScore = result.home;
        const awayScore = result.away;
        const totalGoals = homeScore + awayScore;
        let isBetWinner = false;

        if (bet.market.includes('1X2') || bet.market.includes('MONEYLINE')) {
            if (bet.selection === 'Hazai' && homeScore > awayScore) isBetWinner = true;
            else if (bet.selection === 'Döntetlen' && homeScore === awayScore) isBetWinner = true;
            else if (bet.selection === 'Vendég' && awayScore > homeScore) isBetWinner = true;
        } else if (bet.market.includes('GÓLOK')) {
            const point = parseFloat(bet.selection.match(/[\d\.]+/)[0]);
            if (bet.selection.includes('Over') && totalGoals > point) isBetWinner = true;
            else if (bet.selection.includes('Under') && totalGoals < point) isBetWinner = true;
        } else if (bet.market.includes('BTTS')) {
            if(bet.selection === 'Igen' && homeScore > 0 && awayScore > 0) isBetWinner = true;
            else if (bet.selection === 'Nem' && (homeScore === 0 || awayScore === 0)) isBetWinner = true;
        }

        if (!isBetWinner) {
            isSlipWinner = false;
            break;
        }
    }
    
    const totalOdds = __betSlip.reduce((acc, bet) => acc * bet.odds, 1);
    const profit = isSlipWinner ? (stake * totalOdds) - stake : -stake;
    
    const slipRecord = {
        id: new Date().toISOString(),
        bets: [...__betSlip],
        stake: stake,
        totalOdds: totalOdds,
        status: isSlipWinner ? 'win' : 'loss',
        profit: profit
    };

    __slipHistory.push(slipRecord);
    saveSlipHistory();
    
    alert(`A szelvény ${isSlipWinner ? 'NYERT' : 'VESZTETT'}! Profit: ${profit.toFixed(2)}`);
    
    __betSlip = [];
    saveSlip();
    renderSlip();
    calculateStats();
}

function calculateStats() {
    let initialBankroll = parseFloat(localStorage.getItem('bankroll')) || 10000;
    const totalProfit = __slipHistory.reduce((acc, slip) => acc + slip.profit, 0);
    const currentBankroll = initialBankroll + totalProfit;

    const totalSlips = __slipHistory.length;
    const winningSlips = __slipHistory.filter(s => s.status === 'win').length;
    const winRate = totalSlips > 0 ? (winningSlips / totalSlips * 100).toFixed(1) : 0;

    document.getElementById('slipStats').innerHTML = `
        <div class="slip-stats">
            <div class="stat-item">
                <div class="stat-title">Kezdő Bankroll</div>
                <div class="stat-value">${initialBankroll.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Aktuális Bankroll</div>
                <div class="stat-value ${currentBankroll >= initialBankroll ? 'profit' : 'loss'}">${currentBankroll.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Teljes Profit</div>
                <div class="stat-value ${totalProfit >= 0 ? 'profit' : 'loss'}">${totalProfit.toFixed(2)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-title">Találati Arány</div>
                <div class="stat-value">${winRate}% (${winningSlips}/${totalSlips})</div>
            </div>
        </div>
    `;
}
</script>
</body>
</html>
