<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemző Gemini AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #000000;
    --card: #1a1a1a;
    --border: #38301d;
    --muted: #aaa;
    --primary: #D4AF37;
    --secondary: #B8860B;
    --accent: #FFD700;
    --text: #f5f5dc;
    --font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
body {
    margin: 0;
    font-family: var(--font-family);
    color: var(--text);
    background-color: #000;
    background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2338301d' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
    min-height: 100vh;
}
.app-header{background: linear-gradient(90deg, #1a1a1a, #000000); color:var(--primary); padding:1.1rem; text-align:center; border-bottom:1px solid var(--border);}
.app-header h1{font-weight:800; margin:0;}
.container { max-width: 1800px; margin: 1.8rem auto; padding: 0 2rem; }
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr 340px;align-items:start;}
@media (max-width: 1280px) {.layout {grid-template-columns: 340px 1fr;} .col-right {grid-column: 1 / -1;}}
@media (max-width: 980px) {.layout {grid-template-columns: 1fr;}}
.card{background: var(--card); border:1px solid var(--border); border-radius:16px; padding:1.1rem; margin-bottom:1rem; box-shadow:0 20px 40px rgba(0,0,0,.35);}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700; margin-top:0;}
label{display:block;font-weight:600;margin-top:.6rem}
input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c0c0c;color:var(--text);margin-top:.25rem;font-size:14px;font-family:inherit}
input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(184, 134, 11, .25)}
.actions{margin-top:1rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.btn-primary {padding:12px 18px;border:none;border-radius:14px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#000;font-weight:800;cursor:pointer;white-space:nowrap;width:100%;transition:transform .2s ease;font-family:var(--font-family); text-align: center;}
.btn-primary:hover:not(:disabled) {transform:translateY(-2px); box-shadow: 0 8px 20px rgba(212, 175, 55, 0.2);}
.btn-primary:disabled {background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
.progress-ring{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;margin:1rem auto;transition:opacity .5s}.progress-label{font-size:1.5rem;font-weight:700}
.fx-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 4px; border-bottom: 1px solid var(--border); }
.fx-title { font-weight: 600;}
.fx-meta { font-size: 0.8rem; color: var(--muted);}
.league-list { margin-top: 1rem; max-height: 250px; overflow-y: auto; padding-right: 5px; }
.league-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 8px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
.league-item:hover { background-color: rgba(255,255,255,0.05); }
.league-item input { display: none; }
.league-item .custom-checkbox { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 5px; margin-right: 12px; transition: all 0.2s; }
.league-item input:checked + .custom-checkbox { background-color: var(--secondary); border-color: var(--secondary); }
.league-item input:checked + .custom-checkbox::after { content: '✔'; color: black; display: block; text-align: center; line-height: 14px; font-size: 12px; }
.modal { display:none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
.modal-content { background-color: var(--card); margin: 10% auto; padding: 25px; border: 1px solid var(--border); width: 80%; max-width: 500px; border-radius: 16px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
.modal-close { color: var(--muted); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
.analysis-step-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.analysis-step-card.value-bet { border-color: var(--primary); background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(184, 134, 11, 0.05)); }
.step-header { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.8rem; }
.step-icon { font-size: 1.8rem; }
.step-title { margin: 0; font-weight: 800; color: var(--secondary); font-size: 1.2rem; }
.analysis-step-card.value-bet .step-title { color: var(--primary); }
.step-content { line-height: 1.7; font-size: 0.95rem; }
.step-content strong { color: var(--accent); }
.metrics { margin-bottom: 1.5rem; }
.xg-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem; border: 1px solid var(--border); }
.xg-card .badge { display: inline-block; padding: 4px 10px; background: var(--secondary); color: var(--bg); font-weight: 700; border-radius: 12px; margin-bottom: 1rem; font-size: 0.8rem; }
.xg-row { display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem; }
.xg-team { flex-basis: 120px; font-weight: 600; }
.xg-bar { flex-grow: 1; height: 18px; background-color: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden; }
.xg-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); border-radius: 6px; transition: width 0.5s ease-out; }
.xg-val { font-weight: 700; font-size: 1.1rem; }
.chat-container { margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem; }
.chat-history { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding-right: 10px; }
.chat-message { margin-bottom: 1rem; line-height: 1.6; }
.chat-message b { color: var(--secondary); display: block; margin-bottom: 4px;}
.chat-input-group { display: flex; gap: 10px; }
.chat-input-group input { flex-grow: 1; margin: 0; }
.chat-input-group button { width: auto; }
details.card { transition: all 0.3s ease-in-out; }
details.card[open] { background: #212121; }
details > summary { list-style: none; display: flex; align-items: center; cursor: pointer; padding: 0.5rem 0; }
details > summary::-webkit-details-marker { display: none; }
details > summary::before { content: '▶'; font-size: 0.8em; color: var(--secondary); margin-right: 0.8rem; transform: rotate(0deg); transition: transform 0.2s ease-in-out; }
details[open] > summary::before { transform: rotate(90deg); }
details > summary h2 { margin: 0; flex-grow: 1; }
details > input#historySearch { width: 100%; margin-top: 0.5rem; margin-bottom: 1rem; }
.history-list { border-top: 1px solid var(--border); padding-top: 0.5rem; max-height: 400px; overflow-y: auto; }
.btn-small { padding: 6px 12px !important; font-size: 0.8rem !important; border-radius: 10px !important; width: auto !important; flex-shrink: 0; }
.btn-delete { background: linear-gradient(135deg, #991b1b, #7f1d1d) !important; }
.btn-delete:hover { background: linear-gradient(135deg, #a52828, #922b2b) !important; }
.error-card { background: rgba(255, 0, 0, 0.1); border: 1px solid #ff4444; color: #ff6666; }
.warning-card { background: rgba(255, 165, 0, 0.1); border: 1px solid #ffa500; color: #ffcc00; padding: 10px; border-radius: 8px; margin-bottom: 1rem; }
.success-card { background: rgba(0, 255, 0, 0.1); border: 1px solid #00ff00; color: #00ff88; padding: 10px; border-radius: 8px; margin-bottom: 1rem; }
.loading { opacity: 0.6; pointer-events: none; }
.retry-btn { background: linear-gradient(135deg, #ff6b35, #f7931e) !important; margin-top: 10px; }
</style>
</head>
<body>
<header class="app-header">
    <h1>SportElemző Gemini AI</h1>
</header>
<div class="container layout">
    <div class="col-left">
        <div class="card">
            <h2>Beállítások</h2>
            <button class="btn-primary" onclick="openSettingsModal()">Beállítások</button>
            <label for="sportSelector">Sportág</label>
            <select id="sportSelector">
                <option value="soccer" selected>Labdarúgás</option>
                <option value="hockey">Jégkorong</option>
                <option value="basketball">Kosárlabda</option>
            </select>
            <div class="actions">
                <button class="btn-primary" onclick="loadFixtures()">Meccsek frissítése</button>
                <button class="btn-primary" onclick="saveFavLeagues()">Kedvencek mentése</button>
                <span id="fxStatus" class="muted"></span>
            </div>
            <label for="leagueSearch">Keresés a ligákban</label>
            <input id="leagueSearch" placeholder="pl. Premier, NHL..." />
            <div class="league-list" id="leagueList">
                <p class="muted">Frissíts a meccsekért!</p>
            </div>
        </div>
        <div class="card">
            <h2>Közelgő meccsek</h2>
            <div id="fixtures"><p class="muted">Válassz sportágat és frissíts!</p></div>
        </div>
    </div>
    <div class="col-center">
        <div class="card">
            <h2>Meccselemzés</h2>
            <datalist id="teamlist"></datalist>
            <div style="display:flex; gap:12px;">
                <div style="flex:1;"><label for="home">Hazai csapat</label><input id="home" list="teamlist" placeholder="Pl. Liverpool" /></div>
                <div style="flex:1;"><label for="away">Vendég csapat</label><input id="away" list="teamlist" placeholder="Pl. Manchester City" /></div>
            </div>
            <div class="actions">
                <button id="goBtn" class="btn-primary" onclick="go()">Elemzés Futtatása</button>
            </div>
            <div id="progress" class="progress-ring" style="display:none;"><span class="progress-label"></span></div>
            <p id="status" class="muted" style="text-align:center;">Kész.</p>
        </div>
        <div id="out"></div>
    </div>
    <div class="col-right">
       <details class="card">
         <summary>
           <div class="summary-title"><h2>Előző Elemzések</h2></div>
         </summary>
         <input id="historySearch" placeholder="Keresés az előzményekben...">
         <div id="history" class="history-list">
             <p class="muted">Nincsenek korábbi elemzések.</p>
         </div>
       </details>
    </div>
</div>
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Beállítások</h2>
    <label for="gasUrlInput">Backend URL (Google Apps Script)</label>
    <input type="text" id="gasUrlInput" placeholder="Illeszd be a Web App URL-t...">
    <div class="actions">
        <button class="btn-primary" onclick="saveSettings()">Mentés</button>
    </div>
  </div>
</div>
<script>
let __allLeagues = [], __favLeagues = new Set(), __fixtures = [], __masterTeamList = [], __gasUrl = '', __currentSport = 'soccer', isSaving = false;
let __chatHistory = [];
let __retryCount = 0;
const MAX_RETRIES = 3;
const REQUEST_TIMEOUT = 30000; // 30 seconds

document.addEventListener("DOMContentLoaded", function() {
    __gasUrl = localStorage.getItem('gasUrl');
    if (!__gasUrl) { 
        showWarning("Backend URL nincs beállítva. Kattints a Beállítások gombra a konfiguráláshoz.");
        openSettingsModal(); 
    }
    document.getElementById('sportSelector').addEventListener('change', handleSportChange);
    document.getElementById('leagueSearch').addEventListener('input', renderLeagueList);
    document.getElementById('historySearch').addEventListener('input', filterHistory);
    renderHistory(getHistoryFromLocalStorage());
});

function showWarning(message) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'warning-card';
    warningDiv.innerHTML = `<strong>Figyelem:</strong> ${message}`;
    document.querySelector('.col-center').insertBefore(warningDiv, document.querySelector('.col-center').firstChild);
    setTimeout(() => warningDiv.remove(), 10000);
}

function showError(message, showRetry = false) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-card';
    errorDiv.innerHTML = `<strong>Hiba:</strong> ${message}`;
    if (showRetry) {
        errorDiv.innerHTML += `<br><button class="btn-primary retry-btn" onclick="retryLastOperation()">Újrapróbálás</button>`;
    }
    document.querySelector('.col-center').insertBefore(errorDiv, document.querySelector('.col-center').firstChild);
    setTimeout(() => errorDiv.remove(), 15000);
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-card';
    successDiv.innerHTML = `<strong>Siker:</strong> ${message}`;
    document.querySelector('.col-center').insertBefore(successDiv, document.querySelector('.col-center').firstChild);
    setTimeout(() => successDiv.remove(), 5000);
}

function handleSportChange() {
    __currentSport = document.getElementById('sportSelector').value;
    document.getElementById('leagueList').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>';
    document.getElementById('fixtures').innerHTML = '<p class="muted">Frissíts a meccsekért!</p>';
    document.getElementById('teamlist').innerHTML = '';
}

async function loadFixtures() {
    const statusEl = document.getElementById('fxStatus');
    const refreshBtn = document.querySelector('button[onclick="loadFixtures()"]');
    
    statusEl.textContent = 'Adatok lekérése...';
    refreshBtn.disabled = true;
    refreshBtn.classList.add('loading');
    
    if (!__gasUrl) { 
        statusEl.textContent = 'Hiba: URL nincs beállítva.';
        showError("Backend URL nincs beállítva. Állítsd be a beállításokban.");
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('loading');
        return; 
    }
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
        
        const response = await fetch(`${__gasUrl}?sport=${__currentSport}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.error) {
            throw new Error(data.error);
        }

        __allLeagues = data.leagues || [];
        __fixtures = data.fixtures || [];
        const teamSet = new Set();
        __fixtures.forEach(f => { teamSet.add(f.home); teamSet.add(f.away); });
        __masterTeamList = Array.from(teamSet).sort();
        document.getElementById('teamlist').innerHTML = __masterTeamList.map(t => `<option value="${t}"></option>`).join('');
        
        renderLeagueList();
        renderFixtureList();
        statusEl.textContent = `Siker! ${__fixtures.length} meccs betöltve.`;
        showSuccess(`${__fixtures.length} meccs és ${__allLeagues.length} liga betöltve.`);
        __retryCount = 0; // Reset retry count on success
    } catch (e) { 
        console.error('LoadFixtures error:', e);
        let errorMessage = e.message;
        if (e.name === 'AbortError') {
            errorMessage = 'Kérés időtúllépés (30s). Ellenőrizd a hálózati kapcsolatot.';
        }
        statusEl.textContent = `Hiba: ${errorMessage}`;
        showError(`Meccsek betöltése sikertelen: ${errorMessage}`, __retryCount < MAX_RETRIES);
        __retryCount++;
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.classList.remove('loading');
    }
}

function renderLeagueList() {
    const box = document.getElementById('leagueList');
    const query = document.getElementById('leagueSearch').value.toLowerCase();
    const list = __allLeagues.filter(l => l.name.toLowerCase().includes(query));
    if (list.length === 0) {
        box.innerHTML = '<p class="muted">Nincsenek ligák vagy frissítés szükséges.</p>';
        return;
    }
    box.innerHTML = list.map(l => `<label class="league-item"><input type="checkbox" onchange="toggleFavLeague('${l.name}')" ${__favLeagues.has(l.name) ? 'checked' : ''}><div class="custom-checkbox"></div><span>${l.name} (${l.count})</span></label>`).join('');
}

function renderFixtureList() {
    const box = document.getElementById('fixtures');
    const list = __favLeagues.size > 0 ? __fixtures.filter(f => __favLeagues.has(f.league)) : __fixtures;
    if(list.length === 0) { 
        box.innerHTML=`<p class="muted">Nincs megjeleníthető meccs vagy frissítés szükséges.</p>`; 
        return; 
    }
    box.innerHTML = list.map(f => {
        const d = new Date(f.utcKickoff).toLocaleString('hu-HU',{dateStyle:'short',timeStyle:'short'});
        return `<div class="fx-item"><div><div class="fx-title">${f.home} – ${f.away}</div><div class="fx-meta">${f.league} · ${d}</div></div><button class="btn-primary btn-small" onclick="fillAndAnalyze('${f.home}','${f.away}')">Elemzés</button></div>`;
    }).join('');
}

function fillAndAnalyze(home, away, bypassCache = false) {
    document.getElementById('home').value = home;
    document.getElementById('away').value = away;
    document.querySelector('.col-center').scrollIntoView({behavior: 'smooth'});
    go(bypassCache);
}

function toggleFavLeague(leagueName) {
    if (__favLeagues.has(leagueName)) __favLeagues.delete(leagueName);
    else __favLeagues.add(leagueName);
    renderFixtureList();
}

let __lastOperation = null;

function retryLastOperation() {
    if (__lastOperation && __retryCount < MAX_RETRIES) {
        __lastOperation();
    }
}

async function go(bypassCache = false) {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    
    if(!home || !away) { 
        showError("Minden mező kitöltése kötelező!");
        return; 
    }
    
    if (!__gasUrl) {
        showError("Backend URL nincs beállítva! Állítsd be a beállításokban.");
        openSettingsModal();
        return;
    }
    
    __lastOperation = () => go(bypassCache);
    
    const outDiv = document.getElementById('out');
    const goBtn = document.getElementById('goBtn');
    const statusEl = document.getElementById('status');
    
    // Clear previous results and errors
    outDiv.innerHTML = '';
    document.querySelectorAll('.error-card, .warning-card, .success-card').forEach(el => el.remove());
    
    goBtn.disabled = true;
    goBtn.classList.add('loading');
    
    let progressInterval = setInterval(() => { 
        const c = parseInt(document.querySelector('#progress .progress-label').textContent) || 0; 
        setProgress(Math.min(90, c + 1), "AI válaszára várunk..."); 
    }, 1000);
    
    setProgress(5, "Elemzés indítása...");

    try {
        let url = `${__gasUrl}?home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}`;
        if (bypassCache) { url += `&_cb=${new Date().getTime()}`; }
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
        
        setProgress(20, "Backend kapcsolat...");
        
        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        clearInterval(progressInterval);
        
        if (!response.ok) {
            throw new Error(`Szerver hiba: ${response.status} - ${response.statusText}`);
        }
        
        setProgress(70, "Válasz feldolgozása...");
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (!data.html) {
            throw new Error("Hiányzó elemzés a válaszból");
        }
        
        setProgress(90, "Elemzés megjelenítése...");
        outDiv.innerHTML = data.html;
        
        if (data.context && data.context.initialPrompt) {
            __chatHistory = [
                { role: "user", parts: [{ text: data.context.initialPrompt }] },
                { role: "model", parts: [{ text: "Az alap elemzés legenerálva. Készen állok a további kérdésekre." }] }
            ];
            addChatInterface(outDiv);
        }
        
        if (!bypassCache) { saveAnalysis({ home, away }); }
        setProgress(100, "Kész.");
        showSuccess(`Elemzés sikeresen elkészült: ${home} vs ${away}`);
        __retryCount = 0; // Reset retry count on success
    } catch(e) {
        console.error('Analysis error:', e);
        clearInterval(progressInterval);
        
        let errorMessage = e.message;
        let detailedMessage = "";
        
        if (e.name === 'AbortError') {
            errorMessage = "Kérés időtúllépés (30s)";
            detailedMessage = "A szerver nem válaszolt időben. Ellenőrizd a hálózati kapcsolatot és a backend URL-t.";
        } else if (e.message.includes('GEMINI_API_KEY')) {
            detailedMessage = "A Gemini API kulcs nincs beállítva a Google Apps Script-ben.";
        } else if (e.message.includes('HTTP 4')) {
            detailedMessage = "Kliens oldali hiba. Ellenőrizd a backend URL-t és a paramétereket.";
        } else if (e.message.includes('HTTP 5')) {
            detailedMessage = "Szerver oldali hiba. Próbáld újra később vagy ellenőrizd a backend logokat.";
        }
        
        outDiv.innerHTML = `<div class="card error-card">
            <h2>Hiba történt</h2>
            <p><strong>Hiba:</strong> ${errorMessage}</p>
            ${detailedMessage ? `<p><strong>Részletek:</strong> ${detailedMessage}</p>` : ''}
            <p><strong>Javaslatok:</strong></p>
            <ul>
                <li>Ellenőrizd a backend URL beállítást</li>
                <li>Győződj meg róla, hogy az API kulcsok be vannak állítva</li>
                <li>Próbáld újra néhány másodperc múlva</li>
                <li>Ellenőrizd a hálózati kapcsolatot</li>
            </ul>
            ${__retryCount < MAX_RETRIES ? '<button class="btn-primary retry-btn" onclick="retryLastOperation()">Újrapróbálás</button>' : ''}
        </div>`;
        
        setProgress(0, "Hiba.");
        __retryCount++;
    } finally {
        goBtn.disabled = false;
        goBtn.classList.remove('loading');
    }
}

function addChatInterface(container) {
    const chatCard = document.createElement('div');
    chatCard.className = 'card';
    chatCard.innerHTML = `
        <div class="chat-container">
            <h3>AI-Párbeszéd Folytatása</h3>
            <div id="chatHistory" class="chat-history"><p class="muted">Kérdezz rá az elemzés részleteire!</p></div>
            <div class="chat-input-group">
                <input id="chatInput" type="text" placeholder="Pl. Mi a helyzet, ha esik az eső?">
                <button id="chatSendBtn" class="btn-primary btn-small" onclick="sendChatMessage()">Küldés</button>
            </div>
        </div>`;
    container.appendChild(chatCard);
    document.getElementById('chatInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const sendBtn = document.getElementById('chatSendBtn');
    const historyDiv = document.getElementById('chatHistory');
    const userMessage = input.value.trim();
    
    if (!userMessage) return;
    
    if (!__gasUrl) {
        showError("Backend URL nincs beállítva!");
        return;
    }

    if (historyDiv.querySelector('.muted')) historyDiv.innerHTML = '';
    historyDiv.innerHTML += `<div class="chat-message"><b>Te:</b> ${userMessage}</div>`;
    __chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
    input.value = ''; 
    input.disabled = true; 
    sendBtn.disabled = true;
    sendBtn.classList.add('loading');
    historyDiv.scrollTop = historyDiv.scrollHeight;

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
        
        const response = await fetch(__gasUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'text/plain;charset=utf-8',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ action: 'continueAnalysis', history: __chatHistory }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);

        const aiMessage = data.response.replace(/\n/g, '<br>');
        historyDiv.innerHTML += `<div class="chat-message"><b>Gemini AI:</b> ${aiMessage}</div>`;
        __chatHistory.push({ role: "model", parts: [{ text: data.response }] });
    } catch (e) {
        console.error('Chat error:', e);
        let errorMessage = e.message;
        if (e.name === 'AbortError') {
            errorMessage = 'Kérés időtúllépés. Próbáld újra.';
        }
        historyDiv.innerHTML += `<div class="chat-message" style="color: #ff6b6b;"><b>Hiba:</b> ${errorMessage}</div>`;
    } finally {
        input.disabled = false; 
        sendBtn.disabled = false;
        sendBtn.classList.remove('loading');
        historyDiv.scrollTop = historyDiv.scrollHeight; 
        input.focus();
    }
}

function setProgress(pct, msg) {
    const el = document.getElementById('progress');
    const statusEl = document.getElementById('status');
    const v = Math.round(pct || 0);
    if(v > 0 && v < 100) el.style.display = 'grid';
    else setTimeout(() => { el.style.display = 'none'; }, 1000);
    el.style.background = `conic-gradient(var(--primary) ${v*3.6}deg, #333 0deg)`;
    el.querySelector('.progress-label').textContent = `${v}%`;
    if (msg) statusEl.textContent = msg;
}

function saveAnalysis(record) {
    let history = getHistoryFromLocalStorage();
    if (history.length > 0 && history[0].home === record.home && history[0].away === record.away) { return; }
    history.unshift({ home: record.home, away: record.away, date: new Date().toLocaleString('hu-HU') });
    if (history.length > 30) history = history.slice(0, 30);
    localStorage.setItem('sportAnalysisHistory', JSON.stringify(history));
    renderHistory(history);
}

function getHistoryFromLocalStorage() {
    try { return JSON.parse(localStorage.getItem('sportAnalysisHistory') || '[]'); } 
    catch (e) { return []; }
}

function renderHistory(history) {
    const box = document.getElementById('history');
    if (!box) return;
    if (!history || history.length === 0) {
        box.innerHTML = '<p class="muted">Nincsenek korábbi elemzések.</p>';
        return;
    }
    box.innerHTML = history.map((item, index) =>
        `<div class="fx-item">
            <div>
                <div class="fx-title">${item.home} – ${item.away}</div>
                <div class="fx-meta">${item.date}</div>
            </div>
            <div style="display:flex; gap: 8px;">
                <button class="btn-primary btn-small btn-delete" onclick="deleteAnalysis(${index})">Törlés</button>
                <button class="btn-primary btn-small" onclick="fillAndAnalyze('${item.home}','${item.away}', true)">Újra</button>
            </div>
        </div>`
    ).join('');
}

function deleteAnalysis(index) {
    if (!confirm("Biztosan törölni szeretnéd ezt az elemet az előzményekből?")) return;
    let history = getHistoryFromLocalStorage();
    history.splice(index, 1);
    localStorage.setItem('sportAnalysisHistory', JSON.stringify(history));
    renderHistory(history);
}

function filterHistory() {
    const query = document.getElementById('historySearch').value.toLowerCase();
    const history = getHistoryFromLocalStorage();
    renderHistory(history.filter(i => i.home.toLowerCase().includes(query) || i.away.toLowerCase().includes(query)));
}

function openSettingsModal() {
    document.getElementById('gasUrlInput').value = localStorage.getItem('gasUrl') || '';
    document.getElementById('settingsModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('settingsModal').style.display = 'none';
}

function saveSettings() {
    const newUrl = document.getElementById('gasUrlInput').value.trim();
    if (newUrl) {
        // Validate URL format
        try {
            new URL(newUrl);
        } catch (e) {
            showError("Érvénytelen URL formátum!");
            return;
        }
        
        localStorage.setItem('gasUrl', newUrl);
        __gasUrl = newUrl;
        showSuccess('Beállítások sikeresen mentve!');
        closeModal();
        
        // Clear previous warnings
        document.querySelectorAll('.warning-card').forEach(el => el.remove());
    } else {
        showError('Kérlek, adj meg egy érvényes URL-t.');
    }
}

async function saveFavLeagues() {
    if (!__gasUrl) { 
        showError('Backend URL nincs beállítva!');
        openSettingsModal();
        return; 
    }
    
    if (isSaving) return;
    isSaving = true;
    const statusEl = document.getElementById('fxStatus');
    const saveBtn = document.querySelector('button[onclick="saveFavLeagues()"]');
    
    statusEl.textContent = 'Mentés...';
    saveBtn.disabled = true;
    saveBtn.classList.add('loading');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), REQUEST_TIMEOUT);
        
        const response = await fetch(__gasUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'text/plain;charset=utf-8',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ action: 'saveFavLeagues', favLeagues: Array.from(__favLeagues) }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        
        statusEl.textContent = 'Sikeresen mentve!';
        showSuccess('Kedvenc ligák sikeresen mentve!');
    } catch (e) {
        console.error('Save favorites error:', e);
        let errorMessage = e.message;
        if (e.name === 'AbortError') {
            errorMessage = 'Mentés időtúllépés';
        }
        statusEl.textContent = `Hiba: ${errorMessage}`;
        showError(`Kedvencek mentése sikertelen: ${errorMessage}`);
    } finally {
        isSaving = false;
        saveBtn.disabled = false;
        saveBtn.classList.remove('loading');
    }
}

// Window click event for modal
window.onclick = function(event) {
    const modal = document.getElementById('settingsModal');
    if (event.target == modal) {
        closeModal();
    }
}

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showError(`Váratlan hiba: ${e.error.message}`);
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    showError(`Aszinkron hiba: ${e.reason}`);
});
</script>
</body>
</html>
