<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SportElemz≈ë Gemini AI</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#000000;--card:#1a1a1a;--border:#38301d;--muted:#aaa;--primary:#D4AF37;--secondary:#B8860B;--accent:#FFD700;--text:#f5f5dc;--danger:#d9534f; --success: #28a745; --info: #17a2b8; --font-family-header:'Poppins',system-ui,sans-serif; --font-family-body:'Roboto',system-ui,sans-serif;}
*{box-sizing:border-box}
body{margin:0;font-family:var(--font-family-header);color:var(--text);background-color:#000;background-image:url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2338301d' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");min-height:100vh}
.app-header h1{font-family: var(--font-family-header);}
h2, h3, h4, h5, h6 {font-family: var(--font-family-header);}
p, label, span, div, input, select {font-family: var(--font-family-body);}
.app-header{background:linear-gradient(90deg,#1a1a1a,#000000);color:var(--primary);padding:1.1rem;text-align:center;border-bottom:1px solid var(--border)}
.app-header h1{font-weight:800;margin:0}
.user-info{font-size:.9rem;margin-top:5px;opacity:.8}
.container{max-width:1800px;margin:1.8rem auto;padding:0 2rem}
.layout{display:grid;gap:18px;grid-template-columns:340px 1fr 340px;align-items:start}
@media (max-width:1280px){.layout{grid-template-columns:340px 1fr}.col-right{grid-column:1/-1}}
@media (max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.1rem;margin-bottom:1rem;box-shadow:0 20px 40px rgba(0,0,0,.35)}
h2{margin:0 0 .9rem 0;font-weight:800;color:var(--secondary)}
h3{font-weight:700;margin-top:0;color:var(--text)}
label{display:block;font-weight:600;margin-top:.6rem}
input,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#0c0c0c;color:var(--text);margin-top:.25rem;font-size:14px;font-family:inherit}
input:focus,select:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 3px rgba(184,134,11,.25)}
.actions{margin-top:1.5rem;display:flex;gap:.7rem;align-items:center;flex-wrap:wrap;flex-direction:column}
.btn-primary,.btn-danger,.btn-info{padding:12px 18px;border:none;border-radius:14px;color:#000;font-weight:800;cursor:pointer;white-space:nowrap;width:100%;transition:transform .2s ease;font-family:var(--font-family-header);text-align:center}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary))}
.btn-danger{background:linear-gradient(135deg,var(--danger),#b32b27)}
.btn-info {background: linear-gradient(135deg, var(--info), #107686);}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(212,175,55,.2)}
.btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(217,83,79,.2)}
.btn-info:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(23, 162, 184, 0.2);}
.btn-primary:disabled,.btn-danger:disabled,.btn-info:disabled{background:#555;cursor:not-allowed;opacity:.7}
.muted{color:var(--muted);font-size:.9rem}
@keyframes pulse-text { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
#fxStatus.loading { animation: pulse-text 1.5s infinite; text-align: center; width: 100%; display: block; }
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(212,175,55,.7)}70%{box-shadow:0 0 0 10px rgba(212,175,55,0)}100%{box-shadow:0 0 0 0 rgba(212,175,55,0)}}
.progress-ring{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;margin:1rem auto;transition:opacity .5s}
.progress-label{font-size:1.5rem;font-weight:700}
summary {list-style: none; cursor: pointer;}
summary::-webkit-details-marker {display: none;}
.list-summary{font-weight:800;font-size:1.2rem;color:var(--secondary);margin-bottom:.5rem;padding: 5px 0; display: flex; justify-content: space-between; align-items: center;}
.list-summary > .summary-title::before{content:'>';display:inline-block;margin-right:8px;}
.count-badge{background-color: var(--primary); color: #000; font-size: 0.9rem; font-weight: 800; padding: 3px 10px; border-radius: 20px; animation: pulse 2s infinite; display: none;}
.btn-sm{padding:8px 12px;font-size:.9rem;width:auto}
#out{min-height:20px}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal-content{background:var(--card);border:1px solid var(--primary);border-radius:16px;width:95%;max-width:1200px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 50px rgba(0,0,0,.5)}
.modal-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--card);z-index:1}
.modal-title{font-size:1.5rem;font-weight:800;color:var(--primary);margin:0}
.close-button{background:none;border:none;color:var(--muted);font-size:2rem;cursor:pointer;line-height:1}
.modal-body{padding:1.5rem}
.analysis-section{margin-bottom:1.5rem}
.analysis-section h4{color:var(--secondary);margin:0 0 .8rem 0;font-size:1.2rem;border-bottom:1px solid var(--border);padding-bottom:.5rem}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1rem}
@media (max-width:900px){.modal-grid{grid-template-columns:1fr}}
.market-group{background:rgba(0,0,0,0.2);border-radius:12px;padding:1rem;border:1px solid var(--border)}
.market-group h5{margin:0 0 1rem 0;font-size:1.1rem;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:.5rem}
.market-subtitle{color:var(--accent);font-weight:bold;display:block;margin-top:1.2rem;margin-bottom:0.8rem;font-size:1.1em;}
.prob-item{margin-bottom:.8rem}
.prob-label{display:flex;justify-content:space-between;font-weight:600;margin-bottom:4px}
.prob-bar-bg{width:100%;background:rgba(0,0,0,.3);border-radius:5px;height:10px;overflow:hidden}
.prob-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:5px}
.best-bet-card{background:linear-gradient(135deg,rgba(212,175,55,.05),rgba(184,134,11,.05));border:1px solid var(--primary);border-radius:12px;padding:1rem;margin-top:1.5rem}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1 1 200px}
.xg-comparison{padding:1rem;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid var(--border);margin-top:1rem; margin-bottom:1rem;}
.xg-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.xg-label{flex-basis:120px;font-weight:600}
.xg-bar-container{flex-grow:1;height:20px;background:rgba(0,0,0,0.3);border-radius:8px;overflow:hidden}
.xg-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:8px}
.xg-value{font-weight:700;font-size:1.2rem}
.modal-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
.league-card, .fixture-card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s ease; }
.league-card:hover, .fixture-card:hover { transform: translateY(-3px); border-color: var(--secondary); box-shadow: 0 8px 20px rgba(0,0,0,.2); }
.fixture-card { cursor: default; display: flex; flex-direction: column; justify-content: space-between; }
.fixture-card .fx-title { font-weight: 700; font-size: 1.1rem; }
.fixture-card .fx-meta { font-size: 0.85rem; color: var(--muted); margin: 0.5rem 0 1rem 0; }
.fixture-card .btn-primary { width: 100%; }
.fx-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--border);transition:background-color .2s ease}.fx-item:hover{background-color:rgba(255,255,255,.05)}.fx-item-details{flex-grow:1}
.market-pulse-card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
.market-pulse-card h4 { color: var(--secondary); }
.odds-row { display: grid; grid-template-columns: 1fr auto auto; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); gap: 10px;}
.odds-row:last-child { border-bottom: none; }
.odds-value { font-weight: 700; font-size: 1.1rem; color: var(--accent); }
.odds-movement { font-size: 1.2rem; }
.odds-movement.up { color: var(--danger); }
.odds-movement.down { color: var(--success); }
.value-bet-card { border-color: var(--success) !important; background: linear-gradient(135deg, rgba(40, 167, 69, 0.05), rgba(40, 167, 69, 0.1)) !important; }
.value-bet-card h4 { color: var(--success) !important; }
.value-highlight { color: var(--success); font-weight: 800; font-size: 1.2em; }
.sport-filter-container {display: flex; gap: 8px; margin-bottom: 0.8rem;}
.sport-filter-btn {background-color: #0c0c0c; border: 1px solid var(--border); color: var(--muted); padding: 5px 12px; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; flex-grow: 1;}
.sport-filter-btn:hover {border-color: var(--secondary); color: var(--text);}
.sport-filter-btn.active {background-color: var(--primary); color: #000; border-color: var(--primary); font-weight: 700;}
.history-date-group { border-bottom: 1px solid var(--border); }
.history-date-group:last-of-type { border-bottom: none; }
.history-date-summary { cursor: pointer; padding: 0.8rem 0.5rem; font-size: 1rem; font-weight: 700; color: var(--primary); list-style: none; display: flex; align-items: center; }
.history-date-summary::before { content: '‚ñ∂'; margin-right: 10px; font-size: 0.8em; transition: transform 0.2s; }
details[open] > summary::before { transform: rotate(90deg); }
.form-comparison { margin-bottom: 1rem; padding: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--border); }
.form-row { display: flex; align-items: center; gap: 10px; }
.form-row:first-child { margin-bottom: 8px; }
.form-label { font-weight: 600; }
.form-badges { display: flex; gap: 5px; }
.form-badge { width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: #000; font-weight: 700; font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.form-w { background-color: var(--success); }
.form-d { background-color: #f0ad4e; }
.form-l { background-color: var(--danger); }
.value-bet-item { border-top: 1px solid rgba(40, 167, 69, 0.3); padding-top: 1rem; margin-top: 1rem; }
.value-bet-item:first-child { border-top: none; margin-top: 0; padding-top: 0; }
.value-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem 1rem; margin: 0.5rem 0; }
.expert-tuning-toggle { color: var(--secondary); cursor: pointer; font-weight: 600; font-size: 0.9rem; text-align: center; margin-top: 1rem; padding: 5px; }
.expert-tuning-toggle:hover { text-decoration: underline; }
#expertTuningPanel { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border); }
.model-confidence-card { border-color: var(--info) !important; background: linear-gradient(135deg, rgba(23, 162, 184, 0.05), rgba(23, 162, 184, 0.1)) !important; }
.model-confidence-card h4 { color: var(--info) !important; }
.confidence-score { font-size: 1.5rem; font-weight: 800; color: var(--info); }
.btn-log-bet { width: auto; font-size: 0.9rem; padding: 8px 12px; margin-top: 0.5rem; background: linear-gradient(135deg, var(--success), #1e7e34); }
.btn-log-bet:hover:not(:disabled) { box-shadow: 0 8px 20px rgba(40, 167, 69, 0.2); }
#liveScenarioPanel { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed var(--border); }

/* SZEMK√çM√âL≈êBB SZ√ñVEG */
.analysis-section p { font-size: 1.05rem; line-height: 1.75; color: #EAEAEA; margin-bottom: 1.2rem; font-family: var(--font-family-body); font-weight: 400;}

/* DIZ√ÅJNOS CS√öSZK√ÅK */
input[type=range]{-webkit-appearance:none;background:0 0;width:100%;margin:6px 0}
input[type=range]:focus{outline:0}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:8px;cursor:pointer;background:var(--primary);border-radius:5px;border:.2px solid #010101}
input[type=range]::-webkit-slider-thumb{border:2px solid var(--card);height:20px;width:20px;border-radius:50%;background:var(--accent);cursor:pointer;-webkit-appearance:none;margin-top:-6px}
input[type=range]:focus::-webkit-slider-runnable-track{background:var(--secondary)}
input[type=range]::-moz-range-track{width:100%;height:8px;cursor:pointer;background:var(--primary);border-radius:5px;border:.2px solid #010101}
input[type=range]::-moz-range-thumb{border:2px solid var(--card);height:20px;width:20px;border-radius:50%;background:var(--accent);cursor:pointer}
</style>
</head>
<body>
<header class="app-header"><h1>SportElemz≈ë Gemini AI</h1><div id="userInfo" class="user-info"></div></header>
<div class="container layout">
    <div class="col-left">
        <div class="card">
            <h2>Be√°ll√≠t√°sok</h2>
            <label for="sportSelector">Sport√°g</label>
            <select id="sportSelector" onchange="handleSportChange()">
                <option value="soccer" selected>Labdar√∫g√°s</option>
                <option value="hockey">J√©gkorong</option>
                <option value="basketball">Kos√°rlabda</option>
            </select>
            <div class="actions" style="margin-top: 1rem;">
                <button id="loadFixturesBtn" class="btn-primary" onclick="loadFixtures()">Meccsek Bet√∂lt√©se (2 nap)</button>
                <span id="fxStatus" class="muted"></span>
            </div>
        </div>
        <div class="card">
             <summary class="list-summary" onclick="showLeaguesInModal()"><span class="summary-title">Bajnoks√°gok</span><span id="leagueCount" class="count-badge"></span></summary>
             <summary class="list-summary" onclick="showMatchesInModal()"><span class="summary-title">M√©rk≈ëz√©sek</span><span id="matchCount" class="count-badge"></span></summary>
        </div>
         <details class="card">
            <summary><h2>Teljes√≠tm√©nyk√∂vet√©s</h2></summary>
            <div id="sheetUrlContainer">
              <p class="muted">Add meg a Google T√°bl√°zat URL-j√©t a napl√≥z√°shoz. A T√°bl√°zatban hozz l√©tre egy "SportElemz≈ë" men√ºt a ki√©rt√©kel√©shez.</p>
              <label for="sheetUrl">Google T√°bl√°zat URL</label>
              <input id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..." onchange="saveSheetUrl()">
            </div>
            <div id="bankrollStatus"><p class="muted">Nincs adat.</p></div>
        </details>
    </div>
    <div class="col-center">
        <div class="card">
            <h2>K√©zi Meccselemz√©s</h2>
            <div class="row">
                <div class="col"><label for="home">Hazai csapat</label><input id="home" placeholder="Pl. Liverpool"/></div>
                <div class="col"><label for="away">Vend√©g csapat</label><input id="away" placeholder="Pl. Manchester City"/></div>
            </div>

            <div class="expert-tuning-toggle" onclick="togglePanel('expertTuningPanel')">Szak√©rt≈ëi Finomhangol√°s ‚öôÔ∏è</div>
            <div id="expertTuningPanel">
                <div class="row">
                    <div class="col">
                        <label for="homeFormWeight">Hazai Forma S√∫lyoz√°sa (<span id="homeFormWeightLabel">50</span>%)</label>
                        <input type="range" id="homeFormWeight" min="0" max="100" value="50" oninput="document.getElementById('homeFormWeightLabel').textContent = this.value">
                    </div>
                    <div class="col">
                        <label for="awayFormWeight">Vend√©g Forma S√∫lyoz√°sa (<span id="awayFormWeightLabel">50</span>%)</label>
                        <input type="range" id="awayFormWeight" min="0" max="100" value="50" oninput="document.getElementById('awayFormWeightLabel').textContent = this.value">
                    </div>
                </div>
            </div>

            <div class="expert-tuning-toggle" onclick="togglePanel('liveScenarioPanel')">√âl≈ë Szcen√°ri√≥ Elemz√©s ‚ö°</div>
             <div id="liveScenarioPanel" style="display:none;">
                <p class="muted" style="text-align:center;">Add meg a meccs jelenlegi √°ll√°s√°t √©s a h√°tral√©v≈ë id≈ët a szimul√°ci√≥hoz.</p>
                <div class="row">
                    <div class="col"><label for="liveHomeScore">Hazai g√≥lok</label><input id="liveHomeScore" type="number" value="0"/></div>
                    <div class="col"><label for="liveAwayScore">Vend√©g g√≥lok</label><input id="liveAwayScore" type="number" value="0"/></div>
                    <div class="col"><label for="liveTimeRemainingMinutes">H√°tral√©v≈ë percek</label><input id="liveTimeRemainingMinutes" type="number" value="90" min="0" max="120"/></div>
                </div>
            </div>
            
            <div class="actions">
                <button id="goBtn" class="btn-primary" onclick="runAnalysis(true)">Elemz√©s Futtat√°sa</button>
            </div>
            <div id="progress" class="progress-ring" style="display:none"><span class="progress-label"></span></div>
            <p id="status" class="muted" style="text-align:center">K√©sz.</p>
        </div>
        <div id="out"></div>
    </div>
    <div class="col-right">
       <details class="card">
          <summary><h2>Elemz√©si El≈ëzm√©nyek (Napl√≥)</h2></summary>
          <div id="history">
             <p class="muted">A napl√≥ megtekint√©s√©hez add meg a Google T√°bl√°zat URL-j√©t a "Teljes√≠tm√©nyk√∂vet√©s" szekci√≥ban.</p>
          </div>
       </details>
    </div>
</div>

<div id="analysisModal" class="modal-overlay" onclick="closeAnalysisModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="modalTitle" class="modal-title">Elemz√©s</h3>
            <button class="close-button" onclick="closeAnalysisModal()">&times;</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<div id="listModal" class="modal-overlay" onclick="closeListModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 id="listModalTitle" class="modal-title">Lista</h3>
            <button class="close-button" onclick="closeListModal()">&times;</button>
        </div>
        <div id="listModalBody" class="modal-body"></div>
    </div>
</div>

<script>
let __gasUrl = 'https://script.google.com/macros/s/AKfycbzezgLIW-VE1ZCaRUU7nQ6lebTEH6VpUrjW-rpnJXUnXnkdlM9B3suv6dw-RZTTyfGiCg/exec';
let __fixtures = [];
let __currentSport = 'soccer';
let __historySportFilter = 'soccer';
let __sheetUrl = '';

document.addEventListener("DOMContentLoaded", function(){
    if(!__gasUrl||!__gasUrl.startsWith('https://script.google.com')){document.getElementById('userInfo').textContent='HIBA: K√©rlek, add meg a Web App URL-t!'}else{document.getElementById('userInfo').textContent=`Csatlakozva.`}
    loadSheetUrl();
});

function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
}

function saveSheetUrl() {
    __sheetUrl = document.getElementById('sheetUrl').value;
    if (__sheetUrl && __sheetUrl.startsWith('https://docs.google.com/spreadsheets/d/')) {
        localStorage.setItem('sheetUrl', __sheetUrl);
        alert('T√°bl√°zat URL elmentve!');
        loadSheetUrl();
    } else {
        alert('√ârv√©nytelen Google T√°bl√°zat URL!');
    }
}

function loadSheetUrl() {
    __sheetUrl = localStorage.getItem('sheetUrl');
    const urlContainer = document.getElementById('sheetUrlContainer');
    const statusContainer = document.getElementById('bankrollStatus');
    if (__sheetUrl) {
        urlContainer.style.display = 'none';
        statusContainer.style.display = 'block';
        updateBankrollStatus();
        loadHistory(); 
    } else {
        urlContainer.style.display = 'block';
        statusContainer.style.display = 'none';
    }
}

async function updateBankrollStatus() {
    if (!__sheetUrl) return;
    const statusEl = document.getElementById('bankrollStatus');
    statusEl.innerHTML = `<p class="muted">Bankroll √°llapot√°nak lek√©r√©se...</p>`;
    try {
        const response = await fetch(`${__gasUrl}?action=getBankroll&sheetUrl=${encodeURIComponent(__sheetUrl)}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        statusEl.innerHTML = `<p><strong>Aktu√°lis Bankroll:</strong> ${data.bankroll.toFixed(2)} e.</p><p><strong>Profit/Vesztes√©g:</strong> <span style="color:${data.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${data.pnl.toFixed(2)} e.</span></p><p><strong>ROI:</strong> <span style="font-weight:bold;">${data.roi.toFixed(1)}%</span></p>`;
    } catch(e) {
        statusEl.innerHTML = `<p class="muted" style="color:var(--danger);">Hiba: ${e.message}</p>`;
    }
}

async function logBet(betData) {
    if (!__sheetUrl) { alert('K√©rlek, add meg a Google T√°bl√°zat URL-j√©t a napl√≥z√°shoz!'); return; }
    const button = event.target;
    button.disabled = true;
    button.textContent = 'Napl√≥z√°s...';
    try {
        await fetch(`${__gasUrl}`, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'logBet', sheetUrl: __sheetUrl, bet: betData })
        });
        button.textContent = 'Sikeresen Napl√≥zva ‚úÖ';
        setTimeout(updateBankrollStatus, 1000);
    } catch (e) {
        alert(`Hiba a napl√≥z√°s sor√°n: ${e.message}.`);
        button.textContent = 'Napl√≥z√°s Sikertelen';
    }
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m])}
function setProgress(pct,msg=null){const el=document.getElementById('progress');const statusEl=document.getElementById('status');const v=Math.max(0,Math.min(100,Math.round(pct||0)));el.style.display=v>0&&v<100?'grid':'none';if(v>0&&v<100){el.style.animation='pulse 2s infinite'}else{el.style.animation='none'}el.style.background=`conic-gradient(var(--primary) ${v*3.6}deg, rgba(255,255,255,.18) 0deg)`;el.querySelector('.progress-label').textContent=v+'%';if(msg)statusEl.textContent=msg}
function handleSportChange(){
    __currentSport=document.getElementById('sportSelector').value;
    const timeInput = document.getElementById('liveTimeRemainingMinutes');
    if (__currentSport === 'soccer') timeInput.value = 90;
    else if (__currentSport === 'hockey') timeInput.value = 60;
    else if (__currentSport === 'basketball') timeInput.value = 48;
    ['leagueCount','matchCount'].forEach(id=>document.getElementById(id).style.display='none'); __fixtures = [];
}
async function loadFixtures(){
    const statusEl=document.getElementById('fxStatus');
    const loadBtn=document.getElementById('loadFixturesBtn');
    statusEl.textContent='Adatok lek√©r√©se...';
    statusEl.classList.add('loading');
    loadBtn.disabled=true;
    ['leagueCount','matchCount'].forEach(id=>document.getElementById(id).style.display='none');
    try{
        const response=await fetch(`${__gasUrl}?action=getFixtures&sport=${__currentSport}&days=2`);
        if(!response.ok)throw new Error(`H√°l√≥zati hiba: ${response.status}`);
        const data=await response.json();
        if(data.error)throw new Error(data.error);
        __fixtures=data.fixtures||[];
        sessionStorage.setItem('openingOdds', JSON.stringify(data.odds || {}));
        const leagues=[...new Set(__fixtures.map(f=>f.league))];
        const leagueCountEl = document.getElementById('leagueCount');
        const matchCountEl = document.getElementById('matchCount');
        leagueCountEl.textContent = leagues.length;
        matchCountEl.textContent = __fixtures.length;
        if (leagues.length > 0) leagueCountEl.style.display = 'inline-block';
        if (__fixtures.length > 0) matchCountEl.style.display = 'inline-block';
        statusEl.textContent=``;
    }catch(e){
        statusEl.textContent=`Hiba: ${e.message}`;
    }finally{
        statusEl.classList.remove('loading');
        loadBtn.disabled=false;
    }
}
function fillAndAnalyze(home,away){
    document.getElementById('home').value=home;
    document.getElementById('away').value=away;
    closeListModal();
    document.querySelector('.col-center').scrollIntoView({behavior:'smooth'});
    runAnalysis(true);
}

async function runAnalysis(forceNew = false) {
    const home = document.getElementById("home").value.trim();
    const away = document.getElementById("away").value.trim();
    const homeFormWeight = document.getElementById("homeFormWeight").value;
    const awayFormWeight = document.getElementById("awayFormWeight").value;
    const liveHomeScore = document.getElementById("liveHomeScore").value;
    const liveAwayScore = document.getElementById("liveAwayScore").value;
    const liveTimeRemainingMinutes = document.getElementById("liveTimeRemainingMinutes").value;

    if (!home || !away || !__gasUrl) { setProgress(0, "Hiba: Hi√°nyz√≥ adatok."); return; }

    const openingOdds = sessionStorage.getItem('openingOdds') || '{}';
    
    let progressInterval;
    try {
        setProgress(1, "Elemz√©s ind√≠t√°sa...");
        let analysisUrl = `${__gasUrl}?action=runAnalysis&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&sport=${__currentSport}&force=true&homeFormWeight=${homeFormWeight}&awayFormWeight=${awayFormWeight}&liveHome=${liveHomeScore}&liveAway=${liveAwayScore}&liveTimeMinutes=${liveTimeRemainingMinutes}&sheetUrl=${encodeURIComponent(__sheetUrl)}`;

        progressInterval = setInterval(() => {
            const c = parseInt(document.querySelector('#progress .progress-label').textContent) || 0;
            setProgress(Math.min(90, c + 3), "Adatok gy≈±jt√©se a Piacr√≥l √©s az AI-t√≥l...")
        }, 800);
        
        const postResponse = await fetch(`${analysisUrl}`, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ openingOdds: JSON.parse(openingOdds) })
        });

        await new Promise(resolve => setTimeout(resolve, 9000));
        
        const resultResponse = await fetch(`${analysisUrl}&force=false`);
        clearInterval(progressInterval);
        
        if (!resultResponse.ok) throw new Error(`Szerver v√°lasz hiba: ${resultResponse.status}`);
        
        setProgress(95, "V√°lasz feldolgoz√°sa...");
        const data = await resultResponse.json();
        if (data.error) throw new Error(data.error);

        openAnalysisModal(home, away, data.html);
        if(__sheetUrl) loadHistory();
        setProgress(100, "K√©sz.");
    } catch (e) {
        if (progressInterval) clearInterval(progressInterval);
        setProgress(0, "Hiba: " + e.message);
    }
}

async function loadHistory() {
    if (!__sheetUrl) {
        document.getElementById('history').innerHTML = '<p class="muted">A napl√≥ megtekint√©s√©hez add meg a Google T√°bl√°zat URL-j√©t.</p>';
        return;
    }
    document.getElementById('history').innerHTML = '<p class="muted">Napl√≥ bet√∂lt√©se...</p>';
    try {
        const response = await fetch(`${__gasUrl}?action=getHistory&sheetUrl=${encodeURIComponent(__sheetUrl)}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        renderHistory(data.history);
    } catch(e) {
        document.getElementById('history').innerHTML = `<p class="muted" style="color:var(--danger)">Hiba a napl√≥ bet√∂lt√©sekor: ${e.message}</p>`;
    }
}

function filterHistory(allHistory) {
    const query = document.getElementById('historySearch').value.toLowerCase();
    const filtered = allHistory.filter(item =>
        (item.sport === __historySportFilter) &&
        (item.home.toLowerCase().includes(query) || item.away.toLowerCase().includes(query))
    );
    renderHistory(filtered, true);
}

function renderHistory(history, isFiltering = false) {
    const box = document.getElementById('history');

    if (!isFiltering) {
        sessionStorage.setItem('fullHistory', JSON.stringify(history));
    }
    
    if (!history || history.length === 0) {
        box.innerHTML = '<p class="muted">Nincsenek el≈ëzm√©nyek.</p>';
        return;
    }

    const groupedByDate = history.reduce((acc, item) => {
        const dateKey = new Date(item.date).toISOString().split('T')[0];
        if (!acc[dateKey]) acc[dateKey] = [];
        acc[dateKey].push(item);
        return acc;
    }, {});

    let finalHtml = '';
    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));

    for (const date of sortedDates) {
        finalHtml += `<details class="history-date-group" open>`;
        finalHtml += `<summary class="history-date-summary">${new Date(date).toLocaleDateString('hu-HU', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</summary>`;
        
        groupedByDate[date].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
            finalHtml += `
                <div class="fx-item">
                    <div class="fx-item-details" onclick="loadAnalysisFromHistory('${item.id}')" style="cursor:pointer;flex-grow:1">
                        <div>
                            <div class="fx-title">${escapeHtml(item.home)} ‚Äì ${escapeHtml(item.away)}</div>
                            <div class="fx-meta">${new Date(item.date).toLocaleString('hu-HU')}</div>
                        </div>
                    </div>
                    <div class="fx-actions" style="display:flex;gap:5px">
                        <button class="btn-primary btn-sm" onclick="loadAnalysisFromHistory('${item.id}')" title="Elemz√©s Megtekint√©se">üëÅÔ∏è</button>
                        <button class="btn-danger btn-sm" onclick="deleteHistoryItem('${item.id}')" title="T√∂rl√©s">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        });
        finalHtml += `</details>`;
    }
    box.innerHTML = `<input id="historySearch" placeholder="Keres√©s a napl√≥ban..." oninput="filterHistory(JSON.parse(sessionStorage.getItem('fullHistory') || '[]'))" style="margin-bottom:0.8rem"/>
                     <div class="sport-filter-container">
                       <button class="sport-filter-btn ${__historySportFilter === 'soccer' ? 'active' : ''}" onclick="filterHistoryBySport('soccer', this)" title="Labdar√∫g√°s">‚öΩ</button>
                       <button class="sport-filter-btn ${__historySportFilter === 'hockey' ? 'active' : ''}" onclick="filterHistoryBySport('hockey', this)" title="J√©gkorong">üèí</button>
                       <button class="sport-filter-btn ${__historySportFilter === 'basketball' ? 'active' : ''}" onclick="filterHistoryBySport('basketball', this)" title="Kos√°rlabda">üèÄ</button>
                     </div>` + finalHtml;
}

async function loadAnalysisFromHistory(id){
    if (!__sheetUrl) return;
    try {
        const response = await fetch(`${__gasUrl}?action=getAnalysisDetail&sheetUrl=${encodeURIComponent(__sheetUrl)}&id=${id}`);
        const data = await response.json();
        if (data.error) throw new Error(data.error);
        openAnalysisModal(data.record.home, data.record.away, data.record.html);
    } catch(e) {
        alert(`Hiba az elemz√©s bet√∂lt√©sekor: ${e.message}`);
    }
}

async function deleteHistoryItem(id){
    if (!__sheetUrl || !confirm("Biztosan t√∂r√∂lni szeretn√©d ezt az elemet a k√∂zponti napl√≥b√≥l?")) return;
    try {
        await fetch(`${__gasUrl}`, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'deleteHistoryItem', sheetUrl: __sheetUrl, id: id })
        });
        alert('Elem sikeresen t√∂r√∂lve.');
        loadHistory();
    } catch(e) {
        alert(`Hiba a t√∂rl√©s sor√°n: ${e.message}`);
    }
}

function openAnalysisModal(home,away,htmlContent){document.getElementById('modalTitle').textContent=`${home} vs ${away}`;document.getElementById('modalBody').innerHTML=htmlContent;document.getElementById('analysisModal').style.display='flex'}
function closeAnalysisModal(){document.getElementById('analysisModal').style.display='none'}
function openListModal(title, content) { document.getElementById('listModalTitle').textContent = title; document.getElementById('listModalBody').innerHTML = content; document.getElementById('listModal').style.display = 'flex'; }
function closeListModal(){document.getElementById('listModal').style.display='none'}
function showLeaguesInModal() { if (__fixtures.length === 0) { alert("El≈ësz√∂r t√∂ltsd be a meccseket!"); return; } const leagues = [...new Set(__fixtures.map(f => f.league))]; let content = '<div class="modal-list-grid">'; content += `<div class="league-card" onclick="showMatchesInModal('all')"><h3>√ñsszes Bajnoks√°g</h3></div>`; content += leagues.map(l => `<div class="league-card" onclick="showMatchesInModal('${escapeHtml(l)}')"><h3>${escapeHtml(l)}</h3></div>`).join(''); content += '</div>'; openListModal("Bajnoks√°gok", content); }
function showMatchesInModal(league = 'all') { if (__fixtures.length === 0) { alert("El≈ësz√∂r t√∂ltsd be a meccseket!"); return; } const filteredFixtures = league === 'all' ? __fixtures : __fixtures.filter(f => f.league === league); if (filteredFixtures.length === 0) { openListModal(league, `<p class="muted" style="text-align:center;">Nincs megjelen√≠thet≈ë m√©rk≈ëz√©s ebben a kateg√≥ri√°ban.</p>`); return; } let content = '<div class="modal-list-grid">'; content += filteredFixtures.map(fx => { const d = new Date(fx.utcKickoff).toLocaleString('hu-HU', { dateStyle: 'short', timeStyle: 'short' }); return ` <div class="fixture-card"> <div> <div class="fx-title">${escapeHtml(fx.home)} ‚Äì ${escapeHtml(fx.away)}</div> <div class="fx-meta">${escapeHtml(fx.league)}<br>${d}</div> </div> <button class="btn-primary btn-sm" onclick="fillAndAnalyze('${escapeHtml(fx.home)}','${escapeHtml(fx.away)}')">Elemz√©s</button> </div> `; }).join(''); content += '</div>'; const title = league === 'all' ? "√ñsszes M√©rk≈ëz√©s" : league; openListModal(title, content); }
</script>
</body>
</html>
